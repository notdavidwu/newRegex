<!DOCTYPE html>
<html lang="en">
{% load static%}
<html lang="zh-Hant" >

<head>
<title>{% block title %}{% endblock %}</title>

    <!-- CSS only -->
    <link rel="stylesheet" href="{% static 'css_js/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/font-awesome.min.css' %}">


    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap.css' %}">

    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.rtl.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.rtl.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.rtl.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.rtl.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.rtl.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.rtl.min.css' %}">

    <!-- JS, Popper.js, and jQuery -->
    <script src="{% static 'css_js/jquery-3.5.1.slim.min.js' %}"></script>
    <script src="{% static 'css_js/popper.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.bundle.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'css_js/key_forbidden.js' %}"></script>
</head>
<style>
    body{background:url("{% static 'image/texture.png' %}")}
    #user_menu{position: absolute;top: 55px;height: calc(100% - 55px);width: 10%;left: 0px;overflow-x: hidden}
    #authSetting{position: absolute;top: 55px;height: 30%;width: 45%;left: 10%;overflow-y: auto;background:url("{% static 'image/texture.png' %}");background-color: #F7F4EF;}
    #authApp{position: absolute;top: calc(30% + 55px);height: 30%;width: 45%;left: 10%;overflow-y: auto;background:url("{% static 'image/texture.png' %}");background-color: #F7F4EF}
    #authDisease{position: absolute;top: calc(60% + 55px);height: calc(40% - 55px);width: 45%;overflow-y: auto;left: 10%;background:url("{% static 'image/texture.png' %}");background-color: #F7F4EF}
    #user_menu{background:url("{% static 'image/texture.png' %}");background-color: #3E383F;overflow-y: auto;padding: 0px}
    #user_menu table{padding: 0px;margin: 0px;color:white;width: 100%;text-align: center;font-size: 16pt}
    
    #export{position: absolute;top: 55px;height: calc(100% - 55px);width: 45%;left: 55%;background:url("{% static 'image/texture.png' %}");background-color: #F7F4EF;}
    tr{border-bottom-style:dashed;border-bottom: #0d0d0d}
    input[name='user']{display: none}
    input[name='user'] +label{width: 100%;height: 40px;padding-top: 5px;margin: 0;color:#FFFFFF;background-color: #56484A}
    input[name='user']:checked ~label{background-color: #8CA9D3;}
    label:hover{background-color: #fff3cd;border-radius: 5px}
    h2{width: 100%;background:url("{% static 'image/texture.png' %}");background-color: #E6E3DE;text-align: center;border: 1px solid #D5D2CD}
    label{font-size: 16pt}
    .arrow {
        
        border: solid black;
        border-width: 0px 3px 3px 0;
        display: inline-block;
        padding: 3px;
      }
      
    .right {
        transform: rotate(-45deg);
      }
    #position{position:absolute;left:calc(52% + 10px);top:55px}
    #export_subject{width:30%;position:absolute;left:10px;height:50px}
    #export_selection{width:20%;position:absolute;left:calc(30% + 20px);height:50px}
    #import_selection{width:20%;position:absolute;left:calc(54% + 20px);height:50px}
    #export_button{position:absolute;left:calc(78% );padding:0px;padding-left:10px;padding-right:10px;padding-top:3px;padding-bottom:3px;height:50px}
    #undo_button{position:absolute;left:calc(88%);padding:0px;padding-left:10px;padding-right:10px;padding-top:3px;padding-bottom:3px;height:50px}
</style>
<script type="text/javascript" src="{% static 'css_js/jquery-3.6.0.min.js' %}"></script>
<script>
$(document).ready(function (e) {
    $.ajax({
        type: 'post',
        url: '{% url "administrator:get_users" %}', // this is the mapping between the url and view
        data:{
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            for(i=0;i<response.username.length;i++){
                $('#user_menu').children('table').append('' +
                    '<tr><td>' +
                        '<input type="radio" onclick="auth()" name="user" id="user'+i+'">' +
                        '<label for="user'+i+'">'+
                            response.username[i]+
                        '</label>' +
                    '</td></tr>')
            }
        }
    })
})
function auth(){
    var username=$(event.target).next('label').html()
    $.ajax({
        type: 'post',
        url: '{% url "administrator:get_user_setting" %}', // this is the mapping between the url and view
        data:{
            'username':username,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            $('#authSetting').empty()
            $('#authSetting').append('<h2>帳號管理設定</h2>')
            $('#authSetting').append('<div class="form-check form-switch"><input class="form-check-input" ' +
                'onchange="update_userSetting()" value="1" type="checkbox" name="update_userSetting" id="userSetting">' +
                '<label class="form-check-label" for="userSetting">是否啟用</label></div>')
            $('#authSetting').append('<div class="form-check form-switch"><input class="form-check-input" ' +
                    'onchange="update_de_identificationSetting()" value="1" type="checkbox" name="update_de_identificationSetting" id="de_identificationSetting">' +
                    '<label class="form-check-label" for="de_identificationSetting">是否去識別化</label></div>')
            $('#authSetting').append('<div class="form-check form-switch"><input class="form-check-input" ' +
                'onchange="update_all_annotations()" value="1" type="checkbox" name="update_all_annotations" id="all_annotations">' +
                '<label class="form-check-label" for="all_annotations">啟用看到所有影像標註功能</label></div>')
            if(response.active==true){
                $('#userSetting').prop('checked',true)
            }
            if(response.de_identification==true){
                $('#de_identificationSetting').prop('checked',true)
            }
            if(response.all_annotations==true){
                $('#all_annotations').prop('checked',true)
            }
        }
    })
    $.ajax({
        type: 'post',
        url: '{% url "administrator:get_auth_app" %}', // this is the mapping between the url and view
        data:{
            'username':username,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            $('#authApp').empty()
            $('#authApp').append('<h2>權限管理設定</h2>')
            
            $('#authApp').append(response.object_array)

        }
    })
    $.ajax({
        type: 'post',
        url: '{% url "administrator:get_disease" %}', // this is the mapping between the url and view
        data:{
            'username':username,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            $('#authDisease').empty()
            $('#authDisease').append('<h2>疾病管理設定</h2>')
            disease = response.diseaseNo

            num = response.disease.length
            for(var i =0;i<num;i++){
                $('#authDisease').append('<div class="form-check form-switch"><input class="form-check-input" onchange="update_authDisease()" value="'+response.diseaseNo[i]+'" type="checkbox" name="auth_disease" id="auth_disease_'+i+'"><label class="form-check-label" for="auth_disease_'+i+'">'+response.disease[i]+'</label></div>')
            }
        },
        complete:function (){
            $.ajax({
                type: 'post',
                url: '{% url "administrator:get_auth_disease" %}', // this is the mapping between the url and view
                data:{
                    'username':username,
                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                },
                success:function (response){
                    $('#export_subject').empty()
                    for (var i=0;i<response.auth_disease.length;i++){
                        $('#export_subject').append('<option value="'+response.auth_disease[i]+'">'+response.auth_diseaseName[i]+'</option>')
                    }
                    for (var j=0;j<num;j++){
                        if(response.auth_disease.includes(disease[j])){
                            $('#auth_disease_'+j).prop('checked',true)
                        }
                    }
                }
            })
        }
    })
    $('#import_selection').empty()
    $('#import_selection').append('<option>'+username+'</option>')
    getAuthDiseaseLabeledUser()
}
function update_userSetting(){
    var username = ($('input[name="user"]:checked').next('label').html())
    $.ajax({
        type: 'post',
        url: '{% url "administrator:update_user_setting" %}', // this is the mapping between the url and view
        data:{
            'username':username,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        }
    })
}

function update_all_annotations(){
    var username = ($('input[name="user"]:checked').next('label').html())
    $.ajax({
        type: 'post',
        url: '{% url "administrator:update_all_annotations" %}', // this is the mapping between the url and view
        data:{
            'username':username,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        }
    })
}

function update_de_identificationSetting(){
    var username = ($('input[name="user"]:checked').next('label').html())
    $.ajax({
        type: 'post',
        url: '{% url "administrator:update_de_identificationSetting" %}', // this is the mapping between the url and view
        data:{
            'username':username,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        }
    })
}
function update_authApp(){
    var username = ($('input[name="user"]:checked').next('label').html())
    var authapp = $(event.target).val()
    $.ajax({
        type: 'post',
        url: '{% url "administrator:upadte_auth_app" %}', // this is the mapping between the url and view
        data:{
            'username':username,
            'authapp':authapp,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        }
    })
}
function update_authDisease(){
    var username = ($('input[name="user"]:checked').next('label').html())
    var authdisease = $(event.target).val()
    
    $.ajax({
        type: 'post',
        url: '{% url "administrator:upadte_auth_disease" %}', // this is the mapping between the url and view
        data:{
            'username':username,
            'authdisease':authdisease,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function(){
            $.ajax({
                type: 'post',
                url: '{% url "administrator:get_auth_disease" %}', // this is the mapping between the url and view
                data:{
                    'username':username,
                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                },
                success:function (response){
                    $('#export_subject').empty()
                    for (var i=0;i<response.auth_disease.length;i++){
                        $('#export_subject').append('<option value="'+response.auth_disease[i]+'">'+response.auth_diseaseName[i]+'</option>')
                    }
                }
            })
        }
    })
}
function getAuthDiseaseLabeledUser(){
    var disease = $('#export_subject option:selected').val()
    var username = ($('input[name="user"]:checked').next('label').html())
    $.ajax({
        type: 'post',
        url: '{% url "administrator:getAuthDiseaseLabeledUser" %}', // this is the mapping between the url and view
        data:{
            'disease':disease,
            'username':username,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            $('#export_selection').empty()
            for (var i=0;i<response.LabeledUser.length;i++){
                $('#export_selection').append('<option value="'+response.LabeledUser[i]+'">'+response.LabeledUser[i]+'</option>')
            }
            comfirm()
        }
    })
}
function comfirm(){
    var disease = $('#export_subject option:selected').val()
    var export_selection =  $('#export_selection option:selected').val()
    var import_selection =  $('#import_selection option:selected').val()
    if(export_selection==null){
        $('#export_button').attr('data-bs-target',"")
        $('#undo_button').attr('data-bs-target',"")
    }else{
        $('#export_button').attr('data-bs-target',"#exampleModal")
        $('#undo_button').attr('data-bs-target',"#undoModal")
    }
    $('#InsertMessage').html('確定將 【'+export_selection+'】 資料匯出至 【'+import_selection+'】 ?')
    $('#RemoveMessage').html('確定將 【'+export_selection+'】 匯出至 【'+import_selection+'】的資料移除 ?')
}
function insertLocation(){
    var disease = $('#export_subject option:selected').val()
    var export_user =  $('#export_selection option:selected').val()
    var import_user =  $('#import_selection option:selected').val()
    $.ajax({
        type: 'post',
        url: '{% url "administrator:insertAuthDiseaseLabeledUser" %}', // this is the mapping between the url and view
        data:{
            'disease':disease,
            'export_user':export_user,
            'import_user':import_user,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        }
    })
}
function removeLocation(){
    var disease = $('#export_subject option:selected').val()
    var export_user =  $('#export_selection option:selected').val()
    var import_user =  $('#import_selection option:selected').val()

    $.ajax({
        type: 'post',
        url: '{% url "administrator:removeAuthDiseaseLabeledUser" %}', // this is the mapping between the url and view
        data:{
            'disease':disease,
            'export_user':export_user,
            'import_user':import_user,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        }
    })
}
</script>
<body>
    {% include 'navBar.html' %}

<div id="user_menu">
<table></table>
</div>
<div id="authSetting"><h2>帳號管理設定</h2></div>
<div id="authApp"><h2>權限管理設定</h2></div>
<div id="authDisease"><h2>疾病管理設定</h2></div>
<div id="export">
    <h2>匯出設定</h2>
    <select id='export_subject' class="form-select form-select-sm" aria-label=".form-select-sm example" onchange="getAuthDiseaseLabeledUser()"></select>
    <select onchange="comfirm()" id='export_selection' class="form-select form-select-sm" aria-label=".form-select-sm example"></select>  
    <div id="position"><i class="arrow right"></i><i class="arrow right"></i></div>
    <select id='import_selection' class="form-select form-select-sm" aria-label=".form-select-sm example" disabled></select>  
    <button id="export_button" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="">export</button>
    <button id="undo_button" type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="">undo</button>
</div>

<div class="modal fade" id="exampleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="InsertMessage" class="modal-body">
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="insertLocation()">export</button>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="undoModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">確認</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div id="RemoveMessage" class="modal-body">
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="removeLocation()">undo</button>
        </div>
      </div>
    </div>
  </div>

</body>
</html>