

{% load static%}
{% block content %}
<!DOCTYPE html>
<html lang="zh-Hant" >
<head>
    <meta name="viewport" maximum-scale=1.0, user-scalable=0 content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">

    <!-- CSS only -->
    <link rel="stylesheet" href="{% static 'css_js/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/font-awesome.min.css' %}">


    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap.css' %}">

    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.rtl.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.rtl.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.rtl.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.rtl.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.rtl.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.rtl.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/loaders.css-master/loaders.css' %}">
    
    
    <!-- JS, Popper.js, and jQuery -->

    <script src="{% static 'css_js/jquery-3.5.1.slim.min.js' %}"></script>
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-select-1.13.14/dist/js/bootstrap-select.js' %}">
    <script src="{% static 'css_js/popper.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.bundle.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.min.js' %}"></script>
    <script src="{% static 'css_js/key_forbidden.js' %}"></script>
    <script src="{% static 'css_js/loaders.css-master/loaders.css.js' %}"></script>
    <script type="text/javascript" src="{% static 'css_js/jquery-3.6.0.min.js' %}"></script>
    
    

    <title>DICOM</title>
    </head>

<style>
    html { overflow: hidden; }
        /* width */
    ::-webkit-scrollbar {
      width: 10px;
    }
    
    /* Track */
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: #888;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    body{
        overflow-y: hidden;
        background:url("{% static 'image/texture.png' %}");
        background-color: #33333a;
    }
    .main{float: left}
    /* Scroll 1 */
    .demoScroll {
        height: 300px;
        overflow: auto;
        width: 100%;
    }
    .s1{
        position:relative ;
    }
    /* Scroll 1 */
    .sc1::-webkit-scrollbar {
      width: 12px;
      height: 8px;
    }
    .sc1::-webkit-scrollbar-track {
      background-color: rgba(0, 0, 0, 0.5);

    }
    .sc1::-webkit-scrollbar-thumb {
      background-color: #EFEFEF;
      border-radius: 10px;
    }

    /* Scroll 2 */
    .sc2::-webkit-scrollbar {
      width: 8px;
      height: 10px;
    }
    .sc2::-webkit-scrollbar-track {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 0px;
    }
    .sc2::-webkit-scrollbar-thumb {
      background-color: #11171a;
      border-radius: 2px 2px 2px 2px;
    }

    /* Scroll 3 */
    .sc3::-webkit-scrollbar {
      width: 2px;
      height: 2px;
    }
    .sc3::-webkit-scrollbar-track {
      background-color: transparent;
      border-radius: 5px;
    }
    .sc3::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
    }

    /* Scroll 4 */
    .sc4::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    .sc4::-webkit-scrollbar-track {
      border-radius: 10px;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .sc4::-webkit-scrollbar-thumb {
      background-color: #e78632;
      background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,.3) 20%,transparent 20%,transparent 40%,rgba(255, 255, 255, 0.3) 40%,rgba(255,255,255,.3) 60%,transparent 60%,transparent 80%,rgba(255, 255, 255, 0.3) 80%);
      border-radius: 10px;
    }

    /* Scroll 5 */
    .sc5::-webkit-scrollbar {
      width: 15px;
      height: 15px;
    }
    .sc5::-webkit-scrollbar-track {
      border-radius: 10px;
      background-color: rgba(255, 255, 255, 0.1);
    }
    .sc5::-webkit-scrollbar-thumb {
      background-image: linear-gradient(45deg, #00aeff, #a68eff);
      border-radius: 10px;
        -webkit-box-shadow: rgba(0,0,0,.12) 0 3px 13px 1px;
    }


    /* Scroll 6 */
    .sc6::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    .sc6::-webkit-scrollbar-track {
      border-radius: 10px;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .sc6::-webkit-scrollbar-thumb {
      background-color: #aab74d;
      background-image:-webkit-linear-gradient(rgba(255,255,255,.3) 20%,transparent 20%,transparent 40%,rgba(255, 255, 255, 0.3) 40%,rgba(255,255,255,.3) 60%,transparent 60%,transparent 80%,rgba(255, 255, 255, 0.3) 80%);
      border-radius: 10px;
    }
    .slider{position: absolute;right: 5px;}
    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #8e8fef; --border-radius: 10px; --formwidth: 350px; --form-mob-width: 500px; }
    #mycheckbox { position: absolute; left: -9999px; }
    .feedback-label,.form { position: fixed; top: 50%; right: 0; }
    .feedback-label { transform-origin: top right; transform: rotate(-90deg) translate(50%, -100%); z-index: 10; }
    .form {background:url("{% static 'image/texture.png' %}");border:solid 2px #44444a; width: var(--formwidth); max-height: 85vh;margin-top: 2%; transform: translate(100%, -50%); padding: 0px; overflow: auto; background-color: var(--form); z-index: 1; border-radius:10px}
    .feedback-label { border-radius: var(--border-radius); }
    .feedback-label { padding: 5px 10px; border-radius: var(--border-radius) var(--border-radius) 0 0; }
    .feedback-label { background: brown; color: white; }
    .feedback-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #mycheckbox:checked + .feedback-label { background: #e78632; transform: rotate(-90deg) translate(50%, calc((var(--formwidth) + 100%) * -1))}
    #mycheckbox:checked ~ .form { transform: translate(0, -50%);z-index: 10;}
    .feedback-label, .form { transition: all 0.35s ease-in-out; }
    .form{-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}

    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #8e8fef; --border-radius: 10px; --imagewidth: 600px; --form-mob-width: 420px; }
    #Imagecheckbox { position: absolute; left: -9999px; }
    .Image-label{ position: fixed; top: 160px; left: 0px;}
    .Imageform { position: fixed; top: 50%; left: 0px;}
    .Image-label { transform-origin: top right; transform: rotate(90deg) translate(100%, 110%); z-index: 10; }
    .Imageform {z-index: 11;background:url("{% static 'image/texture.png' %}");border:solid 2px #44444a; width: var(--imagewidth); height: calc(100% - 55px);margin-top: 30px; transform: translate(-100%, -50%); padding: 0px; overflow: auto; background-color: #6699A1;  border-radius:10px}
    .Image-label { border-radius: var(--border-radius); }
    .Image-label { padding: 5px 10px; border-radius: var(--border-radius) var(--border-radius) 0 0; }
    .Image-label { background: brown; color: white; }
    .Image-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #Imagecheckbox:checked + .Image-label { background: #e78632; transform: rotate(90deg) translate(100%, calc((var(--imagewidth) - 110%) * -1))}
    #Imagecheckbox:checked ~ .Imageform { transform: translate(0%, -50%);}
    .Image-label, .Imageform { transition: all 0.35s ease-in-out; }
    .Imageform{overflow-x: hidden;-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #ImageReport{margin-top: 5px;margin-left: 5px;width: calc(100% - 10px)}
    .container{background:url("{% static 'image/texture.png' %}");padding: 5px;margin-bottom: 5px;background-color: whitesmoke;border-radius: 5px;box-shadow: 2px 2px 2px 1px rgba(0, 0, 0, 0.2)}
    .row{padding-top: 10px;height: 30px}
    .col{font-weight: bold;text-align: center}
    
    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #eeefef; --border-radius: 10px; --width: 400px; --form-height: 400px; --form-mob-height: 100px; }
    #Topcheckbox { position: absolute; left: -9999px; }
    .tool{float: left;overflow-x: auto}
    .Top-label { position: fixed; top: 65px; left: 0px; height: 37px;}
    .Topform { position: fixed; top: 55px; left: 0px;height: 100% ;}
    .Top-label { transform-origin: top right; transform: rotate(90deg) translate(100%, 51px); z-index: 10; }
    .Topform {z-index: 11;background:url("{% static 'image/texture.png' %}");border:solid 2px #44444a; width: var(--width); height: calc(100% - 55px); transform: translate(-100%, 0%); padding: 0px; overflow: auto; background-color: #6699A1;  border-radius:10px}
    .Top-label { padding: 5px 10px; border-radius:10px 10px 0px 0px ; }
    .Top-label { background: brown; color: white;}
    .Top-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #Topcheckbox:checked + .Top-label { background: #e78632; transform: rotate(90deg) translate(100%, calc((var(--width) - 51px) * -1))}
    #Topcheckbox:checked ~ .Topform { transform: translate(0%, 0%);}
    .Top-label, .Topform { transition: all 0.35s linear; }
    .form-check-label{ -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #CT-PET{
        background:url("{% static 'image/texture.png' %}");
        width: 70%;
        float: left;
        display: flex;
        height: 876px;
        flex-wrap:wrap;
        text-align: center;
        padding-top:0px;
    }

    #text{
        width: 20%;
        height: 100%;
        padding-top:50px;
        background-color: white;
        position: fixed;
        right: 0px;
        margin: 0;
    }

    #frame1{
        overflow: hidden;
        height: 100%;
        width: 100%;
        padding: 0px;
        margin:0px;
        position: relative;
        top: 0%;
        display: flex;
        justify-content: center;
    }

    #frame2{
        overflow: hidden;
        height: 100%;
        width: 100%;
        padding: 0px;
        margin:0px;
        position: relative;
        top: 0%;
        display: none;

    }
    #frame3{
        overflow: hidden;
        height: 100%;
        width: 100%;
        padding: 0px;
        margin:0px;
        position: relative;
        top: 0%;
        display: none;
    }
    #frame4{
        overflow: hidden;
        height: 100%;
        width: 100%;
        padding: 0px;
        margin:0px;
        position: relative;
        top: 0%;
        display: none;
    }
    .img{
        width: 100%;
        height: 100%;

    }
    .main{
        float: left;
        -o-user-select:none;
        user-select:none;
    }


    :root {
      --radius: 2px;
      --baseFg: dimgray;
      --baseBg: white;
      --accentFg: #006fc2;
      --accentBg: #bae1ff;
    }

    .theme-pink {
      --radius: 2em;
      --baseFg: #c70062;
      --baseBg: #ffe3f1;
      --accentFg: #c70062;
      --accentBg: #ffaad4;
    }

    .theme-construction {
      --radius: 0;
      --baseFg: white;
      --baseBg: black;
      --accentFg: black;
      --accentBg: orange;
    }


    p{
        color:white;
        display: none;
        font-family: 'Tahoma';
    }
    .x{display: none;}
    .y{display: none;}
    .z{display: none;}
    .SUV{display: none;}
    input[type="radio"]{display: none}


    
    .data{display: inline;color: #11171a}


    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #eeefef; --border-radius: 10px; --form-width: 300px; --form-mob-width: 320px; }
    #localizationslideout{position: fixed;width: 10%;left: 1154px;z-index: 5}
    .localizationform { position: fixed; height: calc(100% - 90px); top: 90px;  right: 20%}
    
    .localizationform {background:url("{% static 'image/texture.png' %}");width: 9.9%;  padding-top: 10px;  overflow-x: hidden ; background-color: var(--form); z-index: 1; border-radius:0px}
    #textarea{width:100%}
    #textarea td{height:0px}
    input[name="location"]{display: none;}
    input[name="location"]~label{background:url("{% static 'image/texture.png' %}");height:100%;padding: 0;margin: 0;margin-left: 4px;margin-bottom: 4px;width: calc(100% - 8px);background-color: #BBBBBB;border-radius: 10px;padding-top: 5px;padding-bottom: 5px}
    input[name="location"]:checked ~label{background-color: #e78632}
    .data{font-size:12pt;line-height: 15px;display: block;color: #11171a;width: 100%;margin: 0;margin-bottom: 5px;text-align: center}
    .data1{font-size:10pt;line-height: 12px;display: block;color: #11171a;width: 100%;margin: 0;text-align: center;word-break:break-all;word-wrap:break-word}
    #Disease{z-index: 2;position: fixed; height: 40px; top: 55px; width: 9.9%; margin: 0px; right: 20%;border-radius: 0px 0px 5px 5px;}
    #tumor{height: 150px;display: none;position: fixed;z-index: 10;background-color:#CCCCCC ;width: 400px;padding: 5px;border-radius:10px; -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #LabelRecord{border-radius:5px;margin-bottom: 5px ;width: 100%}
    #tumor_comfirm{color:#FFFFFF;width: 100%;height:30px;line-height:15px}
    #tumor select{margin-bottom: 5px;}
    #SUV_Localmax{border-collapse: collapse;  overflow: hidden;border-radius:5px; background-color: #FFFFFF;width: 106px;text-align: center}
    .Localmax_SUV{display: inline;color: #11171a;width: 106px}
    input[name="localmax"] + label{width: 106px}
    input[name="localmax"]:checked ~label{background-color: #e78632}
    #SUV_Localmax + td{margin: 0}
    #textarea{-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    img{-o-user-select:none; user-select:none;}
   
    #textReport td{text-align: right;width: 100%}
    .examItem{display: inline;color: #11171a;margin-left: 20px;width: 50px;word-break: break-all}
    .examDate{display: inline;color: #11171a;margin-left: 40px;margin-right: 50px;width: 100px}
    .examReport{display: none}
    input[name='Report']{display: inline}
    textarea {resize: none; width: 100% ;height: 100%;padding:10px;padding-right:35px;text-justify:inter-ideograph;text-align: justify;line-height:20px; }
    #basic{width: 120px;background:#FFFFFF;padding:5px;border-radius:10px;height:100%}
    #factor{overflow-y:scroll;position:absolute;top:0;left:calc(120px + 5px);width: calc(100% - 135px);background:#FFFFFF;padding:5px;border-radius:10px;height:calc(100% - 10px);margin:5px}
    #SUV_Localmax{border: 2px solid black;}
    @-webkit-keyframes load7 {
      0%,
      80%,
      100% {
        box-shadow: 0 2.5em 0 -1.3em;
      }
      40% {
        box-shadow: 0 2.5em 0 0;
      }
    }
    @keyframes load7 {
      0%,
      80%,
      100% {
        box-shadow: 0 2.5em 0 -1.3em;
      }
      40% {
        box-shadow: 0 2.5em 0 0;
      }
    }
    textarea{background:url("{% static 'image/texture.png' %}");}
    #image_menu{padding-bottom:5px;padding-left:5px;padding-right:5px;position: fixed;z-index: 5;max-height: 85vh;display: none;margin: 0;width: 100px;background-color: #d6d8db; border-radius: 5px 5px 5px 5px}
    .resetbtn { font-size:10pt;margin:0;margin-top: 5px;width: 100%;max-height: 85vh; border-radius: 5px 5px 5px 5px}
    #location_menu{padding-bottom:5px;padding-left:5px;padding-right:5px;position: fixed;z-index: 5;max-height: 85vh;display: none;margin: 0;width: 100px;background-color: #d6d8db; border-radius: 5px 5px 5px 5px}
    .deletebtn{ margin:0;margin-top: 5px;width: 100%;max-height: 85vh; border-radius: 5px 5px 5px 5px;font-size:auto;word-break: break-all; }

    input[type='radio']:disabled {background-color: #ccc;}
    
    .window{display:inline;font-size:10.5pt;color:black}
    .WW{display:inline;position:absolute;right:20px;top:150px;color:white;z-index:1}
    .WC{display:inline;position:absolute;right:20px;top:130px;color:white;z-index:1}
    .SeriesDes{display:inline;position:absolute;right:20px;top:110px;color:white;z-index:1}
    .variable{display:inline;position:absolute;right:20px;top:90px;color:white;z-index:1}
    .StudyDate{display:inline;position:absolute;right:20px;top:70px;color:white;z-index:1}
    .thickness{display:inline;position:absolute;right:20px;top:50px;color:white;z-index:1}
    .PID{display:inline;position:absolute;right:20px;top:30px;color:white;z-index:1}

    .loader{position:absolute;top:50%;left:50%}
    #SaveCoordinate{display:none}
    .addButton button{width:100%;height:20px;line-height:10px}
    .menublock{width:100%;height:30px}
    .factor{position:absolute;left:10px;width: 30%;height: 25px;padding-top: 0;margin:0;border-radius:5px;font-size:12pt;padding:0px}
    .detail{position:absolute;left:calc(30% + 20px);width: calc(60% - 25px);height: 25px;padding-top: 0;margin:0;border-radius:5px;padding:0px}
    #annotation_basic_info{display: block;padding-top:5px;padding-bottom:5px}
    #annotation_basic_info div{font-weight:600}
    .annotation_factor_delete{position:absolute;right:5px}
    .modal-backdrop.show{opacity: 0}
    #editAnnotation{
        display:none;
        position:absolute;
        left:20%;
        width:calc(10% + 300px);
    }
    .modal-dialog{width:100%}
</style>


<script>
    scrolling1=false
    scrolling2=false
    scrolling3=false
    scrolling4=false

    function test() {
        $('#CT-PET').css('margin-top','50px')
        $('#CT-PET').css('width',$(window).width()*0.7)
        $('#CT-PET').css('height',0)
        $("#frame1").children("label").children('div').children('div').children('img').css('display','none');
        $("#frame2").children("label").children('div').children('div').children('img').css('display','none');
        $("#frame3").children("label").children('div').children('div').children('img').css('display','none');
        $("#frame4").children("label").children('div').children('div').children('img').css('display','none');
        $('.slider').css('display','none')
        $('.loader').css('display','inline')
        $('.loader').css('top',$(window).height()/2)
        $('#Topcheckbox').prop('chencked',false)
        $('#Topcheckbox').prop('disabled',true)
    }
    a=0

    function connect(window_sno){
        let height=Math.floor($('#frame'+window_sno).children('label').children('.slider').height());
        let b = $('#frame'+window_sno).children('label').children('.slider').scrollTop();
        let num = Math.floor($('#frame'+window_sno).children('label').children('.slider').children().height()/height)
        count1=Math.floor(b/height)

        plane=$("#frame"+window_sno).children('label').children('div').children('div').children('.plane').text()
        $("#frame"+window_sno).children('label').children('div').children('div').children('.variable').text(count1+1+'/'+num)
        //if($('#frame1').children('input').is(':checked')){
        if(plane=='Axial'){
            $('#frame'+window_sno).children('label').children('div').children('div').children('.z').text(count1);
        }else if(plane=='Coronal'){
            $("#frame"+window_sno).children('label').children('div').children('div').children('.y').text(count1);
        }else if(plane=='Sagittal'){
            $("#frame"+window_sno).children('label').children('div').children('div').children('.x').text(count1);
        }
        //}
        
        let x=$('#frame'+window_sno).children('label').children('div').children('div').children('.x').text()
        let y=$('#frame'+window_sno).children('label').children('div').children('div').children('.y').text()
        let z=$("#frame"+window_sno).children('label').children('div').children('div').children('.z').text();

        frameXYZ=checkPlaneXYZ(plane,x,y,count1)

        win_num=$('#select').val()
        let imageType = $('#frame'+window_sno).children('label').children('div').children('div').children('.StudyDes').text()
        if(imageType!='MRI'){
            var Con=[]
            for(var i =0;i<win_num;i++) {
                Con.push($('.StudyDes').eq(i).text()+'_'+$('.StudyID').eq(i).text()+'_'+$('.StudyDate').eq(i).text()+'_'+$('.SeriesID').eq(i).text())
            }
            for(var i =0;i<win_num;i++) {
                if(Con[i]==Con[window_sno-1]){
                    var ind=i+1
                    if(ind!=window_sno){
                        comparePlane = $('#frame'+ind).children('label').children('div').children('div').children('.plane').text()
                        if(plane==comparePlane){
                            $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                            
                            let height = Math.floor($('#frame'+ind).children('label').children('.slider').height());
                            let b = $('#frame'+ind).children('label').children('.slider').scrollTop();
                            let num = Math.floor($('#frame'+ind).children('label').children('.slider').children().height()/height)
                            let count=Math.floor(b/height)
                            $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(count+1+'/'+num)
                        }
                        if(plane=='Axial'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.z').text(count1)
                        }else if(plane=='Coronal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.y').text(count1)
                        }else if(plane=='Sagittal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.x').text(count1)
                        }
                    }
                    ajax_connect_view(ind)
                    //ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)
                }
            }
        }else{
            var Con=[]
            for(var i =0;i<win_num;i++) {
                Con.push($('.StudyDes').eq(i).text()+'_'+$('.StudyID').eq(i).text()+'_'+$('.StudyDate').eq(i).text()+'_'+$('.SeriesID').eq(i).text()[1])
            }
            for(var i =0;i<win_num;i++) {
                if(Con[i]==Con[window_sno-1]){
                    var ind=i+1
                    if(ind!=window_sno){
                        if($('.SeriesID').eq(i).text()[0]==$('.SeriesID').eq(window_sno-1).text()[0]){
                            $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                            
                            let height = Math.floor($('#frame'+ind).children('label').children('.slider').height());
                            let b = $('#frame'+ind).children('label').children('.slider').scrollTop();
                            let num = Math.floor($('#frame'+ind).children('label').children('.slider').children().height()/height)
                            let count=Math.floor(b/height)
                            $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(count+1+'/'+num)
                            $('#frame'+ind).children('label').children('div').children('div').children('.z').text(count1)
                        }
                    }
                    ajax_connect_view(ind)
                    //ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)

                }
            }
        }
    }
    function ajax1(event){
        if(scrolling1==true){
            connect(1)
        }

    }(jQuery);
    
    function ajax2(event){
        if(scrolling2==true){
            connect(2)
        }
    }(jQuery);
    function ajax3(event){
        if(scrolling3==true){
            connect(3)
        }
    }(jQuery);
    function ajax4(event){
        if(scrolling4==true){
            connect(4)
        }
    }(jQuery);


    $(document).on("pagecreate","#pageone",function(){
        $("#frame1").on("swipe",function(){

        });                       
      });

    function myFunction(event) {
        document.getElementById("frame1").onmousewheel = function(e){
            let height=$('#frame1').children('label').children('.slider').height();
            let b = $('#frame1').children('label').children('.slider').scrollTop();
            let count=Math.round(b/height);
            /*滑鼠滾動的量 下滾是負 上滾是正*/
            if(e.wheelDelta < 0){
                count ++;
            }else{
                count --;
            }
            let z = Math.round($('#frame1').children('label').children('.slider').children('div').height()/height)
            if (count < 0){
                count = 0
            }else if (count >= z-1) {
                count = z-1
            }
            b = count*height
            $('#frame1').children('label').children('.slider').scrollTop(b);
            scrolling1=true
            scrolling2=false
            scrolling3=false
            scrolling4=false
        }
        document.getElementById("frame2").onmousewheel = function(e){

            let height=$('#frame2').children('label').children('.slider').height();
            let b = $('#frame2').children('label').children('.slider').scrollTop();
            let count=Math.round(b/height);
            if(e.wheelDelta < 0){
                count ++;
            }else{
                count --;
            }
            let z = Math.round($('#frame2').children('label').children('.slider').children('div').height()/height)
            if (count < 0){
                count = 0
            }else if (count >= z-1) {
                count = z-1
            }
            b = count*height
            $('#frame2').children('label').children('.slider').scrollTop(b);
            scrolling1=false
            scrolling2=true
            scrolling3=false
            scrolling4=false
        }
        document.getElementById("frame3").onmousewheel = function(e){

            let height=$('#frame3').children('label').children('.slider').height();
            let b = $('#frame3').children('label').children('.slider').scrollTop();
            let count=Math.round(b/height);
            if(e.wheelDelta < 0){
                count ++;
            }else{
                count --;
            }
            let z = Math.round($('#frame3').children('label').children('.slider').children('div').height()/height)
            if (count < 0){
                count = 0
            }else if (count >= z-1) {
                count = z-1
            }
            b = count*height
            $('#frame3').children('label').children('.slider').scrollTop(b);
            scrolling1=false
            scrolling2=false
            scrolling3=true
            scrolling4=false
        }
        document.getElementById("frame4").onmousewheel = function(e){

            let height=$('#frame4').children('label').children('.slider').height();
            let b = $('#frame4').children('label').children('.slider').scrollTop();
            let count=Math.round(b/height);
            if(e.wheelDelta < 0){
                count ++;
            }else{
                count --;
            }
            let z = Math.round($('#frame4').children('label').children('.slider').children('div').height()/height)
            if (count < 0){
                count = 0
            }else if (count >= z-1) {
                count = z-1
            }
            b = count*height
            $('#frame4').children('label').children('.slider').scrollTop(b);
            //document.getElementById('view1').scrollTop= b
            scrolling1=false
            scrolling2=false
            scrolling3=false
            scrolling4=true
        }
    }(jQuery);
    function bb(){
        $(".slider").prev(".main").children('div').children('p').text()
    }
    function mouseover(event){

        $('#CTWC').val($("[name='group1']:checked").next("label").children('div').children('div').children('.CTWC').text())
        $('#CTWW').val($("[name='group1']:checked").next("label").children('div').children('div').children('.CTWW').text())
        $('#PETWC').val($("[name='group1']:checked").next("label").children('div').children('div').children('.PETWC').text())
        $('#PETWW').val($("[name='group1']:checked").next("label").children('div').children('div').children('.PETWW').text())
        $('#MRIWC').val($("[name='group1']:checked").next("label").children('div').children('div').children('.MRIWC').text())
        $('#MRIWW').val($("[name='group1']:checked").next("label").children('div').children('div').children('.MRIWW').text())
        var Des = $("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDes').text()
        
        var mode=$("[name='group1']:checked").next("label").children('div').children('div').children('.mode').text()
        $('#Mode_menu').val(mode).prop('selected',true);
        $('#Mode').val(mode).prop('selected',true);

        var CT_window=$("[name='group1']:checked").next("label").children('div').children('div').children('.CT_window').text()
        $('#CTWindow').val(CT_window).prop('selected',true);
        $('#CTWindow_menu').val(CT_window).prop('selected',true);
        var LocalMax = $("[name='group1']:checked").next("label").children('div').children('div').children('.LocalMax').text()
        var LocalMax_disable = $("[name='group1']:checked").next("label").children('div').children('div').children('.LocalMax_disable').text()
        if (LocalMax=='true'){
            $('#LocalMax').children('input').prop('checked',true);
        }else{
            $('#LocalMax').children('input').prop('checked',false);
        }
        if (LocalMax_disable=='true'){
            $('#LocalMax').children('input').prop('disabled',true);
        }else{
            $('#LocalMax').children('input').prop('disabled',false);
        }
        if(Des=='PET'){
            $('#viewPlane').prop('disabled',false);
            $('#Mode').prop('disabled',false);
            $('#CT_Group').css('display','inline-flex');
            $('#PET_Group').css('display','inline-flex');
            $('#MRI_Group').css('display','none');
            $('#CTWindow_menu').prop('disabled',false);
            $('#Mode_menu').prop('disabled',false);
            $('#Plane_menu').prop('disabled',false);
            $('#SaveCoordinate').css('display','none')
            $('#RT_Contour').css('display','none')
            $('#MRI_tool').css('display','none')
        }else if(Des=='MRI'){
            $('#viewPlane').prop('disabled',true);
            $('#Mode').prop('disabled',true);
            $('#CT_Group').css('display','none');
            $('#PET_Group').css('display','none');
            $('#MRI_Group').css('display','inline-flex');
            $('#CTWindow_menu').prop('disabled',true);
            $('#Mode_menu').prop('disabled',true);
            $('#Plane_menu').prop('disabled',true);
            $('#SaveCoordinate').css('display','inline-block')
            $('#MRI_tool').css('display','inline-block')
            $('#MRI_tool').css('background','url("{% static 'image/texture.png' %}")');
            $('#MRI_tool').css('background-color','rgba(255,255,255,0.7)')
            $('#RT_Contour').css('display','none')
        }else if(Des=='RTPLAN'){
            $('#viewPlane').prop('disabled',false);
            $('#Mode').prop('disabled',true);
            $('#RT_Contour').css('display','inline-block')
            $('#RT_Contour').css('background','url("{% static 'image/texture.png' %}")');
            $('#RT_Contour').css('background-color','rgba(255,255,255,0.7)')
            $('#CT_Group').css('display','inline-flex');
            $('#PET_Group').css('display','none');
            $('#MRI_Group').css('display','none');

            $('#CTWindow_menu').prop('disabled',false);
            $('#Mode_menu').prop('disabled',false);
            $('#Plane_menu').prop('disabled',false);
            $('#SaveCoordinate').css('display','none')
            $('#MRI_tool').css('display','none')
        }else{
            $('#viewPlane').prop('disabled',false);
            $('#Mode').prop('disabled',true);
            $('#CT_Group').css('display','inline-flex');
            $('#PET_Group').css('display','none');
            $('#MRI_Group').css('display','none');
            $('#CTWindow_menu').prop('disabled',false);
            $('#Mode_menu').prop('disabled',false);
            $('#Plane_menu').prop('disabled',false);
            $('#SaveCoordinate').css('display','none')
            $('#RT_Contour').css('display','none')
            $('#MRI_tool').css('display','none')
        }
        
        var plane=$("[name='group1']:checked").next("label").children('div').children('div').children('.plane').text()
        plane=plane.replace(/\s+/g, '')
        $('#viewPlane').val(plane).prop('selected',true);
        $('#Plane_menu').val(plane).prop('selected',true);

        var StudyDes = $("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDes').text()
        //console.log($("[name='group1']:checked").next("label").children('div').children('div').children('.series').text())
        if(StudyDes=='RTPLAN'){
            $.ajax({
                type: 'post',
                url: "{% url 'DICOM:RT_change' %}", // this is the mapping between the url and view
                data: {
                    'WindowNo':$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text(),
                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                },
                success: function(response) {
                    $('#RT_Contour').empty()

                    for (var i = 0; i < response.ROIname.length; i++) {
                        if (response.index != -1) {
                            if (response.index.indexOf(i) != -1) {
                                
                                $('#RT_Contour').append('' +
                                '<div class="form-check form-switch">' +
                                '<input checked class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="' + response.ROIname[i] + '">' +
                                '<label class="form-check-label" for="' + response.ROIname[i] + '">' + response.ROIname[i] + '</label>' +
                                '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb(' + response.color[i] + ')"></div>' +
                                '</div>' +
                                '')
                            } else {
                                $('#RT_Contour').append('' +
                                '<div class="form-check form-switch">' +
                                '<input class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="' + response.ROIname[i] + '">' +
                                '<label class="form-check-label" for="' + response.ROIname[i] + '">' + response.ROIname[i] + '</label>' +
                                '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb(' + response.color[i] + ')"></div>' +
                                '</div>' +
                                '')
                            }
                        }else{
                            $('#RT_Contour').append('' +
                            '<div class="form-check form-switch">' +
                            '<input class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="' + response.ROIname[i] + '">' +
                            '<label class="form-check-label" for="' + response.ROIname[i] + '">' + response.ROIname[i] + '</label>' +
                            '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb(' + response.color[i] + ')"></div>' +
                            '</div>' +
                            '')
                        }
                    }
                }
            });
        }else{
            $('#RT_Contour').empty()
        }
        if(win_num==1){
            $('#frame1').css('background-color','#33333a');
        }else{
            $("[name='group1']:checked").parents('div').css('background-image',
                'repeating-linear-gradient(to bottom, #FFFFFF 0,#FFFFFF 1%,transparent 1%, transparent 99%),' +
                'repeating-linear-gradient(to right, #FFFFFF 0,#FFFFFF 1%,#33333a 1%,#33333a 99%)'
            )

            $("[name='group1']:not(':checked')").parents('div').css('background','none');
            $("[name='group1']:not(':checked')").parents('div').css('background-color','#33333a');
        }

        var number=$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()

        if(number==1){
            scrolling1=true
            scrolling2=false
            scrolling3=false
            scrolling4=false
        }else if(number==2){
            scrolling1=false
            scrolling2=true
            scrolling3=false
            scrolling4=false
        }else if(number==3){
            scrolling1=false
            scrolling2=false
            scrolling3=true
            scrolling4=false
        }else if(number==4){
            scrolling1=false
            scrolling2=false
            scrolling3=false
            scrolling4=true
        }
        //let window_sno = $("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()
        //functionAjax=[ajax1(),ajax2(),ajax3(),ajax4()]
        //functionAjax[window_sno]
    }
    function ajax_connect_view(name){
        var height=$('#frame'+name.toString()).children('label').children('.slider').height();
        var b = $('#frame'+name.toString()).children('label').children('.slider').scrollTop();
        var count=Math.round(b/height);
        var x=$('#frame'+name.toString()).children('label').children('div').children('#dicom'+name).children('.x').text()
        var y=$('#frame'+name.toString()).children('label').children('div').children('#dicom'+name).children('.y').text()
        var z=$('#frame'+name.toString()).children('label').children('div').children('#dicom'+name).children('.z').text()
        var plane=$("#frame"+name.toString()).children('label').children('div').children('div').children('.plane').text()
        var xyz=checkPlaneXYZ(plane,x,y,z)
        //alert($('#frame1').children('label').children('div').children('#dicom'+name).children('.z').text())
        ajax(name, xyz['x'], xyz['y'], xyz['z'],true, true)
    }
    //window.location.reload(true);
    
    function ajax(name,x,y,z,ActualCoordinates,drawActualCoordinates){
        if(name==1){
            urlname="{% url 'DICOM:DICOM_show1' %}"
        }else if(name==2){
            urlname="{% url 'DICOM:DICOM_show2' %}"
        }else if(name==3) {
            urlname="{% url 'DICOM:DICOM_show3' %}"
        }else if(name==4){
            urlname="{% url 'DICOM:DICOM_show4' %}"
        }
        //console.log(JSON.parse("[" + $("#frame"+name.toString()).children('label').children('div').children('div').children('.MRIWW').text() + "]")[z])
        StudyDes = $("#frame"+name.toString()).children('label').children('div').children('div').children('.StudyDes').text()
        if(StudyDes=='PET'){
            var WC = $("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWC').text()
            var WW = $("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWW').text()
        }else if(StudyDes=='RTPLAN'){
            var WC = $("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWC').text()
            var WW = $("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWW').text()
        }else if(StudyDes=='CT'){
            var WC = $("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWC').text()
            var WW = $("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWW').text()
        }else if(StudyDes=='MRI'){
            var WC = JSON.parse("[" + $("#frame"+name.toString()).children('label').children('div').children('div').children('.MRIWC').text() + "]")[z]
            var WW = JSON.parse("[" + $("#frame"+name.toString()).children('label').children('div').children('div').children('.MRIWW').text() + "]")[z]
        }
        
        $("#frame"+name.toString()).children('label').children('div').children('div').children('.WC').text('WC: '+WC)
        $("#frame"+name.toString()).children('label').children('div').children('div').children('.WW').text('WW: '+WW)

        $.ajax({
            type: 'post',
            url: urlname, // this is the mapping between the url and view
            data: {
                'variable': z, // ! here is the magic, your variable gets transmitted to the server
                'CTWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWC').text(),
                'CTWW':$("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWW').text(),
                'PETWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWC').text(),
                'PETWW':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWW').text(),
                'MRIWC':JSON.parse("[" + $("#frame"+name.toString()).children('label').children('div').children('div').children('.MRIWC').text() + "]")[z],
                'MRIWW':JSON.parse("[" + $("#frame"+name.toString()).children('label').children('div').children('div').children('.MRIWW').text() + "]")[z],
                'plane':$("#frame"+name.toString()).children('label').children('div').children('div').children('.plane').text(),
                'mode':$("#frame"+name.toString()).children('label').children('div').children('div').children('.mode').text(),
                'source':$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDate').text().toString()+$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyID').text().toString()+$("[name='group1']:checked").next("label").children('div').children('div').children('.SeriesID').text().toString(),
                'target':$("#frame"+name.toString()).children('label').children('div').children('div').children('.StudyDate').text().toString()+$("#frame"+name.toString()).children('label').children('div').children('div').children('.StudyID').text().toString()+$("#frame"+name.toString()).children('label').children('div').children('div').children('.SeriesID').text().toString(),
                'source_variable':$("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                'x': x,
                'y': y,
                'height':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').height(),
                'width':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').width(),
                'ActualCoordinates':ActualCoordinates,
                'drawActualCoordinates':drawActualCoordinates,
                'MRI_CrossLink':$('#MRI_CrossLink').is(':checked'),
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            async:true,
            cache:true,
            success: function(response) {
                $("#frame"+name.toString()).children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                //$("#frame"+name.toString()).children('label').children('.slider').scrollTop(z*$("#frame"+name.toString()).children('label').children('.slider').height())
            },
        });

    }
    function locationCompute(name,x,y,z){
       
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:convertLocation" %}', // this is the mapping between the url and view
            data: {
                'z': z, // ! here is the magic, your variable gets transmitted to the server
                'plane':$("#frame"+name.toString()).children('label').children('div').children('div').children('.plane').text(),
                'x': x,
                'y': y,
                'imageType':$('#frame'+name.toString()).children('label').children('div').children('div').children('.StudyDes').text(),
                'height':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').height(),
                'width':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').width(),
                'PETWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWC').text(),
                'WindowNo':$("#frame"+name.toString()).children('label').children('div').children('div').children('.series').text(),
                'source':$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDate').text().toString()+$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyID').text().toString()+$("[name='group1']:checked").next("label").children('div').children('div').children('.SeriesID').text().toString(),
                'target':$("#frame"+name.toString()).children('label').children('div').children('div').children('.StudyDate').text().toString()+$("#frame"+name.toString()).children('label').children('div').children('div').children('.StudyID').text().toString()+$("#frame"+name.toString()).children('label').children('div').children('div').children('.SeriesID').text().toString(),
                'source_variable':$("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success: function(response) {
                x=response.x
                y=response.y
                z=response.z
                
                $("#frame"+name.toString()).children('label').children('div').children('div').children('.x').text(response.x)
                $("#frame"+name.toString()).children('label').children('div').children('div').children('.y').text(response.y)
                $("#frame"+name.toString()).children('label').children('div').children('div').children('.z').text(response.z)

                DrawWithMouse(x,y,z,name)
                
            }
        });
    }
    function checkPlaneXYZ(frame,x,y,z){
         if(frame=='Axial'){
            frame1_x=x
            frame1_y=y
            frame1_z=z
        }else if(frame=='Coronal'){
            frame1_x=x
            frame1_y=z
            frame1_z=y
        }else if(frame=='Sagittal'){
            frame1_x=y
            frame1_y=z
            frame1_z=x
        }
        return {'x':frame1_x,'y':frame1_y,'z':frame1_z}
    }
    function draw(){
        $("[name='location']:checked").next('label').css('background-color','#e78632')
        
        var indices=$("[name='location']").not(':checked')

        for(var i =0;i<indices.length;i++){

            if (indices.eq(i).next('label').children('.indices').text()==0) {
                if(indices.eq(i).next('label').children('.data1').eq(2).text()=='Primary tumor'){
                    indices.eq(i).next('label').css('background-color', '#BBBBBB')
                }else{
                    indices.eq(i).next('label').css('background-color', '#808F7C')
                }
            }else if(indices.eq(i).next('label').children('.indices').text()==1) {
                indices.eq(i).next('label').css('background-color','#A8D8B9')
            }else if(indices.eq(i).next('label').children('.indices').text()==2){
                indices.eq(i).next('label').css('background-color','#81C7D4')
            }else if(indices.eq(i).next('label').children('.indices').text()==3){
                indices.eq(i).next('label').css('background-color','#808F7C')
            }
            if(indices.eq(i).next('label').children('.Dr_confirm').text()=='true'){
                indices.eq(i).next('label').css('background-color', '#333333')
                indices.eq(i).next('label').children('p').css('color', '#FFFFFF')
            }
        }

        ActualCoordinates=true
        strAry=($("[name='location']:checked").next('label').children('.info').text())
        a=strAry.split(',')
        x=a[0]
        y=a[1]
        z=a[2].split('--')[0]

        var SD=$("[name='location']:checked").next('label').children('.LocalSeriesID').text()
        var Date=$("[name='location']:checked").next('label').children('.LocalStudyDate').text()
        var StudyID=$("[name='location']:checked").next('label').children('.LocalStudyID').text()
        var Con=[]
        for(var i =0;i<4;i++) {
            Con.push($('.StudyDate').eq(i).text()+$('.StudyID').eq(i).text()+$('.SeriesID').eq(i).text())
        }

        for(var i =0;i<4;i++) {
            if(Con[i]==Date+StudyID+SD){
                var ind=i+1
               
                frame=$("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.plane').text()
                frameXYZ=checkPlaneXYZ(frame,x,y,z)
                //ajax_connect_view(ind)
                //$('#frame'+ind).children('label').children('.slider').scrollTop(b)
                ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)

                $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                $('#frame'+ind).children('label').children('div').children('div').children('.x').text(x)
                $('#frame'+ind).children('label').children('div').children('div').children('.y').text(y)
                $('#frame'+ind).children('label').children('div').children('div').children('.z').text(z)
                let height=$('#frame'+ind).children('label').children('.slider').height();
                let num = Math.ceil($('#frame'+ind).children('label').children('.slider').children().height()/height)
                
                $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(parseInt(frameXYZ['z'])+1+'/'+num)
            }
        }
    }

    function DrawWithMouse(x,y,z,name){
        ActualCoordinates=true

        scrolling=false
        let imageType = $('#frame'+name).children('label').children('div').children('div').children('.StudyDes').text()
        if (imageType != 'MRI'){
            var Con = $('.StudyDate').map(function(){return $(this).prevAll('.StudyDes').text()+'_'+$(this).text()+'_'+$(this).prevAll('.StudyID').text()+'_'+$(this).prevAll('.SeriesID').text()}).get()
        }else{
            var Con = $('.StudyDate').map(function(){return $(this).prevAll('.StudyDes').text()+'_'+$(this).text()+'_'+$(this).prevAll('.StudyID').text()+'_'+$(this).prevAll('.SeriesID').text()[1]}).get()
        }

        for(var i =0;i<4;i++) {
            if(Con[i]==Con[name-1]){
                var ind=i+1

                frame=$("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.plane').text()

                let height=Math.floor($('#frame'+ind).children('label').children('.slider').height());
                let num = Math.floor($('#frame'+ind).children('label').children('.slider').children().height()/height)
                let imageType = $('#frame'+ind).children('label').children('div').children('div').children('.StudyDes').text()

                if (imageType == 'MRI'){
                   // alert($("#frame"+ind).children('label').children('div').children('div').children('.StudyDate').text().toString()+$("#frame"+name.toString()).children('label').children('div').children('div').children('.StudyID').text().toString()+$("#frame"+name.toString()).children('label').children('div').children('div').children('.SeriesID').text().toString())
                    $.ajax({
                        type: 'post',
                        url: '{% url "DICOM:convert_MRI_coordinate" %}', // this is the mapping between the url and view
                        data: {
                            'ind':ind,
                            'source':$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDate').text().toString()+$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyID').text().toString()+$("[name='group1']:checked").next("label").children('div').children('div').children('.SeriesID').text().toString(),
                            'target':$("#frame"+ind).children('label').children('div').children('div').children('.StudyDate').text().toString()+$("#frame"+ind).children('label').children('div').children('div').children('.StudyID').text().toString()+$("#frame"+ind).children('label').children('div').children('div').children('.SeriesID').text().toString(),
                            'source_variable':$("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                            'x': x,
                            'y': y,
                            'z': z,
                            'csrfmiddlewaretoken': window.CSRF_TOKEN
                        },
                        success: function (response) {
                            $("#frame"+response.ind).children('label').children('div').children('#dicom'+response.ind).children('.x').text(response.x)
                            $("#frame"+response.ind).children('label').children('div').children('#dicom'+response.ind).children('.y').text(response.y)
                            $("#frame"+response.ind).children('label').children('div').children('#dicom'+response.ind).children('.z').text(response.z)
                            $("#frame"+response.ind).children('label').children('.slider').scrollTop(response.z*$("#frame"+response.ind).children('label').children('.slider').height())
                            $('#frame'+response.ind).children('label').children('div').children('div').children('.variable').text(response.z+1+'/'+num)
                            ajax(response.ind,response.x,response.y,response.z,true,true)
                        }
                    });
                }else{
                    frameXYZ=checkPlaneXYZ(frame,x,y,z)
                    ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)
                    $("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.x').text(x)
                    $("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.y').text(y)
                    $("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.z').text(z)
                    $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                    $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(parseInt(frameXYZ['z'])+1+'/'+num)
                }
            }
        }

    }
    function showReport(){
        if($("[name='Report']:checked").length>4){
            $('#'+event.target.id).prop('checked',false)
        }
        $("[name='Report']:checked").parents('td').css('background-color','#e78632')
        $("[name='Report']:not(':checked')").parents('td').css('background-color','#eeefef')
        for (var i = 0; i < $("[name='Report']:checked").length; i++) {
            var text =$("[name='Report']:checked").eq(i).prev('label').children('.examDate').text()+'\n'+'\n'
            text=text+$("[name='Report']:checked").eq(i).prev('label').children('.examReport').text()
            $('#T'+(i+1)).text(text)
        }

        if($("[name='Report']:checked").length==1){
            $('#T1').css('width','100%')
            $('#T1').css('height','100%')
            $('#T2').css('display','none')
            $('#T3').css('display','none')
            $('#T4').css('display','none')
        }
        if($("[name='Report']:checked").length==2){

            $('#T1').css('width','100%')
            $('#T1').css('height','50%')
            $('#T2').css('width','100%')
            $('#T2').css('height','50%')
            $('#T2').css('display','inline')
            $('#T3').css('display','none')
            $('#T4').css('display','none')
        }
        if($("[name='Report']:checked").length==3){

            $('#T1').css('width','100%')
            $('#T1').css('height','33%')
            $('#T2').css('width','100%')
            $('#T2').css('height','33%')
            $('#T2').css('display','inline')
            $('#T3').css('width','100%')
            $('#T3').css('height','34%')
            $('#T3').css('display','inline')
            $('#T4').css('display','none')
        }
        if($("[name='Report']:checked").length==4){

            $('#T1').css('width','100%')
            $('#T1').css('height','25%')
            $('#T2').css('width','100%')
            $('#T2').css('height','25%')
            $('#T2').css('display','inline')
            $('#T3').css('width','100%')
            $('#T3').css('height','25%')
            $('#T3').css('display','inline')
            $('#T4').css('width','100%')
            $('#T4').css('height','25%')
            $('#T4').css('display','inline')
        }
    }
    function localmaxclick(name){
        var lx=$(event.target).next('label').children('.Localmax_x').text()
        var ly=$(event.target).next('label').children('.Localmax_y').text()
        var lz=$(event.target).next('label').children('.Localmax_z').text()
        var lsuv=$(event.target).next('label').children('.Localmax_SUV').text()
        var Con = $('.StudyDate').map(function(){return $(this).text()+'_'+$(this).prevAll('.StudyID').text()+'_'+$(this).prevAll('.SeriesID').text()}).get()
        for(var i =0;i<4;i++) {
            if(Con[i]==Con[name-1]){
                var ind=i+1
                $('#frame'+ind).children('label').children('div').children('div').children('.x').text(lx)
                $('#frame'+ind).children('label').children('div').children('div').children('.y').text(ly)
                $('#frame'+ind).children('label').children('div').children('div').children('.z').text(lz)
                $('#frame'+ind).children('label').children('div').children('div').children('.SUV').val(lsuv)
            }
        }


        DrawWithMouse(lx,ly,lz,name)
    }
    function window_load(){
        var ExecDate = $(event.target).parents('.col').parents('.row').prevAll('.row2').children('.ImageExecDate').html()
        StudyDes = $(event.target).parents('.col').parents('.row').prevAll('.row2').children('.ImageStudyDes').html().replaceAll(' ','')
        var StudyID = $(event.target).parents('.col').parents('.row').prevAll('.row2').children('.ImageStudyID').html()
        var SeriesID = $(event.target).parents('.col').parents('.row').prevAll('.row2').children('.ImageSeriesID').html()
        var SeriesDes = $(event.target).parents('.col').parents('.row').prevAll('.row2').children('.ImageSeriesDes').html()
        var PID = $('#PIDText').text()
        var WindowNo = $(event.target).attr('name')

        var STD = $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyDate').text()
        var STID = $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyID').text()
        
        if((STID+STD)!=(StudyID+ExecDate)){
            $.ajax({
                type: 'post',
                url: '{% url "DICOM:window_load" %}', // this is the mapping between the url and view
                data:{
                    'WindowNo':WindowNo,
                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                },
            })
        }
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.img').css('width','100%')
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.img').css('height','100%')
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyDate').text(ExecDate)
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyID').text(StudyID)
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.SeriesID').text(SeriesID)
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.SeriesDes').text(SeriesDes)
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyDes').text(StudyDes)
        
        $('#frame'+WindowNo).children('label').children('.slider').css('display','none');
        $('#frame'+WindowNo).children('label').children('.main').children('.loader').css('display','inline')
        $('#frame'+WindowNo).children("label").children('div').children('div').children('img').css('display','none')
        $('.loader').css('top',$("#frame1").height()/2)
        
        if(StudyDes=='PET'){
            loadDICOMurlname="{% url 'DICOM:load_DICOM' %}"
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.StudyDes').text('PET')
            $("#frame"+WindowNo).children('label').children('div').children('div').children('.mode').text('Fusion')
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.LocalMax').text(true)
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.LocalMax_disable').text(false)
        }else if(StudyDes=='RTPLAN'){
            loadDICOMurlname="{% url 'DICOM:load_RT_DICOM' %}"
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.StudyDes').text('RTPLAN')
            $("#frame"+WindowNo).children('label').children('div').children('div').children('.mode').text('CT')
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.LocalMax').text(false)
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.LocalMax_disable').text(true)
        }else if(StudyDes=='CT'){
            loadDICOMurlname="{% url 'DICOM:load_CT_DICOM' %}"
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.StudyDes').text('CT')
            $("#frame"+WindowNo).children('label').children('div').children('div').children('.mode').text('CT')
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.LocalMax').text(false)
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.LocalMax_disable').text(true)
        }else if(StudyDes=='MRI'){
            loadDICOMurlname="{% url 'DICOM:load_MRI_DICOM' %}"
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.StudyDes').text('MRI')
            $("#frame"+WindowNo).children('label').children('div').children('div').children('.mode').text('CT')
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.LocalMax').text(false)
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.LocalMax_disable').text(true)
        }
        $.ajax({
            type: 'post',
            url: loadDICOMurlname, // this is the mapping between the url and view
            data:{
                'StudyDes':StudyDes,
                'WindowNo':WindowNo,
                'root':root,
                'PID':PID,
                'MedExecTime':ExecDate,
                'StudyIDText':StudyID,
                'SeriesIDText':SeriesID,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response) {
                $('#RT_Contour').empty()
                if(StudyDes=='RTPLAN'){
                    $.ajax({
                        type: 'post',
                        url: '{% url "DICOM:ROIname" %}', // this is the mapping between the url and view
                        data: {
                            'WindowNo': WindowNo, // ! here is the magic, your variable gets transmitted to the server
                            'csrfmiddlewaretoken': window.CSRF_TOKEN
                        },
                        success: function(response) {
                            $('#RT_Contour').empty()
                            for(var i =0;i<response.ROIname.length;i++) {
                                
                                $('#RT_Contour').append('' +
                                    '<div class="form-check form-switch">' +
                                        '<input class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="'+response.ROIname[i]+'">' +
                                        '<label class="form-check-label" for="'+response.ROIname[i]+'">' + response.ROIname[i] + '</label>' +
                                        '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb('+response.color[i]+')"></div>' +
                                    '</div>' +
                                '')
                            }
                        },
                    });
                }else if(StudyDes=='MRI'){
                    $('#MRIWC').val(response.MRIWC[0])
                    $('#MRIWW').val(response.MRIWW[0])
                    $("#frame"+WindowNo.toString()).children('label').children('div').children('div').children('.MRIWC').text(response.MRIWC.toString())
                    $("#frame"+WindowNo.toString()).children('label').children('div').children('div').children('.MRIWW').text(response.MRIWW.toString())
                    $("#frame"+WindowNo.toString()).children('label').children('div').children('div').children('.WC').text('WC: '+response.MRIWC[0])
                    $("#frame"+WindowNo.toString()).children('label').children('div').children('div').children('.WW').text('WW: '+response.MRIWW[0])
                }
                $('.loader').css('display','none')
                if(WindowNo==1){
                    urlname="{% url 'DICOM:DICOM_show1' %}"
                }else if(WindowNo==2){
                    urlname="{% url 'DICOM:DICOM_show2' %}"
                }else if(WindowNo==3) {
                    urlname="{% url 'DICOM:DICOM_show3' %}"
                }else if(WindowNo==4){
                    urlname="{% url 'DICOM:DICOM_show4' %}"
                }
                name=WindowNo
                $("#frame"+name.toString()).children("label").children('div').children('div').children('img').css('display','inline-block');
                $("#frame"+name.toString()).children("label").children('.slider').css('display','inline-block');
                $('#frame'+WindowNo).children('input').prop('checked',true)
                //$('#viewPlane').val('Axial').prop('selected',true);
                //alert($("[name='group1']:checked").next("label").children('div').children('div').children('.series').text())
                $.ajax({
                    type: 'post',
                    url: urlname, // this is the mapping between the url and view
                    data: {
                        'variable': 0, // ! here is the magic, your variable gets transmitted to the server
                        'CTWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWC').text(),
                        'CTWW':$("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWW').text(),
                        'PETWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWC').text(),
                        'PETWW':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWW').text(),
                        'MRIWC':JSON.parse("[" + $("#frame"+name.toString()).children('label').children('div').children('div').children('.MRIWC').text() + "]")[0],
                        'MRIWW':JSON.parse("[" + $("#frame"+name.toString()).children('label').children('div').children('div').children('.MRIWW').text() + "]")[0],
                        'plane':$("#frame"+name.toString()).children('label').children('div').children('div').children('.plane').text(),
                        'mode':$("#frame"+name.toString()).children('label').children('div').children('div').children('.mode').text(),
                        'source':$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDate').text()+$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyID').text()+$("[name='group1']:checked").next("label").children('div').children('div').children('.SeriesID').text(),
                        'target':$("#frame"+name.toString()).children('label').children('div').children('div').children('.StudyDate').text()+$("#frame"+name.toString()).children('label').children('div').children('div').children('.StudyID').text()+$("#frame"+name.toString()).children('label').children('div').children('div').children('.SeriesID').text(),
                        'source_variable':$("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                        'x': 0,
                        'y': 0,
                        'height':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').height(),
                        'width':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').width(),
                        'ActualCoordinates':true,
                        'drawActualCoordinates':true,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function(response) {
                        $('#frame'+name.toString()).children('label').children('.main').children('div').children('.thickness').text(response.thickness+'mm')
                        $("#frame"+name.toString()).children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                        z=response.z
                        $("#frame"+name.toString()).children('label').children('.slider').children('div').css('height',z*100+'%')
                        $('#frame'+name.toString()).children('label').children('.slider').scrollTop(0)
                        $('#frame'+name.toString()).children('label').children('div').children('div').children('.variable').text(1+'/'+z)
                        mouseover()
                        
                    },
                    complete:function(){
                        selection()
                        let window_sno = $("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()
                        functionAjax=[ajax1(),ajax2(),ajax3(),ajax4()]
                        functionAjax[window_sno]
                    }
                });
                selectLocation()
            }
        });
    }

    //畫RT影像
    function drawContour(){
        var ROIname=[]
        var Color=[]
        for(var i=0;i<$('input[name="RT"]:checked').length;i++){
            ROIname.push($('input[name="RT"]:checked').eq(i).next('label').html())
            Color.push($('input[name="RT"]:checked').eq(i).nextAll('div').css('background-color'))
        }

        $.ajax({
            type: 'post',
            url: '{% url "DICOM:DrawContour" %}', // this is the mapping between the url and view
            data:{
                'WindowNo':$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text(),
                'ROIname':ROIname,
                'Color':Color,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            }
        })
    }
    function CTWindow_menu(){
        var CT_window = $('#CTWindow_menu option:selected').val()
        $('#CTWindow').val(CT_window).prop('selected',true);
        dicomwindow()
    }
    function Mode_menu(){
        var Mode = $('#Mode_menu option:selected').val()
        $('#Mode').val(Mode).prop('selected',true);
        dicomwindow()
    }
    function Plane_menu(){
        var viewPlane = $('#Plane_menu option:selected').val()
        $('#viewPlane').val(viewPlane).prop('selected',true);
        dicomwindow()
    }


    function right_function(e){
        var x = e.originalEvent.x || e.originalEvent.layerX || 0;
        var y = e.originalEvent.y || e.originalEvent.layerY || 0;
        $("#image_menu").css('display', 'inline');
        $("#image_menu").css('left', x);
        $("#image_menu").css('top', y);
    }
    const handleWheel = function(e) {
        if(e.ctrlKey || e.metaKey)
            e.preventDefault();
    };
    window.addEventListener("wheel", handleWheel, {passive: false});

    

    function UNet(){
        let id = $('input[name="location"]:checked').next('label').children('.deleteInfo').text();
        let position = $('input[name="location"]:checked').next('label').children('.info').text();
        let plane = $("[name='group1']:checked").next("label").children('div').children('div').children('.plane').text();
        let WindowNo = $("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()
        let x = position.split(',')[0];
        let y = position.split(',')[1];
        let z = position.split(',')[2];
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:UNet" %}', // this is the mapping between the url and view
            data:{
                'id':id,
                'WindowNo':WindowNo,
                'plane':plane,
                'x':x,
                'y':y,
                'z':z,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },success:function(){
                $("#location_menu").css('display', 'none')
                let SeriesID=$("[name='location']:checked").next('label').children('.LocalSeriesID').text()
                let Date=$("[name='location']:checked").next('label').children('.LocalStudyDate').text()
                let StudyID=$("[name='location']:checked").next('label').children('.LocalStudyID').text()
                let ActualCoordinates=true
                var Con = $('.StudyDate').map(function(){return $(this).text()+'_'+$(this).prevAll('.StudyID').text()+'_'+$(this).prevAll('.SeriesID').text()}).get()
                for(var i =0;i<4;i++) {
                    if(Con[i]==Date+'_'+StudyID+'_'+SeriesID){
                        var ind=i+1
                        
                        frame=$("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.plane').text()
                        frameXYZ=checkPlaneXYZ(frame,x,y,z)
                        ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)
                        $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                        $('#frame'+ind).children('label').children('div').children('div').children('.x').text(x)
                        $('#frame'+ind).children('label').children('div').children('div').children('.y').text(y)
                        $('#frame'+ind).children('label').children('div').children('div').children('.z').text(z)
                        let height=$('#frame'+ind).children('label').children('.slider').height();
                        let num = Math.ceil($('#frame'+ind).children('label').children('.slider').children().height()/height)
                        $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(parseInt(frameXYZ['z'])+1+'/'+num)
                    }
                }
            }
        })
    }

    function selectLocation(){
        PID = $('#PIDText').text()

        str = $('.StudyID').map(function(){return $(this).text()+'_'+$(this).nextAll('.SeriesID').text()}).get()
        Study_Date = $('.StudyDate').map(function(){return $(this).text()}).get()
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:selectLocation" %}', // this is the mapping between the url and view
            data: {
                'PID': PID,
                'Disease':$('#Disease').val(),
                'username':$('#users option:selected').text(),
                'date':Study_Date,
                'str':str,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success: function (response) {

                $('#textarea').children('tr').remove();
                
                for (var i = 0; i < response.PID.length; i++) {
                    $('#textarea').append('<tr><td><input onclick="draw()" type="radio" name="location" id=' + i + '>' +
                        '<label for=' + i + '>' +
                        '<p class="deleteInfo">' + response.id[i] + '</p>' +
                        '<p class="info">' + response.x[i] + ',' + response.y[i] + ',' + response.z[i]+'</p><p class="data">'+response.SUV[i] + '</p>' +
                        '<p class="data1">StudyID:' + response.StudyID[i] +'</p>'+
                        '<p class="data1">SeriesID:' + response.SeriesID[i] +'</p>'+
                        '<p class="data1">' + response.LabelGroup[i] +'</p>'+
                        '<p class="data1">' + response.LabelName[i] +'</p>'+
                        '<p class="data1">' + response.LabelRecord[i] +'</p>'+
                        '<p class="LocalStudyID">' + response.StudyID[i] +'</p>'+
                        '<p class="LocalSeriesID">' + response.SeriesID[i] +'</p>'+
                        '<p class="LocalStudyDate">' + response.SD[i] +'</p>'+
                        '<p class="indices">' + response.indices[i] +'</p>'+
                        '<p class="Dr_confirm">' + response.Dr_confirm[i] +'</p>'+
                        '</label></td></tr>')
                    
                    if (response.indices[i]==0) {
                        //alert(response.LabelGroup[i]=='Primary tumor')
                        if(response.LabelGroup[i]=='Primary tumor'){
                            $('#' + i).next('label').css('background-color', '#BBBBBB')
                        }else{
                            $('#' + i).next('label').css('background-color', '#808F7C')
                        }
                    }else if(response.indices[i]==1) {
                        $('#'+i).next('label').css('background-color','#A8D8B9')
                    }else if(response.indices[i]==2){
                        $('#'+i).next('label').css('background-color','#81C7D4')
                    }else if(response.indices[i]==3){
                        $('#'+i).next('label').css('background-color','#808F7C')
                    }
                    if(response.Dr_confirm[i]){
                        $('#' + i).next('label').css('background-color', '#333333')
                        $('#' + i).next('label').children('p').css('color', '#FFFFFF')
                    }
                }
                $('.localizationform').scrollTop($('#textarea').height())
            },
        });
    }

    function SaveCoordinate(){
        let PID = $("[name='group1']:checked").next("label").children('div').children('div').children('.PID').text()
        let StudyID = $("[name='group1']:checked").next("label").children('div').children('div').children('.StudyID').text()
        let SeriesID = $("[name='group1']:checked").next("label").children('div').children('div').children('.SeriesID').text()
        let variable = Math.floor($("[name='group1']:checked").next("label").children('.slider').scrollTop()/Math.floor($("[name='group1']:checked").next("label").children('.slider').height()))
        let username = JSON.parse(document.getElementById('user_username').textContent)
        let Disease = $('#Disease').val()
        let date = $("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDate').text()
        let LabelRecord = $('#MRI_LabelRecord').val()
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:SaveCoordinate" %}', // this is the mapping between the url and view
            data: {
                'PID':PID,
                'StudyID':StudyID,
                'SeriesID':SeriesID,
                'variable':variable,
                'username':username,
                'Disease':Disease,
                'date':date,
                'LabelRecord':LabelRecord,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success: function(response) {

                selectLocation()
            },
        });
    }

    function getuser(){
        let username = JSON.parse(document.getElementById('user_username').textContent)
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:getusers" %}', // this is the mapping between the url and view
            data: {
                'username':username,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success: function(response) {
                
                for(var i=0;i<response.users.length;i++){
                    $('#users').append('<option >'+response.users[i]+'</option>')
                    if(response.users[i]==username){
                        $('#users').children('option').eq(i).prop('selected',true)
                    }
                }
                if(response.is_superuser){
                    $('#users').css({
                        'z-index': '2',
                        'position': 'fixed',
                        'height': '40px',
                        'top': '95px',
                        'width': '9.9%',
                        'margin': '0px',
                        'right': '20%',
                        'border-radius': '0px 0px 5px 5px'
                    })
                    $('.localizationform').css({
                        'position': 'fixed',
                        'height': 'calc(100% - 130px)', 
                        'top': '130px',  
                        'right': '20%'
                    })
                }
            }
        });
    }

    function addMenu(){
        let i = $('.menublock').length
        let pannel = $(event.target).parent('div')
        let option = ''
        let addObject = '<div class=menublock id="annotation_detail_'+i+'">'+
            '<select onchange="getAnnotationFactorDetail()" class="factor form-select form-select-sm"  aria-label=".form-select-sm example"><option>請選擇</option>'+annotationFactorObject+'</select>'+
            '<input placeholder="請選擇或自行輸入"  autocomplete=true class="detail form-control" list="factorDetailList_'+i+'"><datalist id="factorDetailList_'+i+'"></datalist>'+
            '<button type="button" class="btn-close annotation_factor_delete" aria-label="Close" onclick="deleteAnnotationFactor()"></button>'+
            '</div>'
        pannel.before(addObject)   
    }
    function addMenuCustom(pannel,f_id){
        let i = pannel.prevAll('.menublock').length
        let option = ''
        let addObject = '<div class=menublock id="annotation_detail_f_id_'+f_id+'">'+
            '<select onchange="getAnnotationFactorDetail()" class="factor form-select form-select-sm"  aria-label=".form-select-sm example"><option>請選擇</option>'+annotationFactorObject+'</select>'+
            '<input placeholder="請選擇或自行輸入"  autocomplete=true class="detail form-control" list="factorDetailList_f_id_'+f_id+'"><datalist id="factorDetailList_f_id_'+f_id+'"></datalist>'+
            '<button type="button" class="btn-close annotation_factor_delete" aria-label="Close" onclick="deleteAnnotationFactor()"></button>'+
            '</div>'
        pannel.before(addObject)   
    }
    function getAnnotationFactorDetail(){
        let factor_id = $(event.target).val()
        let target = $(event.target)
        let objectID='factorDetailList_'+target.parents('.menublock').attr('id').split('annotation_detail_')[1]
        $('#'+objectID).empty()
        target.next('input').val('')
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:getAnnotationFactorDetail" %}', // this is the mapping between the url and view
            data: {
                'factor_id':factor_id,
                'objectID':objectID,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                let objectID = this.data.split('objectID=')[1]
                $('#'+objectID).append(response.detail)
            }
        });
    }

    function annotation_submit(){
        str = $('.StudyID').map(function(){return $(this).text()+'_'+$(this).nextAll('.SeriesID').text()}).get()
        Study_Date = $('.StudyDate').map(function(){return $(this).text()}).get()
        user_username = JSON.parse(document.getElementById('user_username').textContent);
        height = $("[name='group1']:checked").next("label").children('.slider').height();
        b = $("[name='group1']:checked").next("label").children('.slider').scrollTop();
        count = Math.round(b / height);
        LabelGroup = $('#LabelGroup').val();
        LabelName = $('#LabelName').val();
        LabelRecord = $('#LabelRecord').val();
        $('#tumor').children('select').css('border-color', 'black')


        if (LabelGroup != '輸入病灶') {
            $('#tumor').css('display', 'none')
            elementClicked = 'False'
            let imageType = $("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDes').text()
            if(imageType != 'MRI'){
                let object = $("[name='group1']:checked").next("label").children('div').children('div')
                insertAnnotation(PID,user_username,object,LabelGroup,LabelName,LabelRecord,str,Study_Date)
            }else{
                var Con = $('.StudyDate').map(function(){return $(this).prevAll('.StudyDes').text()+'_'+$(this).text()+'_'+$(this).prevAll('.StudyID').text()+'_'+$(this).prevAll('.SeriesID').text()[1]}).get()
                win = $("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()
                for(var i =0;i<4;i++) {
                    if(Con[i]==Con[win-1]){
                        var ind=i+1
                        var object = $("#frame"+ind.toString()).children('label').children('div').children('div')
                        insertAnnotation(PID,user_username,object,LabelGroup,LabelName,LabelRecord,str,Study_Date)
                    }
                }
            }
        } else {
            $('#tumor').children('select').css('border-color', 'red')
        }
    }
    function insertAnnotation(PID,user_username,object,LabelGroup,LabelName,LabelRecord,str,Study_Date){
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:insertLocation" %}', // this is the mapping between the url and view
            data: {
                'PID':PID,
                'SD':object.children('.StudyDate').text(),
                'Item': Item,
                'username': user_username,
                'x': object.children('.x').text(),
                'y': object.children('.y').text(),
                'z': object.children('.z').text(),
                'LabelGroup': LabelGroup,
                'LabelName': LabelName,
                'LabelRecord': LabelRecord,
                'SUV':object.children('.SUV').val(),
                'plane':object.children('.plane').text(),
                'height':object.children('img').height(),
                'width':object.children('img').width(),
                'ActualCoordinates':false,
                'Disease':$('#Disease').val(),
                'StudyID':object.children('.StudyID').text(),
                'SeriesID':object.children('.SeriesID').text(),
                'WindowNo':object.children('.series').text(),
                'str':str,
                'Study_Date':Study_Date,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success: function (response) {
                insertAnnotationFactor(response.inserted_id)
                $('#textarea').children('tr').remove();
                for (var i = 0; i < response.PID.length; i++) {
                    $('#textarea').append('<tr><td ><input onclick="draw()" type="radio" name="location" id=' + i + '>' +
                        '<label  for=' + i + '>' +
                        '<p class="deleteInfo">' + response.id[i] + '</p>' +
                        '<p class="info">' + response.x[i] + ',' + response.y[i] + ',' + response.z[i]+'</p><p class="data">'+response.SUV[i] + '</p>' +
                        '<p class="data1">StudyID:' + response.StudyID[i] +'</p>'+
                        '<p class="data1">SeriesID:' + response.SeriesID[i] +'</p>'+
                        '<p class="data1">' + response.LabelGroup[i] +'</p>'+
                        '<p class="data1">' + response.LabelName[i] +'</p>'+
                        '<p class="data1">' + response.LabelRecord[i] +'</p>'+
                        '<p class="LocalStudyID">' + response.StudyID[i] +'</p>'+
                        '<p class="LocalSeriesID">' + response.SeriesID[i] +'</p>'+
                        '<p class="LocalStudyDate">' + response.SD[i] +'</p>'+
                        '<p class="indices">' + response.indices[i] +'</p>'+
                        '<p class="Dr_confirm">' + response.Dr_confirm[i] +'</p>'+
                        '</label></td></tr>')
                    if (response.indices[i]==0) {
                        if(response.LabelGroup[i]=='Primary tumor'){
                            $('#' + i).next('label').css('background-color', '#BBBBBB')
                        }else{
                            $('#' + i).next('label').css('background-color', '#808F7C')
                        }
                    }else if(response.indices[i]==1) {
                        $('#'+i).next('label').css('background-color','#A8D8B9')
                    }else if(response.indices[i]==2){
                        $('#'+i).next('label').css('background-color','#81C7D4')
                    }else if(response.indices[i]==3){
                        $('#'+i).next('label').css('background-color','#808F7C')
                    }
                    if(response.Dr_confirm[i]){
                        $('#' + i).next('label').css('background-color', '#333333')
                        $('#' + i).next('label').children('p').css('color', '#FFFFFF')
                    }
                }
                $('.localizationform').scrollTop($('#textarea').height())
            }
        });
    }
    function insertAnnotationFactor(id){
        let annotation_factor = $('#tumor').children('#factor').children('.menublock').children('.factor').map(function(){return $(this).val()}).get()
        let annotation_factor_detail = $('#tumor').children('#factor').children('.menublock').children('.detail').map(function(){return $(this).val()}).get()
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:insertAnnotationFactor" %}', // this is the mapping between the url and view
            data: {
                'a_id':id,
                'factor':annotation_factor,
                'detail':annotation_factor_detail,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            }
        });
    }

    function getAnnotationFactorGroup(){
        annotationFactorObject=''
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:getAnnotationFactorGroup" %}', // this is the mapping between the url and view
            data: {
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                annotationFactorObject =  response.factor
            }
        });
    }

    function deleteAnnotation(){
        str = $('.StudyID').map(function(){return $(this).text()+'_'+$(this).nextAll('.SeriesID').text()}).get()
        Study_Date = $('.StudyDate').map(function(){return $(this).text()}).get()
        let SD=$("[name='location']:checked").next('label').children('.LocalSeriesID').text()
        let Date=$("[name='location']:checked").next('label').children('.LocalStudyDate').text()
        let StudyID=$("[name='location']:checked").next('label').children('.LocalStudyID').text()
        let ActualCoordinates=true
        let strAry=($("[name='location']:checked").next('label').children('.info').text())
        let a=strAry.split(',')
        let x=a[0]
        let y=a[1]
        let z=a[2].split('--')[0]

        var id=$('input[name="location"]:checked').next('label').children('.deleteInfo').text();

        $.ajax({
            type: 'post',
            url: '{% url "DICOM:deleteLocation" %}', // this is the mapping between the url and view
            data: {
            'id':id,
            'PID':PID,
            'Disease':$('#Disease').val(),
            'username':JSON.parse(document.getElementById('user_username').textContent),
            'str':str,
            'Study_Date':Study_Date,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success: function(response) {
                $('#textarea').children('tr').remove();
                    for (var i = 0; i < response.PID.length; i++) {
                        $('#textarea').append('<tr><td><input onclick="draw()" type="radio" name="location" id=' + i + '>' +
                            '<label for=' + i + '>' +
                            '<p class="deleteInfo">' + response.id[i] + '</p>' +
                            '<p class="info">' + response.x[i] + ',' + response.y[i] + ',' + response.z[i]+'</p><p class="data">'+response.SUV[i] + '</p>' +
                            '<p class="data1">StudyID:' + response.StudyID[i] +'</p>'+
                            '<p class="data1">SeriesID:' + response.SeriesID[i] +'</p>'+
                            '<p class="data1">' + response.LabelGroup[i] +'</p>'+
                            '<p class="data1">' + response.LabelName[i] +'</p>'+
                            '<p class="data1">' + response.LabelRecord[i] +'</p>'+
                            '<p class="LocalStudyID">' + response.StudyID[i] +'</p>'+
                            '<p class="LocalSeriesID">' + response.SeriesID[i] +'</p>'+
                            '<p class="LocalStudyDate">' + response.SD[i] +'</p>'+
                            '<p class="indices">' + response.indices[i] +'</p>'+
                            '<p class="Dr_confirm">' + response.Dr_confirm[i] +'</p>'+
                            '</label></td></tr>')

                        if (response.indices[i]==0) {
                            if(response.LabelGroup[i]=='Primary tumor'){
                                $('#' + i).next('label').css('background-color', '#BBBBBB')
                            }else{
                                $('#' + i).next('label').css('background-color', '#808F7C')
                            }
                        }else if(response.indices[i]==1) {
                            $('#'+i).next('label').css('background-color','#A8D8B9')
                        }else if(response.indices[i]==2){
                            $('#'+i).next('label').css('background-color','#81C7D4')
                        }else if(response.indices[i]==3){
                            $('#'+i).next('label').css('background-color','#808F7C')
                        }
                        if(response.Dr_confirm[i]){
                            $('#' + i).next('label').css('background-color', '#333333')
                            $('#' + i).next('label').children('p').css('color', '#FFFFFF')
                        }
                    }
                $("#location_menu").css('display', 'none')
            },
        });
    }
    
    function editAnnotation(){
        $('#location_menu').css('display','none')
        $('#editAnnotation').css('display','flex')
        $('#annotation_factor_pannel').children('.menublock').remove()
        let target_object = $('input[name="location"]:checked').next('label')
        let a_id = target_object.children('.deleteInfo').text()
        $('#annotation_basic_info').empty()
        $('#annotation_basic_info').append('<p id="a_id">'+a_id+'</p>')
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:getAnnotationFactor" %}', // this is the mapping between the url and view
            data: {
                'a_id':a_id,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                
                let object_str = ''
                for(var j=0; j<target_object.children('.data1').length-1; j++){
                    object_str += '<div >'+target_object.children('.data1').eq(j).text()+'</div>'
                }
                object_str += '<div > SUV:'+target_object.children('.data').text()+'</div>'
                
                $('#annotation_basic_info').append(object_str)
                for(var i=0; i<response.f_id.length; i++){
                    addMenuCustom($('#annotation_factor_pannel').children('.addButton'),response.f_id[i])
                    $('#annotation_detail_f_id_'+response.f_id[i]).children('.factor').val(response.factor[i])
                    $('#annotation_detail_f_id_'+response.f_id[i]).children('.detail').val(response.detail[i])
                }
                $('#DrConfirm').prop('checked',response.dr_confirm)
            }
        });
    }

    function deleteAnnotationFactor(){
        $(event.target).parent('.menublock').remove()
    }

    function editAnnotationSubmit(){
        
        $('#editAnnotation').css('display','none')
        let a_id = $('#annotation_basic_info').children('#a_id').text()
        let doctor_confirm = Number($('#DrConfirm').is(':checked'))
        updateDrConfirm(a_id,doctor_confirm)
        insertAnnotationFactor(a_id)
        selectLocation()
    }

    function updateDrConfirm(id,doctor_confirm){
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:updateDrConfirm" %}', // this is the mapping between the url and view
            data: {
                'id':id,
                'doctor_confirm':doctor_confirm,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function(response){
                $('#DrConfirm').prop('checked',false)
            }
        });
    }

    $(document).ready(function (e) {
        getAnnotationFactorGroup()
        if('{{de_identification}}'=='True'){
            $('.PID').css('display','none')
        }
        PID=$('#PIDText').text()
        MedExecTime=$('#MedExecTimeText').text()
        Item=$('#ItemText').text().replaceAll(' ','')
        StudyIDText=$('#StudyIDText').text()
        SeriesIDText=$('#SeriesIDText').text()
        SeriesDesText=$('#SeriesDesText').text()
        getuser()
        $(document).keydown(function(event) {
            if (event.ctrlKey==true && (event.which == '61' || event.which == '107' || event.which == '173' || event.which == '109'  || event.which == '187'  || event.which == '189'  ) ) {
                    event.preventDefault();
                }
        });
        
        $(window).bind('mousewheel DOMMouseScroll', function(event) {
            if (event.ctrlKey == true) {
                event.preventDefault();
            }
        });
        $('#defaultMenuBlock').get(0).oncontextmenu = function() {
              return false
        };
        
        $('[data-toggle="popover"]').popover();
        $.ajax({
            type: 'post',
            url: '{% url "confirm:Disease" %}', // this is the mapping between the url and view
            data:{
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                for(var i=0;i<response.DiseaseNo.length;i++){
                    $('#Disease').append('' +
                        '<option value="'+response.DiseaseNo[i]+'">'+response.Disease[i]+'</option>'+
                        '')
                }
            },
            complete:function(){

                $('#Disease').val($('#DiseaseText').text()).prop('selected',true)
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:PatientImageInfo" %}', // this is the mapping between the url and view
                    data:{
                        'PID':PID,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success:function (response){

                        for(var i=0;i<response.ExecDate.length;i++){
                            
                            if(PID+response.ExecDate[i]+response.StudyID[i]+response.SeriesID[i]==PID+MedExecTime+StudyIDText+SeriesIDText){
                                check='checked'
                                $("#frame1").children("label").children('div').children('div').children('.SeriesID').text(response.SeriesID[i])
                            }else{
                                check=''
                            }
                            $('#ImageReport').append('' +
                                '<tr>' +
                                    '<td>' +
                                        '<div class="container">' +
                                            '<div class="row row1" style="text-align: center;margin-bottom: -1px;margin-left: -5px;margin-right: -5px;font-weight: bold;color: whitesmoke;background-color: lightslategray">' +
                                                '<div class="col-3">檢查日期</div>'+
                                                '<div class="col">項目</div>'+
                                                '<div class="col">StudyID</div>'+
                                                '<div class="col">SeriesID</div>'+
                                                '<div class="col">note</div>'+
                                                '<div class="col">張數</div>'+
                                            '</div>'+
                                            '<div class="row row2" style="margin-left: -5px;margin-right: -5px;font-weight: bold;color: whitesmoke;background-color: lightslategray">' +
                                                '<div class="col-3 ImageExecDate">'+response.ExecDate[i]+'</div>'+
                                                '<div class="col ImageStudyDes">'+response.StudyDes[i]+'</div>'+
                                                '<div class="col ImageStudyID">'+response.StudyID[i]+'</div>'+
                                                '<div class="col ImageSeriesID">'+response.SeriesID[i]+'</div>'+
                                                '<div class="col ImageSeriesDes" style="display:none">'+response.SeriesDes[i]+'</div>'+
                                                '<div class="col Imagenote">'+response.note[i]+'</div>'+
                                                '<div class="col ImageSliceNo">'+response.SliceNo[i]+'</div>'+
                                            '</div>'+
                                            '<div class="row row3" >' +
                                                '<div class="col"><p class="window">window1</p></div>'+
                                                '<div class="col"><p class="window">window2</p></div>'+
                                                '<div class="col"><p class="window">window3</p></div>'+
                                                '<div class="col"><p class="window">window4</p></div>'+
                                            '</div>'+
                                            '<div class="row row4" >' +
                                                '<div class="col"><div class="form-check form-switch"><input class="form-check-input" onchange="window_load()" style="display: inline;" type="radio" name="1" '+check+'></div></div>'+
                                                '<div class="col"><div class="form-check form-switch"><input class="form-check-input" onchange="window_load()" style="display: inline;" type="radio" name="2" ></div></div>'+
                                                '<div class="col"><div class="form-check form-switch"><input class="form-check-input" onchange="window_load()" style="display: inline;" type="radio" name="3" ></div></div>'+
                                                '<div class="col"><div class="form-check form-switch"><input class="form-check-input" onchange="window_load()" style="display: inline;" type="radio" name="4" ></div></div>'+
                                            '</div>'+
                                        '</div>'+
                                    '</td>'+
                                '</tr>')
                        }


                        if($('#select').val()==1){
                            $('input[name="2"]').prop('disabled',true)
                            $('input[name="3"]').prop('disabled',true)
                            $('input[name="4"]').prop('disabled',true)
                        }else if($('#select').val()==2){
                            $('input[name="2"]').prop('disabled',false)
                            $('input[name="3"]').prop('disabled',true)
                            $('input[name="4"]').prop('disabled',true)
                        }else if($('#select').val()==4){
                            $('input[name="2"]').prop('disabled',false)
                            $('input[name="3"]').prop('disabled',false)
                            $('input[name="4"]').prop('disabled',false)
                        }
                    }
                })
        
                if(Item=='PET'){
                    loadDICOMurlname="{% url 'DICOM:load_DICOM' %}"
                    $('#Mode').val('Fusion')
                    $("#frame1").children('label').children('div').children('div').children('.mode').text('Fusion')
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax').text(true)
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax_disable').text(false)
                }else if(Item=='CT'){
                    loadDICOMurlname="{% url 'DICOM:load_CT_DICOM' %}"
                    $('#Mode').val('CT')
                    $("#frame1").children('label').children('div').children('div').children('.mode').text('CT')
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax').text(false)
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax_disable').text(true)
                }else if(Item=='RTPLAN') {
                    loadDICOMurlname="{% url 'DICOM:load_RT_DICOM' %}"
                    $('#Mode').val('CT')
                    $("#frame1").children('label').children('div').children('div').children('.mode').text('CT')
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax').text(false)
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax_disable').text(true)
                }else if(Item=='LDCT'){
                    loadDICOMurlname="{% url 'DICOM:load_CT_DICOM' %}"
                    $('#Mode').val('CT')
                    $("#frame1").children('label').children('div').children('div').children('.mode').text('CT')
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax').text(false)
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax_disable').text(true)
                }else if(Item=='MRI'){
                    loadDICOMurlname="{% url 'DICOM:load_MRI_DICOM' %}"
                    $('#Mode').val('CT')
                    $("#frame1").children('label').children('div').children('div').children('.mode').text('MRI')
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax').text(false)
                    $('#frame1').children('label').children('div').children('div').children('.LocalMax_disable').text(true)
                }
                $('#frame1').children('label').children('div').children('div').children('.StudyDes').text(Item)
                root='D:'
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:TextReport" %}', // this is the mapping between the url and view
                    data: {
                        'PID': PID,
                        'image_type':Item,
                    },
                    success: function (response) {
                        $('#textReport').children('tr').remove();
                        
                        for (var i = 0; i < response.examItem.length; i++) {
                            if(response.sn[i]==response.idx) {
                                $('#T1').text(response.examDate[i]+'\n'+'\n'+response.examReport[i])
        
                                $('#textReport').append(
                                    '<tr><td>' +
                                    '<label for=r' + i + '>' +
                                    '<p class="examItem">' + response.examItem[i] + '</p>' +
                                    '<p class="examDate">' + response.examDate[i] + '</p>' +
                                    '<p class="examReport">' + response.examReport[i] + '</p>' +
                                    '</label>' +
                                    '<input checked type="checkbox" onclick="showReport()" name="Report" id=r' + i + '>' +
                                    '</td></tr>'
                                )
                            }else{
                                $('#textReport').append(
                                    '<tr><td>' +
                                    '<label for=r' + i + '>' +
                                    '<p class="examItem">' + response.examItem[i] + '</p>' +
                                    '<p class="examDate">' + response.examDate[i] + '</p>' +
                                    '<p class="examReport">' + response.examReport[i] + '</p>' +
                                    '</label>' +
                                    '<input  type="checkbox" onclick="showReport()" name="Report" id=r' + i + '>' +
                                    '</td></tr>'
                                )
                            }
                        }
                    },
                    complete:function (){
                        $.ajax({
                            type: 'post',
                            url: loadDICOMurlname, // this is the mapping between the url and view
                            data:{
                                'StudyDes':Item,
                                'WindowNo':1,
                                'root':root,
                                'PID':PID,
                                'MedExecTime':MedExecTime,
                                'StudyIDText':StudyIDText,
                                'SeriesIDText':SeriesIDText,
                                'csrfmiddlewaretoken': window.CSRF_TOKEN
                            },
                            success:function (response){
                                if(Item=='MRI'){
                                    $('#MRIWC').val(response.MRIWC[0])
                                    $('#MRIWW').val(response.MRIWW[0])
                                    $("#frame1").children('label').children('div').children('div').children('.MRIWC').text(response.MRIWC.toString())
                                    $("#frame1").children('label').children('div').children('div').children('.MRIWW').text(response.MRIWW.toString())
                                    $("#frame1").children('label').children('div').children('div').children('.WC').text('WC: '+response.MRIWC[0])
                                    $("#frame1").children('label').children('div').children('div').children('.WW').text('WC: '+response.MRIWW[0])
                                }
                                $('#frame1').children('label').children('div').children('div').children('.StudyID').text(
                                    $('input[name="1"]:checked').parents('.col').parents('.row4').prevAll('.row2').children('.ImageStudyID').html()
                                )
                                
                                $('#frame1').children('label').children('div').children('div').children('.SeriesID').text(
                                    $('input[name="1"]:checked').parents('.col').parents('.row4').prevAll('.row2').children('.ImageSeriesID').html()
                                )
                                $('#frame1').children('label').children('.main').children('div').children('.StudyDate').text(MedExecTime)

                                $('#frame1').children('label').children('.main').children('div').children('.SeriesDes').text(SeriesDesText)
                                //alert($("#frame1").children('label').children('div').children('div').children('.StudyDate').text()+$("#frame1").children('label').children('div').children('div').children('.StudyID').text()+$("#frame1").children('label').children('div').children('div').children('.SeriesID').text())
                                $.ajax({
                                    type: 'post',
                                    url: '{% url "DICOM:DICOM_show1" %}', // this is the mapping between the url and view
                                    data: {
                                        'variable': 0, // ! here is the magic, your variable gets transmitted to the server
                                        'CTWC':$("#frame1").children('label').children('div').children('div').children('.CTWC').text(),
                                        'CTWW':$("#frame1").children('label').children('div').children('div').children('.CTWW').text(),
                                        'PETWC':$("#frame1").children('label').children('div').children('div').children('.PETWC').text(),
                                        'PETWW':$("#frame1").children('label').children('div').children('div').children('.PETWW').text(),
                                        'MRIWC':JSON.parse("[" + $("#frame1").children('label').children('div').children('div').children('.MRIWC').text() + "]")[0],
                                        'MRIWW':JSON.parse("[" + $("#frame1").children('label').children('div').children('div').children('.MRIWW').text() + "]")[0],
                                        'plane':$("#frame1").children('label').children('div').children('div').children('.plane').text(),
                                        'mode':$("#frame1").children('label').children('div').children('div').children('.mode').text(),
                                        'source':$("#frame1").children('label').children('div').children('div').children('.StudyDate').text()+$("#frame1").children('label').children('div').children('div').children('.StudyID').text()+$("#frame1").children('label').children('div').children('div').children('.SeriesID').text(),
                                        'target':$("#frame1").children('label').children('div').children('div').children('.StudyDate').text()+$("#frame1").children('label').children('div').children('div').children('.StudyID').text()+$("#frame1").children('label').children('div').children('div').children('.SeriesID').text(),
                                        'source_variable':$("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                                        'x': 0,
                                        'y': 0,
                                        'height':$("#frame1").children("label").children('div').children('div').children('img').height(),
                                        'width':$("#frame1").children("label").children('div').children('div').children('img').width(),
                                        'ActualCoordinates':true,
                                        'drawActualCoordinates':true,
                                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                                    },
                                    success:function (response){
                                        
                                        $('#Topcheckbox').prop('disabled',false)
                                        $("#frame1").children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                                        $("#frame2").children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                                        $("#frame3").children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                                        $("#frame4").children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                                        $("#frame1").children("label").children('div').children('div').children('img').css('display','inline-block');
                                        $("#frame1").children("label").children('div').children('div').children('img').css('display','inline-block');
                                        $("#frame1").children("label").children('.slider').css('display','inline-block');
                                        
                                        z=response.z
                                        $('.slider').children('div').css('height',z*100+'%')    

                                        $('#CT-PET').css('margin-top','60px')
                                        $("#frame1").children('label').children('div').children('div').children('.variable').text(1+'/'+z)

                                        //$('#frame1').children('label').children('div').children('div').children('.img').css('height',Math.round($('#frame1').height())+'px');
                                        ActualCoordinates=false
                                        scrolling1=true
                                        $('#CT-PET').css('height', $(window).height()-60)
                                        $('.slider').css('height',$('#frame1').height())
                                        //('.img').css('height',$(window).height()-60)

                                        
                                        
                                        $('#frame1').children('label').children('.main').children('div').children('.thickness').text(response.thickness+'mm')
                                        selectLocation()
                                        $('#RT_Contour').empty()
                                        
                                        if(Item=='RTPLAN'){
                                            $.ajax({
                                                type: 'post',
                                                url: '{% url "DICOM:ROIname" %}', // this is the mapping between the url and view
                                                data: {
                                                    'WindowNo': 1, // ! here is the magic, your variable gets transmitted to the server
                                                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                                                },
                                                success: function(response) {
                                                    $('#RT_Contour').empty()
        
                                                    for(var i =0;i<response.ROIname.length;i++) {
                                                        
                                                        $('#RT_Contour').append('' +
                                                            '<div class="form-check form-switch">' +
                                                                '<input class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="'+response.ROIname[i]+'">' +
                                                                '<label class="form-check-label" for="'+response.ROIname[i]+'">' + response.ROIname[i] + '</label>' +
                                                                '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb('+response.color[i]+')"></div>' +
                                                            '</div>' +
                                                        '')
                                                    }
                                                }
                                            });
                                        }
                                    },
                                    complete:function(){
                                        $.ajax({
                                            type: 'post',
                                            url: '{% url "DICOM:cancer" %}', // this is the mapping between the url and view
                                            data: {
                                                'csrfmiddlewaretoken': window.CSRF_TOKEN
                                            },
                                            success: function(response) {
                                                for (var i = 0; i < response.DiseaseNo.length; i++) {
                                                    $('#cancer').append('<option data-id='+response.DiseaseNo[i]+'>'+response.Disease[i]+'</option>>')
                                                }
                                            },
                                            complete:function(){
                                                selection()
                                                mouseover()
                                                let window_sno = $("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()
                                                functionAjax=[ajax1(),ajax2(),ajax3(),ajax4()]
                                                functionAjax[window_sno]
                                                $('.loader').css('display','none')
                                            }                                                
                                            
                                        })
                                    }
                                });
                            }
                        });
                    }
                });
                
            }
        })
        
        $('#cancer').on('change',function (){
            if($(this).find(':selected').attr('data-id')!=0){
            $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:LabelGroup" %}', // this is the mapping between the url and view
                    data: {
                        'SubjectID': $(this).find(':selected').attr('data-id') ,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function(response) {
                        $('#LabelGroup').children('option').remove()
                        $('#LabelName').children('option').remove()
                        $('#LabelGroup').append('<option data-id=0>輸入病灶</option>>')
                        $('#LabelName').append('<option>輸入病灶</option>>')
                        for (var i = 0; i < response.GroupID.length; i++) {
                            $('#LabelGroup').append('<option data-id='+response.GroupID[i]+'>'+response.LabelGroup[i]+'</option>>')
                        }
                        
                    },
                });
            }else{
                $('#LabelName').children('option').remove()
                $('#LabelGroup').append('<option>輸入病灶</option>>')
                $('#LabelName').append('<option>輸入病灶</option>>')
            }
        })        

        $('#LabelGroup').on('change',function (){
            if($(this).find(':selected').attr('data-id')!=0){
            $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:LabelName" %}', // this is the mapping between the url and view
                    data: {
                        'SubjectID': $('#cancer').find(':selected').attr('data-id') ,
                        'LabelGroup': $(this).find(':selected').attr('data-id') ,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function(response) {
                        $('#LabelName').children('option').remove()
                        for (var i = 0; i < response.LabelName.length; i++) {
                            $('#LabelName').append('<option>'+response.LabelName[i]+'</option>>')
                        }
                    },
                });
            }else{
                $('#LabelName').children('option').remove()
                $('#LabelName').append('<option>輸入病灶</option>>')
            }
        })

//-------------------------------定位功能------------------------------------


        $(function(){
            var _move=false
            $("#frame1").children("label").children('div').children('div').children('img').mousedown(function (e){
                if(e.which == 1) {
                    _move = true
                    $('input[name="location"]:checked').prop('checked', false)
                    ActualCoordinates = false
                    $('#tumor').css('display', 'none')
                    $("#image_menu").css('display', 'none');
                    var scale_rate = parseFloat($("#frame1").children("label").children('div').children('div').children('.Scale_rate').text())
                    var posX = $(this).position().left
                    if($(this).css('margin-top').slice(0,-2)==0){
                        var posY = $(this).position().top
                    }else{
                        var posY = parseFloat($(this).css('margin-top').slice(0,-2))+$(this).position().top;
                    }
                    x = Math.floor((e.pageX - posX - $(this).parents().parents().parents().parents().position().left -
                        $(this).parents().parents().parents().parents().css('border-left').slice(0, 1)
                    )/scale_rate)
                    y = Math.floor((e.pageY - posY - $(this).parents().parents().parents().parents().position().top -
                        $(this).parents().parents().parents().parents().css('border-top').slice(0, 1)
                    )/scale_rate)

                    var height = Math.floor($("#frame2").children("label").children('.slider').height());
                    var b = $("#frame1").children("label").children('.slider').scrollTop();
                    var count = Math.floor(b / height);

                    locationCompute(1, x, y, count)

                }
            })
        })
        $(function(){
            var _move=false
            $("#frame2").children("label").children('div').children('div').children('img').mousedown(function (e){
                if(e.which == 1) {
                    _move = true
                    $('input[name="location"]:checked').prop('checked', false)
                    ActualCoordinates = false
                    $('#tumor').css('display', 'none')
                    $("#image_menu").css('display', 'none');
                    var scale_rate = parseFloat($("#frame2").children("label").children('div').children('div').children('.Scale_rate').text())
                    
                    var posX = $(this).position().left
                    if($(this).css('margin-top').slice(0,-2)==0){
                        var posY = $(this).position().top
                    }else{
                        var posY = parseFloat($(this).css('margin-top').slice(0,-2))+$(this).position().top;
                    }

                    x = Math.floor((e.pageX - posX - $(this).parents().parents().parents().parents().position().left -
                        $(this).parents().parents().parents().parents().css('border-left').slice(0, 1)
                    )/scale_rate)
                    y = Math.floor((e.pageY - posY - $(this).parents().parents().parents().parents().position().top -
                        $(this).parents().parents().parents().parents().css('border-top').slice(0, 1)
                    )/scale_rate)
                    var height = Math.floor($("#frame2").children("label").children('.slider').height());
                    var b = $("#frame2").children("label").children('.slider').scrollTop();
                    var count = Math.floor(b / height);

                    //var count = $("#frame2").children("label").children('div').children('div').children('.z').text()
                    locationCompute(2, x, y, count)

                }
            })
        })

        $(function(){
            $("#frame3").children("label").children('div').children('div').children('img').mousedown(function (e){
                if(e.which == 1) {
                    ActualCoordinates = false
                    $('input[name="location"]:checked').prop('checked', false)
                    $("#image_menu").css('display', 'none');
                    $('#tumor').css('display', 'none')
                    var scale_rate = parseFloat($("#frame3").children("label").children('div').children('div').children('.Scale_rate').text())
                    var posX = $(this).position().left
                    if($(this).css('margin-top').slice(0,-2)==0){
                        var posY = $(this).position().top
                    }else{
                        var posY = parseFloat($(this).css('margin-top').slice(0,-2))+$(this).position().top;
                    }
                    x = Math.floor((e.pageX - posX - $(this).parents().parents().parents().parents().position().left -
                        $(this).parents().parents().parents().parents().css('border-left').slice(0, 1)
                    )/scale_rate)
                    y = Math.floor((e.pageY - posY - $(this).parents().parents().parents().parents().position().top -
                        $(this).parents().parents().parents().parents().css('border-top').slice(0, 1)
                    )/scale_rate)
                    $("#frame3").children("label").children('div').children('div').children('.x').text(x)
                    $("#frame3").children("label").children('div').children('div').children('.y').text(y)
                    var height = Math.floor($("#frame2").children("label").children('.slider').height());
                    var b = $("#frame3").children("label").children('.slider').scrollTop();
                    //var count = Math.round(b / height);


                    var count = Math.floor(b / height);
                    //ajax(3,x,y,count,false)
                    locationCompute(3, x, y, count)
                }
            })
        })

        $(function(){

            $("#frame4").children("label").children('div').children('div').children('img').mousedown(function (e){
                if(e.which == 1) {
                    ActualCoordinates = false
                    $('input[name="location"]:checked').prop('checked', false)
                    $("#image_menu").css('display', 'none');
                    $('#tumor').css('display', 'none')
                    var scale_rate = parseFloat($("#frame4").children("label").children('div').children('div').children('.Scale_rate').text())
                    var posX = $(this).position().left
                    if($(this).css('margin-top').slice(0,-2)==0){
                        var posY = $(this).position().top
                    }else{
                        var posY = parseFloat($(this).css('margin-top').slice(0,-2))+$(this).position().top;
                    }
                    x = Math.floor((e.pageX - posX - $(this).parents().parents().parents().parents().position().left -
                        $(this).parents().parents().parents().parents().css('border-left').slice(0, 1)
                    )/scale_rate)
                    y = Math.floor((e.pageY - posY - $(this).parents().parents().parents().parents().position().top -
                        $(this).parents().parents().parents().parents().css('border-top').slice(0, 1)
                    )/scale_rate)
                    $("#frame4").children("label").children('div').children('div').children('.x').text(x)
                    $("#frame4").children("label").children('div').children('div').children('.y').text(y)
                    var height = Math.floor($("#frame2").children("label").children('.slider').height());
                    var b = $("#frame4").children("label").children('.slider').scrollTop();
                    //var count = Math.round(b / height);
                    var count = Math.floor(b / height);
                    //ajax(4,x,y,count,false)
                    locationCompute(4, x, y, count)
                }
            })
        })


        $("[name='group1']").next("label").children('div').children('div').children('img').dblclick(function (e) {
            //if ($('#local').is(':checked')) {
            window_number=$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()
            let StudySeries = $("[name='group1']:checked").next("label").children('div').children('div').children('.StudyID').text()+'_'+$("[name='group1']:checked").next("label").children('div').children('div').children('.SeriesID').text()
            if($('#trigger').is(':checked')==true) {
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:findLocalMax" %}', // this is the mapping between the url and view
                    data: {
                        'x':$("[name='group1']:checked").next("label").children('div').children('div').children('.x').text(),
                        'y': $("[name='group1']:checked").next("label").children('div').children('div').children('.y').text(),
                        'z': $("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                        'PETWC': $("[name='group1']:checked").next("label").children('div').children('div').children('.PETWC').text(),
                        'SeriesID':StudySeries,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function (response) {
                        name=$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()

                        $('#SUV_Localmax').children('tr').remove();
                        for (var i = 0; i < response.x.length; i++) {

                            if(i==0){

                                if(response.maxValue[0]>=$('#PETWC').val()) {
                                    $('#SUV_Localmax').append(
                                        '<tr><td>' +
                                        '<input  type="radio" checked onclick="localmaxclick('+name+')" name="localmax" id=S' + i + '>' +
                                        '<label for=S' + i + '>' +
                                        '<p class="Localmax_x">' + response.x[i] + '</p>' +
                                        '<p class="Localmax_y">' + response.y[i] + '</p>' +
                                        '<p class="Localmax_z">' + response.z[i] + '</p>' +
                                        '<p style="display: inline;color: #11171a;width: 106px" class="Localmax_SUV_show">' + Math.round((response.maxValue[i] + Number.EPSILON) * 1000) / 1000 + '</p>' +
                                        '<p style="display: none" class="Localmax_SUV">' + response.maxValue[i] + '</p>' +
                                        '</label>' +
                                        '</td></tr>'
                                    )
                                }else{
                                    $('#SUV_Localmax').append(
                                        '<tr style="display: none"><td>' +
                                        '<input  type="radio" checked onclick="localmaxclick('+name+')" name="localmax" id=S' + i + '>' +
                                        '<label for=S' + i + '>' +
                                        '<p class="Localmax_x">' + response.x[i] + '</p>' +
                                        '<p class="Localmax_y">' + response.y[i] + '</p>' +
                                        '<p class="Localmax_z">' + response.z[i] + '</p>' +
                                        '<p style="display: inline;color: #11171a;width: 106px" class="Localmax_SUV_show">' + Math.round((response.maxValue[i] + Number.EPSILON) * 1000) / 1000 + '</p>' +
                                        '<p style="display: none" class="Localmax_SUV">' + response.maxValue[i] + '</p>' +
                                        '</label>' +
                                        '</td></tr>'
                                    )
                                }
                            }else{
                                $('#SUV_Localmax').append(
                                '<tr><td>' +
                                '<input  type="radio" onclick="localmaxclick('+name+')" name="localmax" id=S' + i + '>' +
                                '<label for=S' + i + '>' +
                                '<p class="Localmax_x">' + response.x[i] + '</p>' +
                                '<p class="Localmax_y">' + response.y[i] + '</p>' +
                                '<p class="Localmax_z">' + response.z[i] + '</p>' +
                                '<p style="display: inline;color: #11171a;width: 106px" class="Localmax_SUV_show">' + Math.round((response.maxValue[i]+Number.EPSILON)*1000)/1000 + '</p>' +
                                '<p style="display: none" class="Localmax_SUV">' + response.maxValue[i] + '</p>' +
                                '</label>' +
                                '</td></tr>'
                                )
                            }

                        }
                        var lx=$('input[name="localmax"]:checked').next('label').children('.Localmax_x').text()
                        var ly=$('input[name="localmax"]:checked').next('label').children('.Localmax_y').text()
                        var lz=$('input[name="localmax"]:checked').next('label').children('.Localmax_z').text()
                        var lsuv=$('input[name="localmax"]:checked').next('label').children('.Localmax_SUV').text()
                        var Con = $('.StudyDate').map(function(){return $(this).text()+'_'+$(this).prevAll('.StudyID').text()+'_'+$(this).prevAll('.SeriesID').text()}).get()

                        for(var i =0;i<4;i++) {
                            if(Con[i]==Con[name-1]){
                                var ind=i+1
                                $('#frame'+ind).children('label').children('div').children('div').children('.x').text(lx)
                                $('#frame'+ind).children('label').children('div').children('div').children('.y').text(ly)
                                $('#frame'+ind).children('label').children('div').children('div').children('.z').text(lz)
                                $('#frame'+ind).children('label').children('div').children('div').children('.SUV').val(lsuv)
                            }
                        }

                        DrawWithMouse(lx,ly,lz,name)

                        elementClicked = 'False'

                        if (elementClicked == 'False') {
                            if(e.pageY>($('#CT-PET').height()/2)){
                                $('#tumor').css('display', 'inline')
                                $('#tumor').css('height', 185+$('#SUV_Localmax').parents().height()+15)
                                $('#tumor').css('top', e.pageY-$('#tumor').height())
                                $('#tumor').css('left', e.pageX+50)
                            }else {
                                $('#tumor').css('display', 'inline')
                                $('#tumor').css('height', 185+$('#SUV_Localmax').parents().height()+15)
                                $('#tumor').css('top', e.pageY)
                                $('#tumor').css('left', e.pageX+50)
                            }
                        }
                    },
                });
            }else{
                $('#SUV_Localmax').children('tr').remove();
                elementClicked = 'False'
                if (elementClicked == 'False') {
                    if(e.pageY>($('#CT-PET').height()/2)){
                        $('#tumor').css('display', 'inline')
                        $('#tumor').css('height', 185+$('#SUV_Localmax').parents().height()+15)
                        $('#tumor').css('top', e.pageY-$('#tumor').height())
                        $('#tumor').css('left', e.pageX+50)
                    }else {
                        $('#tumor').css('display', 'inline')
                        $('#tumor').css('height', 185+$('#SUV_Localmax').parents().height()+15)
                        $('#tumor').css('top', e.pageY)
                        $('#tumor').css('left', e.pageX+50)
                    }
                }
                let StudySeries = $("[name='group1']:checked").next("label").children('div').children('div').children('.StudyID').text()+'_'+$("[name='group1']:checked").next("label").children('div').children('div').children('.SeriesID').text()
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:findSUV" %}', // this is the mapping between the url and view
                    data: {
                        'x':$("[name='group1']:checked").next("label").children('div').children('div').children('.x').text(),
                        'y': $("[name='group1']:checked").next("label").children('div').children('div').children('.y').text(),
                        'z': $("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                        'SeriesID':StudySeries,
                        'isNotPET':$('#LocalMax').children('input').is(':disabled'),
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function (response) {
                        $('.SUV').val(response.SUV)
                    },
                });
            }
            $("#tumor").mousedown(function () {
                elementClicked = 'True'
            })
            $("[name='group1']").next("label").children('div').children('div').children('img').mousedown(function () {
                //if ($('#local').is(':checked')) {
                    elementClicked = 'False'
                //}
            })


            //}
        });

        $('#frame1').on('mousedown',function (e){
            $(this).children('input').prop('checked',true)
            mouseover()
            $('#tumor').css('display', 'none');
            $('#tumor').children('#factor').children('.menublock').remove()
            if(e.which==3){
                right_function(e)
            }else if(e.which==1){
                $("#image_menu").css('display', 'none');
            }
        })
        $('#frame2').on('mousedown',function (e){
            $(this).children('input').prop('checked',true)
            mouseover()
            $('#tumor').css('display', 'none');
            $('#tumor').children('#factor').children('.menublock').remove()
            if(e.which==3){
                right_function(e)
            }else if(e.which==1){
                $("#image_menu").css('display', 'none');
            }
        })
        $('#frame3').on('mousedown',function (e){
            $(this).children('input').prop('checked',true)
            mouseover()
            $('#tumor').css('display', 'none');
            $('#tumor').children('#factor').children('.menublock').remove()
            if(e.which==3){
                right_function(e)
            }else if(e.which==1){
                $("#image_menu").css('display', 'none');
            }
        })
        $('#frame4').on('mousedown',function (e){
            $(this).children('input').prop('checked',true)
            mouseover()
            $("#tumor").css('display', 'none');
            $('#tumor').children('#factor').children('.menublock').remove()
            if(e.which==3){
                right_function(e)
            }else if(e.which==1){
                $("#image_menu").css('display', 'none');
            }
        })

        $('#Disease').on('change',function(){
            selectLocation()
        })
        $('#users').on('change',function(){
            selectLocation()
        })

        $('#textarea').on('mousedown','td',function(d){
            $(this).children('input[type="radio"]').prop('checked',true)
            draw()
            if(d.which == 3){  // 1 = 滑鼠左鍵; 2 = 滑鼠中鍵; 3 = 滑鼠右鍵
                if($('input[name="location"]').is(':checked')==true) {
                    var x = d.originalEvent.x || d.originalEvent.layerX || 0;
                    var y = d.originalEvent.y || d.originalEvent.layerY || 0;
                    $("#location_menu").css('display', 'inline');
                    $("#location_menu").css('left', x);
                    $("#location_menu").css('top', y);
                }
            }
        })
        
        $('#CT-PET').mousedown(function(e){
            if(e.which == 1) {
                $("#location_menu").css('display', 'none');

            }
        })
        $('textarea').mousedown(function(e){
            if(e.which == 1) {
                $("#location_menu").css('display', 'none');
                $("#image_menu").css('display', 'none');

            }
        })
        $('.localizationform').mousedown(function(e){
            if(e.which == 1) {
                $("#location_menu").css('display', 'none');
                $("#image_menu").css('display', 'none');
                $("#tumor").css('display', 'none');
                $('#tumor').children('#factor').children('.menublock').remove()
            }
        })

        
        $('body').keydown(function(event){
            if($('#tumor').css('display')=='none'){
                switch (event.keyCode){
                    case 35://End鍵
                        $("[name='group1']:checked").next("label").children('.slider').scrollTop($("[name='group1']:checked").next("label").children('.slider').children().height());
                        break;
                    case 36://Home鍵
                        $("[name='group1']:checked").next("label").children('.slider').scrollTop(0);
                        break;
                    case 45://Insert鍵 (中間圖像)
                        $("[name='group1']:checked").next("label").children('.slider').scrollTop($("[name='group1']:checked").next("label").children('.slider').children().height()/2);
                        break;
                    case 33://PgUp鍵 (放大圖像)
                        var scale_rate = parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text())+0.1
                        $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
                        $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(scale_rate)
                        break;
                    case 34://PgDn鍵 (縮小圖像)
                        var scale_rate = parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text())-0.1
                        $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
                        $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(scale_rate)
                        break;
                    case 37://圖像左移
                        img_x=parseFloat($("[name='group1']:checked").next("label").children('div').children('div').css('margin-left').slice(0,-2))
                        $("[name='group1']:checked").next("label").children('div').children('div').css('margin-left',img_x-5)

                        break;
                    case 38://圖像上移
                        img_y=parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin-top').slice(0,-2))
                        $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin-top',img_y-5)
                        break;
                    case 39://圖像右移
                        img_x=parseFloat($("[name='group1']:checked").next("label").children('div').children('div').css('margin-left').slice(0,-2))
                        $("[name='group1']:checked").next("label").children('div').children('div').css('margin-left',img_x+5)
                        break;
                    case 40://圖像下移
                        img_y=parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin-top').slice(0,-2))
                        $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin-top',img_y+5)
                        break;
                    case 81:
                        if(event.ctrlKey){
                            $('#Topcheckbox').trigger( "click" )
                        }else if(event.shiftKey){
                            $('#Imagecheckbox').trigger( "click" )
                        }
                        break;
                }
            }
        })
        $(window).on('resize', function(){
            //location.reload()
            //$('#CT-PET').css('margin-top','50px')
            $('#CT-PET').css('width',$(window).width()*0.7)
            $('#CT-PET').css('height',0)
            
            selection()
        });

        //-----------------右鍵選單功能---------------------
        $('#reset').on('click',function(){
            var Des=$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDes').text()
            if(Des=='PET'){
                $('#Mode').val('Fusion')
                $('#Mode_menu').val('Fusion').prop('selected',true)
            }else if(Des=='CT'){
                $('#Mode').val('CT')
                $('#Mode_menu').val('CT').prop('selected',true)
            }else if(Des=='RT'){
                $('#Mode').val('CT')
                $('#Mode_menu').val('CT').prop('selected',true)
            }
            $('#viewPlane').val('Axial')
            $('#Plane_menu').val('Axial').prop('selected',true)
            $('#CTWindow').val('45,250').prop('selected',true)
            $('#CTWindow_menu').val('45,250').prop('selected',true)
            $('#PETWC').val(2.5)
            $('#PETWW').val(5)
            selection()
            $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(1)
            var scale_rate=1
            $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
            $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin',0)
            $("[name='group1']:checked").next("label").children('div').children('div').css('margin',0)
            $("#image_menu").css('display', 'none');
        })

        $('#enlarge').on('click',function(){
            var scale_rate = parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text())+0.1
            $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
            $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(scale_rate)
        })
        $('#shrink').on('click',function(){
            var scale_rate = parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text())-0.1
            $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
            $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(scale_rate)
        })

        $('.editAnnotationExit').on('click',function(){
            $('#editAnnotation').css('display','none')
        })
    });
//-------------------------------定位功能------------------------------------
</script>

<body onload="test()">
    <div id="defaultMenuBlock">
        {% include 'navBar.html' %}
        <div id="slideTopout">
            <input type="checkbox" id="Topcheckbox">
            <label for="Topcheckbox" class="Top-label">SETTING</label>
            <form class="Topform">
                <div class ="tool">
                    {% include 'DICOM/Setting.html' %}
                </div>
            </form>
        </div>
        <div id="slideout">
            <input type="checkbox" id="mycheckbox">
            <label for="mycheckbox" class="feedback-label">MENU</label>
            <form class="form sc2">
                <table id="textReport"></table>
            </form>
        </div>

        <div id="ImageSelect">
            <input type="checkbox" id="Imagecheckbox">
            <label for="Imagecheckbox" class="Image-label">IMAGE</label>
            <form class="Imageform sc2">
                <table id="ImageReport">
                </table>

            </form>
        </div>

        <div id="localizationslideout">
            <select class="form-select form-select-sm" aria-label=".form-select-sm example" id="Disease" ></select>
            <select class="form-select form-select-sm" aria-label=".form-select-sm example" id="users" ></select>
            <form class="localizationform sc2">

                    <table id="textarea" >
                        {{ user.username|json_script:"user_username" }}
                    </table>

            </form>

        </div>



        <div id="CT-PET" >
            <div id="frame1" >

                <input type="radio" onclick="bb()" id="a1"  name="group1" value="1" checked>
                <label for="a1" class="test" >

                    <div class="main" onwheel="myFunction(event)" >
                        <div class="loader">
                            <div class="loader-inner square-spin">
                                <div></div>
                            </div><span class="tooltip">
                                <p>square-spin</p></span>
                        </div>
                        <div id="dicom1">

                            <img class="img"  ondragstart="return false;"  />
                            <p class="WW" style="">0</p>
                            <p class="WC" style="">0</p>
                            <p class="CTWC" style="">45</p>
                            <p class="CTWW" style="">250</p>
                            <p class="PETWC" style="">2.5</p>
                            <p class="PETWW" style="">5</p>
                            <p class="MRIWC" >0</p>
                            <p class="MRIWW" >0</p>
                            <p class="plane" style="">Axial</p>
                            <p class="mode" style="">CT</p>
                            <p class="CT_window" >45,250</p>
                            <p class="ratio" style="">0</p>
                            <p class="x" >0</p>
                            <p class="y" >0</p>
                            <p class="z" >0</p>
                            <input type="text" class="SUV" value="0">
                            <p class="series" style="">1</p>
                            <p class="StudyID" style="">-9999</p>
                            <p class="SeriesID" style="">-9999</p>
                            <p class="StudyDes" style="">-9999</p>
                            <p class="StudyDate" style="">-9999</p>
                            <p class="Scale_rate" style="">1</p>
                            <p class="variable" style="">0</p>
                            <p class="thickness" style="">0/0</p>
                            <p class="SeriesDes" style=""></p>
                            <p class="PID" style="">{{ PID }}</p>
                            <p class="LocalMax" style=""></p>
                            <p class="LocalMax_disable" style=""></p>
                        </div>

                    </div>
                    <div class='slider demoScroll sc1 s1'  onscroll="ajax1(event)"  style="border: 1px #000000;margin: 0%;
                    width:20px;overflow-y:scroll" ><div  style="height:2000%" ></div></div>
                </label>
            </div>
            <div id="frame2">

                <input type="radio" onclick="bb()" id="a2" name="group1" value="1" >
                <label for="a2" class="test" >

                    <div class="main" onwheel="myFunction(event)" >
                        <div class="loader">
                            <div class="loader-inner square-spin">
                                <div></div>
                            </div><span class="tooltip">
                                <p>square-spin</p></span>
                        </div>
                        <div id="dicom2">
            <!-- Main jumbotron for a primary marketing message or call to action -->
                            <img class="img" ondragstart="return false;"  />
                            <p class="WW" style="">0</p>
                            <p class="WC" style="">0</p>
                            <p class="CTWC" >45</p>
                            <p class="CTWW" >250</p>
                            <p class="PETWC" >2.5</p>
                            <p class="PETWW" >5</p>
                            <p class="MRIWC" >0</p>
                            <p class="MRIWW" >0</p>
                            <p class="plane" >Axial</p>
                            <p class="mode" >CT</p>
                            <p class="CT_window" >45,250</p>
                            <p class="ratio" style="">0</p>
                            <p class="x" >0</p>
                            <p class="y" >0</p>
                            <p class="z" >0</p>
                            <input type="text" class="SUV" value="0">
                            <p class="series" style="">2</p>
                            <p class="StudyID" style="">-9999</p>
                            <p class="SeriesID" style="">-9999</p>
                            <p class="StudyDes" style="">-9999</p>
                            <p class="StudyDate" style="">-9999</p>
                            <p class="Scale_rate" style="">1</p>
                            <p class="variable" style="">0</p>
                            <p class="thickness" style="">0/0</p>
                            <p class="SeriesDes" style=""></p>
                            <p class="PID" style="">{{ PID }}</p>
                            <p class="LocalMax" style=""></p>
                            <p class="LocalMax_disable" style=""></p>
                        </div>
                    </div>
                    <div class='slider demoScroll sc1 s2'  onscroll="ajax2(event)" style="border: 1px #000000;margin: 0%;
                    width:20px;overflow-y:scroll" ><div  style="height:2000%" ></div></div>

                </label>
            </div>
            <div id="frame3" >

                <input type="radio" onclick="bb()" id="a3" name="group1" value="1" >
                <label for="a3" class="test" >

                    <div class="main" onwheel="myFunction(event)" >
                        <div class="loader">
                            <div class="loader-inner square-spin">
                                <div></div>
                            </div><span class="tooltip">
                                <p>square-spin</p></span>
                        </div>
                        <div id="dicom3" >
            <!-- Main jumbotron for a primary marketing message or call to action -->
                            <img class="img" ondragstart="return false;"  />
                            <p class="WW" style="">0</p>
                            <p class="WC" style="">0</p>
                            <p class="CTWC" >45</p>
                            <p class="CTWW" >250</p>
                            <p class="PETWC" >2.5</p>
                            <p class="PETWW" >5</p>
                            <p class="MRIWC" >0</p>
                            <p class="MRIWW" >0</p>
                            <p class="plane" >Axial</p>
                            <p class="mode" >CT</p>
                            <p class="CT_window" >45,250</p>
                            <p class="ratio" style="">0</p>
                            <p class="x" >0</p>
                            <p class="y" >0</p>
                            <p class="z" >0</p>
                            <input type="text" class="SUV" value="0">
                            <p class="series" style="">3</p>
                            <p class="StudyID" style="">-9999</p>
                            <p class="SeriesID" style="">-9999</p>
                            <p class="StudyDes" style="">-9999</p>
                            <p class="StudyDate" style="">-9999</p>
                            <p class="Scale_rate" style="">1</p>
                            <p class="variable" style="">0</p>
                            <p class="thickness" style="">0/0</p>
                            <p class="SeriesDes" style=""></p>
                            <p class="PID" style="">{{ PID }}</p>
                            <p class="LocalMax" style=""></p>
                            <p class="LocalMax_disable" style=""></p>
                        </div>
                    </div>
                    <div class='slider demoScroll sc1 s3'  onscroll="ajax3(event)" style="border: 1px #000000;margin: 0%;
                    width:20px;overflow-y:scroll" ><div  style="height:2000%" ></div></div>

                </label>
            </div>
            <div id="frame4" >
                <input type="radio" onclick="bb()" id="a4" name="group1" value="1" >
                <label for="a4" class="test" >

                    <div class="main" onwheel="myFunction(event)" >
                        <div class="loader">
                            <div class="loader-inner square-spin">
                                <div></div>
                            </div><span class="tooltip">
                                <p>square-spin</p></span>
                        </div>
                        <div id="dicom4">
                            <img class="img" ondragstart="return false;" />
                            <p class="WW" style="">0</p>
                            <p class="WC" style="">0</p>
                            <p class="CTWC" >45</p>
                            <p class="CTWW" >250</p>
                            <p class="PETWC" >2.5</p>
                            <p class="PETWW" >5</p>
                            <p class="MRIWC" >0</p>
                            <p class="MRIWW" >0</p>
                            <p class="plane" >Axial</p>
                            <p class="mode" >CT</p>
                            <p class="CT_window" >45,250</p>
                            <p class="ratio" style="">0</p>
                            <p class="x" >0</p>
                            <p class="y" >0</p>
                            <p class="z" >0</p>
                            <input type="text" class="SUV" value="0">
                            <p class="series" style="">4</p>
                            <p class="StudyID" style="">-9999</p>
                            <p class="SeriesID" style="">-9999</p>
                            <p class="StudyDes" style="">-9999</p>
                            <p class="StudyDate" style="">-9999</p>
                            <p class="Scale_rate" style="">1</p>
                            <p class="variable" style="">0</p>
                            <p class="thickness" style="">0/0</p>
                            <p class="SeriesDes" style=""></p>
                            <p class="PID" style="">{{ PID }}</p>
                            <p class="LocalMax" style=""></p>
                            <p class="LocalMax_disable" style=""></p>
                        </div>
                    </div>
                    <div class='slider demoScroll sc1 s4'  onscroll="ajax4(event)" style="border: 1px #000000;margin: 0%;
                width:20px;overflow-y:scroll" ><div  style="height:2000%" ></div></div>

                </label>
            </div>


        </div>

        <div  id="tumor" >
            <div id="basic">
                <select id="cancer" style="width: 100%;" class="form-select form-select-sm" aria-label=".form-select-sm example"><option data-id="0">輸入癌別</option></select>
                <select id="LabelGroup" style="width: 100%;" class="form-select form-select-sm" aria-label=".form-select-sm example"><option data-id="0">輸入病灶</option></select>
                <select id="LabelName" style="width: 100%;" class="form-select form-select-sm" aria-label=".form-select-sm example"><option>輸入病灶</option></select>
                <input type="text"  id="LabelRecord" placeholder="病灶註解">
                <div style="border:1px solid #DDDDDD;border-radius:5px;margin-bottom: 5px;margin-left: 2px;margin-right: 2px;overflow-x: hidden;overflow-y: scroll;max-height: 100px">
                    <table id="SUV_Localmax">

                    </table>
                </div>
                <a class="btn btn-secondary" role="button" id="tumor_comfirm" onclick="annotation_submit()">確認</a>
            </div>
            <div id="factor">
                <div class="addButton">
                    <button type="button" onclick="addMenu()" class="add btn btn-outline-primary">+</button>
                </div>
            </div>
        </div>

        <div id="location_menu">
            <button type="button" class="btn btn-secondary deletebtn" id="editAnnotationBotton"  onclick="editAnnotation()">編輯</button>
            <button type="button" class="btn btn-secondary deletebtn" data-bs-toggle="modal" data-bs-target="#deleteleModal" >刪除</button>
            <p class="btn btn-secondary deletebtn" id="segmentation" role="button" onclick="UNet()">Segmentation</p>
        </div>

        <div id="image_menu">
            <p class="btn btn-secondary resetbtn" id="reset" role="button">Reset</p>
            <p class="btn btn-secondary resetbtn" id="enlarge" role="button">放大</p>
            <p class="btn btn-secondary resetbtn" id="shrink" role="button">縮小</p>
            
            <select class="resetbtn" onchange="Plane_menu()" id="Plane_menu"  class="form-select form-select-sm resetbtn" aria-label=".form-select-sm example" >
                <option value="Axial">Axial</option>
                <option value="Coronal">Coronal</option>
                <option value="Sagittal">Sagittal</option>
            </select>
            <select class="resetbtn" onchange="Mode_menu()" id="Mode_menu"  class="form-select form-select-sm resetbtn" aria-label=".form-select-sm example" >
                <option value="CT">CT</option>
                <option value="PET">PET</option>
                <option value="Fusion">Fusion</option>
            </select>
            <select class="resetbtn" onchange="CTWindow_menu()" id="CTWindow_menu"  class="form-select form-select-sm resetbtn" aria-label=".form-select-sm example" >
                <option value="45,250">Abdomen</option>
                <option value="255,35" >Crane</option>
                <option value="45,300">Pelvis</option>
                <option value="45,440">Mediastinum</option>
                <option value="500,4000">Bone</option>
                <option value="-500,2000">Lung</option>
            </select>
            <button type="button" class="btn btn-secondary resetbtn" data-bs-toggle="modal" data-bs-target="#MEI_insert_Modal" id="SaveCoordinate">Save Coordinate</button>
            
        </div>

        <div class="modal fade" id="deleteleModal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">確認</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div id="InsertMessage" class="modal-body">
                        確定要刪除?
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="delete" onclick="deleteAnnotation()">刪除</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal" id="editAnnotation">
            <div class="modal-dialog modal-dialog-scrollable">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="exampleModalLabel">編輯病灶資訊</h5>
                        <button type="button"  class="btn-close editAnnotationExit" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div id="annotation_basic_info" class="modal-header">
                        
                    </div>
                    <div id="annotation_factor_pannel" class="modal-body">
                        <div class="addButton">
                            <button type="button" onclick="addMenu()" class="add btn btn-outline-primary">+</button>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <input type='checkbox' id="DrConfirm"><label for="DrConfirm">醫師確認</label>
                        <button type="button" class="btn btn-secondary editAnnotationExit" data-bs-dismiss="modal">Close</button>
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="editAnnotationSubmit()">提交</button>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="MEI_insert_Modal" tabindex="-1" aria-labelledby="exampleModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div id="InsertMessage" class="modal-body">
                    <input type="text" class="form-control" id='MRI_LabelRecord' placeholder="註解">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" onclick="SaveCoordinate()">確定</button>
                </div>
                </div>
            </div>
        </div>
    </div>
    <div id="text" >
        <p id="PIDText">{{ PID }}</p>
        <p id="StudyIDText">{{ StudyID }}</p>
        <p id="SeriesIDText">{{ SeriesID }}</p>
        <p id="MedExecTimeText">{{ MedExecTime }}</p>
        <p id="ItemText">{{ Item }}</p>
        <p id="SeriesDesText"> {{ SeriesDes }} </p>
        <p id="DiseaseText">{{Disease}}</p>
        <textarea id="T1" readonly></textarea>
        <textarea id="T2" readonly></textarea>
        <textarea id="T3" readonly></textarea>
        <textarea id="T4" readonly></textarea>
    </div>

</body>

</html>


{% endblock %}

