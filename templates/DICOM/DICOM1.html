

{% load static%}
{% block content %}


<html lang="zh-Hant" >
<head>
    <meta name="viewport" maximum-scale=1.0, user-scalable=0 content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">

    <!-- CSS only -->
    <link rel="stylesheet" href="{% static 'css_js/bootstrap.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/font-awesome.min.css' %}">


    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap.css' %}">

    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.rtl.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.rtl.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.rtl.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.rtl.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.min.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.rtl.css' %}">
    <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.rtl.min.css' %}">

    <!-- JS, Popper.js, and jQuery -->
    <script src="{% static 'css_js/jquery-3.5.1.slim.min.js' %}"></script>
    <script src="{% static 'css_js/popper.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.bundle.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.js' %}"></script>
    <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.min.js' %}"></script>

    <script src="{% static 'css_js/key_forbidden.js' %}"></script>
    
    <title>DICOM</title>
    </head>

<style>
        /* width */
    ::-webkit-scrollbar {
      width: 10px;
    }

    /* Track */
    ::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    /* Handle */
    ::-webkit-scrollbar-thumb {
      background: #888;
    }

    /* Handle on hover */
    ::-webkit-scrollbar-thumb:hover {
      background: #555;
    }
    body{
        overflow-y: hidden;
        background:url("{% static 'image/texture.png' %}");
        background-color: #33333a;
    }
    .main{float: left}
    /* Scroll 1 */
    .demoScroll {
        height: 300px;
        overflow: auto;
        width: 100%;
    }
    .s1{
        position:relative ;
    }
    /* Scroll 1 */
    .sc1::-webkit-scrollbar {
      width: 12px;
      height: 8px;
    }
    .sc1::-webkit-scrollbar-track {
      background-color: rgba(0, 0, 0, 0.5);

    }
    .sc1::-webkit-scrollbar-thumb {
      background-color: #EFEFEF;
      border-radius: 10px;
    }

    /* Scroll 2 */
    .sc2::-webkit-scrollbar {
      width: 8px;
      height: 10px;
    }
    .sc2::-webkit-scrollbar-track {
      background-color: rgba(255, 255, 255, 0.1);
      border-radius: 0px;
    }
    .sc2::-webkit-scrollbar-thumb {
      background-color: #11171a;
      border-radius: 2px 2px 2px 2px;
    }

    /* Scroll 3 */
    .sc3::-webkit-scrollbar {
      width: 2px;
      height: 2px;
    }
    .sc3::-webkit-scrollbar-track {
      background-color: transparent;
      border-radius: 5px;
    }
    .sc3::-webkit-scrollbar-thumb {
      background-color: rgba(0, 0, 0, 0.4);
      border-radius: 10px;
    }

    /* Scroll 4 */
    .sc4::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    .sc4::-webkit-scrollbar-track {
      border-radius: 10px;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .sc4::-webkit-scrollbar-thumb {
      background-color: #e78632;
      background-image:-webkit-linear-gradient(45deg,rgba(255,255,255,.3) 20%,transparent 20%,transparent 40%,rgba(255, 255, 255, 0.3) 40%,rgba(255,255,255,.3) 60%,transparent 60%,transparent 80%,rgba(255, 255, 255, 0.3) 80%);
      border-radius: 10px;
    }

    /* Scroll 5 */
    .sc5::-webkit-scrollbar {
      width: 15px;
      height: 15px;
    }
    .sc5::-webkit-scrollbar-track {
      border-radius: 10px;
      background-color: rgba(255, 255, 255, 0.1);
    }
    .sc5::-webkit-scrollbar-thumb {
      background-image: linear-gradient(45deg, #00aeff, #a68eff);
      border-radius: 10px;
        -webkit-box-shadow: rgba(0,0,0,.12) 0 3px 13px 1px;
    }


    /* Scroll 6 */
    .sc6::-webkit-scrollbar {
      width: 12px;
      height: 12px;
    }
    .sc6::-webkit-scrollbar-track {
      border-radius: 10px;
      background-color: rgba(0, 0, 0, 0.4);
    }
    .sc6::-webkit-scrollbar-thumb {
      background-color: #aab74d;
      background-image:-webkit-linear-gradient(rgba(255,255,255,.3) 20%,transparent 20%,transparent 40%,rgba(255, 255, 255, 0.3) 40%,rgba(255,255,255,.3) 60%,transparent 60%,transparent 80%,rgba(255, 255, 255, 0.3) 80%);
      border-radius: 10px;
    }
    .slider{position: absolute;right: 5px;}
    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #8e8fef; --border-radius: 10px; --width: 350px; --form-mob-width: 500px; }
    #mycheckbox { position: absolute; left: -9999px; }
    .feedback-label,.form { position: fixed; top: 50%; right: 0; }
    .feedback-label { transform-origin: top right; transform: rotate(-90deg) translate(50%, -100%); z-index: 10; }
    .form {background:url("{% static 'image/texture.png' %}");border:solid 2px #44444a; width: var(--width); max-height: 85vh;margin-top: 2%; transform: translate(100%, -50%); padding: 0px; overflow: auto; background-color: var(--form); z-index: 1; border-radius:10px}
    .feedback-label { border-radius: var(--border-radius); }
    .feedback-label { padding: 5px 10px; border-radius: var(--border-radius) var(--border-radius) 0 0; }
    .feedback-label { background: brown; color: white; }
    .feedback-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #mycheckbox:checked + .feedback-label { background: #e78632; transform: rotate(-90deg) translate(50%, calc((var(--width) + 100%) * -1))}
    #mycheckbox:checked ~ .form { transform: translate(0, -50%);z-index: 10;}
    .feedback-label, .form { transition: all 0.35s ease-in-out; }
    .form{-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}

    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #8e8fef; --border-radius: 10px; --width: 350px; --form-mob-width: 420px; }
    #Imagecheckbox { position: absolute; left: -9999px; }
    .Image-label,.Imageform { position: fixed; top: 50%; left: 0px;}
    .Image-label { transform-origin: top right; transform: rotate(90deg) translate(50%, 110%); z-index: 2; }
    .Imageform {background:url("{% static 'image/texture.png' %}");border:solid 2px #44444a; width: var(--width); height: 85vh;margin-top: 2%; transform: translate(-100%, -50%); padding: 0px; overflow: auto; background-color: #6699A1; z-index: 7; border-radius:10px}
    .Image-label { border-radius: var(--border-radius); }
    .Image-label { padding: 5px 10px; border-radius: var(--border-radius) var(--border-radius) 0 0; }
    .Image-label { background: brown; color: white; }
    .Image-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #Imagecheckbox:checked + .Image-label { background: #e78632; transform: rotate(90deg) translate(50%, calc((var(--width) - 110%) * -1))}
    #Imagecheckbox:checked ~ .Imageform { transform: translate(0%, -50%);z-index: 7;}
    .Image-label, .Imageform { transition: all 0.35s ease-in-out; }
    .Imageform{overflow-x: hidden;-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #ImageReport{margin-top: 5px;margin-left: 5px;width: calc(100% - 10px)}
    .container{background:url("{% static 'image/texture.png' %}");padding: 5px;margin-bottom: 5px;background-color: whitesmoke;border-radius: 5px;box-shadow: 2px 2px 2px 1px rgba(0, 0, 0, 0.2)}
    .row{padding-top: 10px;height: 30px}
    .col{font-weight: bold;text-align: center}
    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #eeefef; --border-radius: 10px; --form-height: 400px; --form-mob-height: 100px; }
    #Topcheckbox { position: absolute; left: -9999px; }
    .tool{float: left;overflow-x: auto}
    .Top-label { position: fixed; margin-top: 50px; right: 40%; height: 37px;}
    .Topform { position: fixed; margin-top: 50px; left: 0%;height: 20% ;}
    .Top-label { transform-origin: top right;  translate(0%, -100%); z-index: 5; }
    .Topform {background:url("{% static 'image/texture.png' %}");width: 60%; height: 200px;max-height: 400px; transform: translate(0%, -100%); padding:5px 5px; overflow-x: auto; background-color: var(--form); z-index:2; border-radius: 0px 0px 0px 10px}
    .Top-label { border-radius: var(--border-radius); }
    .Top-label { padding: 5px 10px; border-radius:0 0 var(--border-radius) var(--border-radius) ; }
    .Top-label { background: brown; color: white;}
    .Top-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #Topcheckbox:checked + .Top-label { background: #e78632; transform:translate(0%,540%)}
    #Topcheckbox:checked ~ .Topform { transform: translate(0%, 0%);}
    .Top-label, .Topform { transition: all 0.35s linear; }
    .form-check-label{ -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #CT-PET{
        background:url("{% static 'image/texture.png' %}");
        width: 1154px;
        float: left;
        display: flex;
        height: 876px;
        flex-wrap:wrap;
        text-align: center;
        padding-top:0px;
    }

    #text{
        width: 30%;
        height: 100%;
        padding-top:50px;
        background-color: white;
        position: fixed;
        right: 0px;
        margin: 0;
    }

    #frame1{
        overflow: hidden;
        height: 100%;
        width: 100%;
        padding: 0px;
        margin:0px;
        position: relative;
        top: 0%;
        display: flex;
        justify-content: center;
    }

    #frame2{
        overflow: hidden;
        height: 100%;
        width: 100%;
        padding: 0px;
        margin:0px;
        position: relative;
        top: 0%;
        display: none;

    }
    #frame3{
        overflow: hidden;
        height: 100%;
        width: 100%;
        padding: 0px;
        margin:0px;
        position: relative;
        top: 0%;
        display: none;
    }
    #frame4{
        overflow: hidden;
        height: 100%;
        width: 100%;
        padding: 0px;
        margin:0px;
        position: relative;
        top: 0%;
        display: none;
    }
    .img{
        width: 100%;
        height: 100%;

    }
    .main{
        float: left;
        -o-user-select:none;
        user-select:none;
    }


    :root {
      --radius: 2px;
      --baseFg: dimgray;
      --baseBg: white;
      --accentFg: #006fc2;
      --accentBg: #bae1ff;
    }

    .theme-pink {
      --radius: 2em;
      --baseFg: #c70062;
      --baseBg: #ffe3f1;
      --accentFg: #c70062;
      --accentBg: #ffaad4;
    }

    .theme-construction {
      --radius: 0;
      --baseFg: white;
      --baseBg: black;
      --accentFg: black;
      --accentBg: orange;
    }


    p{
        color:white;
        display: none;
        font-family: 'Tahoma';
    }
    .x{display: none;}
    .y{display: none;}
    .z{display: none;}
    .SUV{display: none;}
    input[type="radio"]{display: none}

    input[name="location"]{display: none;}
    input[name="location"]~label{padding: 0;margin: 0;margin-left: 4px;margin-bottom: 4px;width: calc(100% - 8px);background-color: #BBBBBB;border-radius: 10px;padding-top: 5px;padding-bottom: 5px}
    input[name="location"]:checked ~label{background-color: #e78632}

    .data{display: inline;color: #11171a}


    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #eeefef; --border-radius: 10px; --form-width: 300px; --form-mob-width: 320px; }
    #localizationslideout{position: fixed;width: 10%;left: 1154px;z-index: 5}
    .localizationform { position: fixed; height: calc(91%); top: 90px;  right: 30%}
    
    .localizationform {background:url("{% static 'image/texture.png' %}");width: 9.9%; max-height: 91%; padding-top: 10px;  overflow-x: hidden ; background-color: var(--form); z-index: 1; border-radius:0px}
    
    .data{background:url("{% static 'image/texture.png' %}");display: inline-block;color: #11171a;width: 100%;margin: 0;text-align: center}
    .data1{background:url("{% static 'image/texture.png' %}");display: inline-block;color: #11171a;width: 100%;margin: 0;text-align: center;word-break:break-all;word-wrap:break-word}
    #Disease{z-index: 2;position: fixed; height: 40px; top: 55px; width: 9.9%; margin: 0px; right: 30%;border-radius: 0px 0px 5px 5px;}
    #tumor{height: 145px;display: none;position: fixed;z-index: 3;background-color:#CCCCCC ;width: 120px;padding: 5px;border-radius:10px; -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #tumor input{border-radius:5px;margin-bottom: 5px ;width: 100%}
    #tumor a{color:#FFFFFF}
    #tumor select{margin-bottom: 5px;}
    #SUV_Localmax{border-collapse: collapse;  overflow: hidden;border-radius:5px; background-color: #FFFFFF;border: #0d0d0d 1px solid;width: 106px;text-align: center}
    .Localmax_SUV{display: inline;color: #11171a;width: 106px}
    input[name="localmax"] + label{width: 106px}
    input[name="localmax"]:checked ~label{background-color: #e78632}
    #SUV_Localmax + td{margin: 0}
    #textarea{-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    img{-o-user-select:none; user-select:none;}
   
    #textReport td{text-align: right;width: 100%}
    .examItem{display: inline;color: #11171a;margin-left: 20px;width: 50px;word-break: break-all}
    .examDate{display: inline;color: #11171a;margin-left: 40px;margin-right: 50px;width: 100px}
    .examReport{display: none}
    input[name='Report']{display: inline}
    textarea {resize: none; width: 100% ;height: 100%}

    .loader,
    .loader:before,
    .loader:after {
      border-radius: 50%;
      width: 2.5em;
      height: 2.5em;
      -webkit-animation-fill-mode: both;
      animation-fill-mode: both;
      -webkit-animation: load7 1.8s infinite ease-in-out;
      animation: load7 1.8s infinite ease-in-out;
    }
    .loader {
      color: #0dffff;
      font-size: 10px;
      position: relative;
      text-indent: -9999em;
      -webkit-transform: translateZ(0);
      -ms-transform: translateZ(0);
      transform: translateZ(0);
      -webkit-animation-delay: -0.16s;
      animation-delay: -0.16s;
    }
    .loader:before,
    .loader:after {
      content: '';
      position: absolute;
      top: 0;
    }
    .loader:before {
      left: -3.5em;
      -webkit-animation-delay: -0.32s;
      animation-delay: -0.32s;
    }
    .loader:after {
      left: 3.5em;
    }
    @-webkit-keyframes load7 {
      0%,
      80%,
      100% {
        box-shadow: 0 2.5em 0 -1.3em;
      }
      40% {
        box-shadow: 0 2.5em 0 0;
      }
    }
    @keyframes load7 {
      0%,
      80%,
      100% {
        box-shadow: 0 2.5em 0 -1.3em;
      }
      40% {
        box-shadow: 0 2.5em 0 0;
      }
    }
    textarea{background:url("{% static 'image/texture.png' %}");}
    #image_menu{padding-bottom:5px;padding-left:5px;padding-right:5px;position: fixed;z-index: 5;max-height: 85vh;display: none;margin: 0;width: 100px;background-color: #d6d8db; border-radius: 5px 5px 5px 5px}
    .resetbtn { margin:0;margin-top: 5px;width: 100%;max-height: 85vh; border-radius: 5px 5px 5px 5px}
    #location_menu{padding-bottom:5px;padding-left:5px;padding-right:5px;position: fixed;z-index: 5;max-height: 85vh;display: none;margin: 0;width: 100px;background-color: #d6d8db; border-radius: 5px 5px 5px 5px}
    .deletebtn{ margin:0;margin-top: 5px;width: 100%;max-height: 85vh; border-radius: 5px 5px 5px 5px;font-size:auto;word-break: break-all; }

    
    .variable{display:inline;position:absolute;right:20px;top:30px;color:white;z-index:1}
    .StudyDate{display:inline;position:absolute;right:20px;top:50px;color:white;z-index:1}
    .StudyID{display:inline;position:absolute;right:20px;top:70px;color:white;z-index:1}
</style>

<script type="text/javascript" src="{% static 'css_js/jquery-3.6.0.min.js' %}"></script>

<script>
    scrolling1=false
    scrolling2=false
    scrolling3=false
    scrolling4=false

    function test() {
        $('#CT-PET').css('margin-top','50px')
        $('#CT-PET').css('width',$(window).width()*0.6)
        $('#CT-PET').css('height',0)
        $("#frame1").children("label").children('div').children('div').children('img').css('display','none');
        $("#frame2").children("label").children('div').children('div').children('img').css('display','none');
        $("#frame3").children("label").children('div').children('div').children('img').css('display','none');
        $("#frame4").children("label").children('div').children('div').children('img').css('display','none');
        $('.slider').css('display','none')
        $('.loader').css('display','inline')
        $('.loader').css('top',$("#frame1").height()/2)
        $('#Topcheckbox').prop('chencked',false)
        $('#Topcheckbox').prop('disabled',true)
    }
    a=0
    function ajax1(event){
        if(scrolling1==true){
            let height=Math.ceil($('#frame1').children('label').children('.slider').height());
            let b = $('#frame1').children('label').children('.slider').scrollTop();
            let num = Math.ceil($('#frame1').children('label').children('.slider').children().height()/height)
            count1=Math.floor(b/height)
            
            plane=$("#frame1").children('label').children('div').children('div').children('.plane').text()
            $("#frame1").children('label').children('div').children('div').children('.variable').text(count1+1+'/'+num)
            if($('#frame1').children('input').is(':checked')){
                if(plane=='Axial'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.z').text(count1);
                }else if(plane=='Coronal'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.y').text(count1);
                }else if(plane=='Sagittal'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.x').text(count1);
                }
            }

            x=$('#frame1').children('label').children('div').children('div').children('.x').text()
            y=$('#frame1').children('label').children('div').children('div').children('.y').text()
            z=$('#frame1').children('label').children('div').children('div').children('.z').text()

            frameXYZ=checkPlaneXYZ(plane,x,y,count1)

            //alert(x+' '+y+' '+z)
            //ajax(1, xyz['x'], xyz['y'], count1,true, true)
            win_num=$('#select').val()
            var Con=[]
            for(var i =0;i<4;i++) {
                Con.push($('.StudyID').eq(i).text()+$('.StudyDate').eq(i).text())
            }
            
            for(var i =0;i<4;i++) {
                if(Con[i]==Con[0]){
                    var ind=i+1
                    if(ind!=1){
                        comparePlane = $('#frame'+ind).children('label').children('div').children('div').children('.plane').text()
                        
                        if(plane==comparePlane){
                            $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                            
                            let height=$('#frame'+ind).children('label').children('.slider').height();
                            let b = $('#frame'+ind).children('label').children('.slider').scrollTop();
                            let num = Math.ceil($('#frame'+ind).children('label').children('.slider').children().height()/height)
                            let count=Math.floor(b/height)
                            $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(count+1+'/'+num)
                        }
                        if(plane=='Axial'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.z').text(count1)
                        }else if(plane=='Coronal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.y').text(count1)
                        }else if(plane=='Sagittal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.x').text(count1)
                        }
                    }
                    ajax_connect_view(ind)
                    //ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)

                }
            }
        }

    }(jQuery);
    function ajax2(event){
        if(scrolling2==true){
            height=$('#frame2').children('label').children('.slider').height();
            b = $('#frame2').children('label').children('.slider').scrollTop();
            let num = ($('#frame2').children('label').children('.slider').children().height()/height)
            count2=Math.floor(b/height)
            plane=$("#frame2").children('label').children('div').children('div').children('.plane').text()
            $("#frame2").children('label').children('div').children('div').children('.variable').text(count2+1+'/'+num)

            if($('#frame2').children('input').is(':checked')){
                if(plane=='Axial'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.z').text(count2);
                }else if(plane=='Coronal'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.y').text(count2);
                }else if(plane=='Sagittal'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.x').text(count2);
                }
            }

            x=$('#frame2').children('label').children('div').children('div').children('.x').text()
            y=$('#frame2').children('label').children('div').children('div').children('.y').text()
            z=$('#frame2').children('label').children('div').children('div').children('.z').text()

            frameXYZ=checkPlaneXYZ(plane,x,y,count2)

            //alert(x+' '+y+' '+z)
            //ajax(1, xyz['x'], xyz['y'], count1,true, true)
            win_num=$('#select').val()
            var Con=[]
            for(var i =0;i<4;i++) {
                Con.push($('.StudyID').eq(i).text()+$('.StudyDate').eq(i).text())
            }

            for(var i =0;i<4;i++) {
                if(Con[i]==Con[1]){
                    var ind=i+1
                    if(ind!=2){
                        comparePlane = $('#frame'+ind).children('label').children('div').children('div').children('.plane').text()
                        if(plane==comparePlane){
                            $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                            let height=$('#frame'+ind).children('label').children('.slider').height();
                            let b = $('#frame'+ind).children('label').children('.slider').scrollTop();
                            let num = Math.ceil($('#frame'+ind).children('label').children('.slider').children().height()/height)
                            let count=Math.floor(b/height)
                            $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(count+1+'/'+num)
                        }
                        if(plane=='Axial'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.z').text(count2)
                        }else if(plane=='Coronal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.y').text(count2)
                        }else if(plane=='Sagittal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.x').text(count2)
                        }
                    }
                    ajax_connect_view(ind)
                    //ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)

                }
            }

        }
    }(jQuery);
    function ajax3(event){
        if(scrolling3==true) {
            height = $('#frame3').children('label').children('.slider').height();
            b = $('#frame3').children('label').children('.slider').scrollTop();
            let num = ($('#frame3').children('label').children('.slider').children().height()/height)
            count3=Math.floor(b/height)
            plane=$("#frame3").children('label').children('div').children('div').children('.plane').text()
            $("#frame3").children('label').children('div').children('div').children('.variable').text(count3+1+'/'+num)
            if ($('#frame3').children('input').is(':checked')) {
                $("[name='group1']:checked").next("label").children('.slider').scrollTop(b);
            }
            if($('#frame3').children('input').is(':checked')){
                if(plane=='Axial'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.z').text(count3);
                }else if(plane=='Coronal'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.y').text(count3);
                }else if(plane=='Sagittal'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.x').text(count3);
                }
            }
            

            x = $('#frame3').next('label').children('div').children('div').children('.x').text()
            y = $('#frame3').next('label').children('div').children('div').children('.y').text()
            z = $('#frame3').next('label').children('div').children('div').children('.z').text()
            plane = $("#frame3").children('label').children('div').children('div').children('.plane').text()
            frameXYZ = checkPlaneXYZ(plane, x, y, z)
            //alert(x+' '+y+' '+z)
            //ajax(3, xyz['x'], xyz['y'], count3, true, true)

            var Con=[]
            for(var i =0;i<4;i++) {
                Con.push($('.StudyID').eq(i).text()+$('.StudyDate').eq(i).text())
            }

            for(var i =0;i<4;i++) {
                if(Con[i]==Con[2]){

                    var ind=i+1
                    if(ind!=3){
                        comparePlane = $('#frame'+ind).children('label').children('div').children('div').children('.plane').text()
                        if(plane==comparePlane){
                            $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                            let height=$('#frame'+ind).children('label').children('.slider').height();
                            let b = $('#frame'+ind).children('label').children('.slider').scrollTop();
                            let num = Math.ceil($('#frame'+ind).children('label').children('.slider').children().height()/height)
                            let count=Math.floor(b/height)
                            $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(count+1+'/'+num)
                        }
                        if(plane=='Axial'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.z').text(count3)
                        }else if(plane=='Coronal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.y').text(count3)
                        }else if(plane=='Sagittal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.x').text(count3)
                        }
                    }
                    ajax_connect_view(ind)
                }
            }
        }
    }(jQuery);
    function ajax4(event){
        if(scrolling4==true) {
            height = $('#frame4').children('label').children('.slider').height();
            b = $('#frame4').children('label').children('.slider').scrollTop();
            let num = ($('#frame4').children('label').children('.slider').children().height()/height)
            count4=Math.floor(b/height)
            plane=$("#frame4").children('label').children('div').children('div').children('.plane').text()
            $("#frame4").children('label').children('div').children('div').children('.variable').text(count4+1+'/'+num)
            if ($('#check').is(':checked')) {
                if ($('#frame4').children('input').is(':checked')) {
                    $("[name='group1']:checked").next("label").children('.slider').scrollTop(b);
                }
            }
            if($('#frame4').children('input').is(':checked')){
                if(plane=='Axial'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.z').text(count4);
                }else if(plane=='Coronal'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.y').text(count4);
                }else if(plane=='Sagittal'){
                    $("[name='group1']:checked").next('label').children('div').children('div').children('.x').text(count4);
                }
            }
            

            x = $('#frame4').next('label').children('div').children('div').children('.x').text()
            y = $('#frame4').next('label').children('div').children('div').children('.y').text()
            z = $('#frame4').next('label').children('div').children('div').children('.z').text()
            plane = $("#frame4").children('label').children('div').children('div').children('.plane').text()
            frameXYZ = checkPlaneXYZ(plane, x, y, z)
            //alert(x+' '+y+' '+z)
            //ajax(4, xyz['x'], xyz['y'], count4, true, true)

            //alert(x+' '+y+' '+z)
            win_num=$('#select').val()
            var Con=[]
            for(var i =0;i<4;i++) {
                Con.push($('.StudyID').eq(i).text()+$('.StudyDate').eq(i).text())
            }
            for(var i =0;i<4;i++) {
                if(Con[i]==Con[3]){
                    var ind=i+1
                    if(ind!=4){
                        comparePlane = $('#frame'+ind).children('label').children('div').children('div').children('.plane').text()
                        if(plane==comparePlane){
                            $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                            let height=$('#frame'+ind).children('label').children('.slider').height();
                            let b = $('#frame'+ind).children('label').children('.slider').scrollTop();
                            let num = Math.ceil($('#frame'+ind).children('label').children('.slider').children().height()/height)
                            let count=Math.floor(b/height)
                            $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(count+1+'/'+num)
                        }
                        
                        if(plane=='Axial'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.z').text(count4)
                        }else if(plane=='Coronal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.y').text(count4)
                        }else if(plane=='Sagittal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.x').text(count4)
                        }
                    }
                    ajax_connect_view(ind)
                }
            }
        }
    }(jQuery);




    function myFunction(event) {
        document.getElementById("dicom1").onmousewheel = function(e){

            let height=$('#frame1').children('label').children('.slider').height();
            let b = $('#frame1').children('label').children('.slider').scrollTop();
            let count=Math.round(b/height);
            /*滑鼠滾動的量 下滾是負 上滾是正*/
            if(e.wheelDelta < 0){
                count ++;
            }else{
                count --;
            }
            let z = Math.round($('#frame1').children('label').children('.slider').children('div').height()/height)
            if (count < 0){
                count = 0
            }else if (count >= z-1) {
                count = z-1
            }
            b = count*height
            $('#frame1').children('label').children('.slider').scrollTop(b);
            scrolling1=true
            scrolling2=false
            scrolling3=false
            scrolling4=false
        }
        document.getElementById("dicom2").onmousewheel = function(e){
            let height=$('#frame2').children('label').children('.slider').height();
            let b = $('#frame2').children('label').children('.slider').scrollTop();
            let count=Math.round(b/height);
            if(e.wheelDelta < 0){
                count ++;
            }else{
                count --;
            }
            let z = Math.round($('#frame2').children('label').children('.slider').children('div').height()/height)
            if (count < 0){
                count = 0
            }else if (count >= z-1) {
                count = z-1
            }
            b = count*height
            $('#frame2').children('label').children('.slider').scrollTop(b);
            scrolling1=false
            scrolling2=true
            scrolling3=false
            scrolling4=false
        }
        document.getElementById("dicom3").onmousewheel = function(e){
            let height=$('#frame3').children('label').children('.slider').height();
            let b = $('#frame3').children('label').children('.slider').scrollTop();
            let count=Math.round(b/height);
            if(e.wheelDelta < 0){
                count ++;
            }else{
                count --;
            }
            let z = Math.round($('#frame3').children('label').children('.slider').children('div').height()/height)
            if (count < 0){
                count = 0
            }else if (count >= z-1) {
                count = z-1
            }
            b = count*height
            $('#frame3').children('label').children('.slider').scrollTop(b);
            scrolling1=false
            scrolling2=false
            scrolling3=true
            scrolling4=false
        }
        document.getElementById("dicom4").onmousewheel = function(e){
            let height=$('#frame4').children('label').children('.slider').height();
            let b = $('#frame4').children('label').children('.slider').scrollTop();
            let count=Math.round(b/height);
            if(e.wheelDelta < 0){
                count ++;
            }else{
                count --;
            }
            let z = Math.round($('#frame4').children('label').children('.slider').children('div').height()/height)
            if (count < 0){
                count = 0
            }else if (count >= z-1) {
                count = z-1
            }
            b = count*height
            $('#frame4').children('label').children('.slider').scrollTop(b);
            //document.getElementById('view1').scrollTop= b
            scrolling1=false
            scrolling2=false
            scrolling3=false
            scrolling4=true
        }
    }(jQuery);
    function bb(){
        $(".slider").prev(".main").children('div').children('p').text()
    }
    function mouseover(event){

        $('#CTWC').val($("[name='group1']:checked").next("label").children('div').children('div').children('.CTWC').text())
        $('#CTWW').val($("[name='group1']:checked").next("label").children('div').children('div').children('.CTWW').text())
        $('#PETWC').val($("[name='group1']:checked").next("label").children('div').children('div').children('.PETWC').text())
        $('#PETWW').val($("[name='group1']:checked").next("label").children('div').children('div').children('.PETWW').text())
        var Des = $("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDes').text()

        var mode=$("[name='group1']:checked").next("label").children('div').children('div').children('.mode').text()
        mode=mode.replace(/\s+/g, '')
        $('#Mode').val(mode).prop('selected',true);
        $('#Mode_menu').val(mode).prop('selected',true);

        var CT_window=$("[name='group1']:checked").next("label").children('div').children('div').children('.CT_window').text()
        $('#CTWindow').val(CT_window).prop('selected',true);
        $('#CTWindow_menu').val(CT_window).prop('selected',true);

        if(Des=='PET'){
            $('#Mode').prop('disabled',false);
            $('#PETWC').prop('disabled',false);
            $('#PETWW').prop('disabled',false);
            $('#UseSUVmax').children('input').prop('checked',true);
            $('#UseSUVmax').children('input').prop('disabled',false);
        }else{
            $('#Mode').prop('disabled',true);
            $('#PETWC').prop('disabled',true);
            $('#PETWW').prop('disabled',true);
            $('#UseSUVmax').children('input').prop('checked',false);
            $('#UseSUVmax').children('input').prop('disabled',true);
        }

        var plane=$("[name='group1']:checked").next("label").children('div').children('div').children('.plane').text()
        plane=plane.replace(/\s+/g, '')
        $('#viewPlane').val(plane).prop('selected',true);
        $('#Plane_menu').val(plane).prop('selected',true);

        var StudyDes = $("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDes').text()

        if(StudyDes=='RTPLAN'){
            $.ajax({
                type: 'post',
                url: "{% url 'DICOM:RT_change' %}", // this is the mapping between the url and view
                data: {
                    'WindowNo':$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text(),
                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                },
                success: function(response) {
                    $('.RT_Setting').empty()

                    for (var i = 0; i < response.ROIname.length; i++) {
                        if (response.index != -1) {
                            if (response.index.indexOf(i) != -1) {
                                //alert('<p style="display:inline ;width:20px;height: 20px;background-color: rgb('+response.color[i]+')"></p>')
                                $('.RT_Setting').append('' +
                                '<div class="form-check form-switch">' +
                                '<input checked class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="' + response.ROIname[i] + '">' +
                                '<label class="form-check-label" for="' + response.ROIname[i] + '">' + response.ROIname[i] + '</label>' +
                                '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb(' + response.color[i] + ')"></div>' +
                                '</div>' +
                                '')
                            } else {
                                $('.RT_Setting').append('' +
                                '<div class="form-check form-switch">' +
                                '<input class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="' + response.ROIname[i] + '">' +
                                '<label class="form-check-label" for="' + response.ROIname[i] + '">' + response.ROIname[i] + '</label>' +
                                '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb(' + response.color[i] + ')"></div>' +
                                '</div>' +
                                '')
                            }
                        }else{
                            $('.RT_Setting').append('' +
                            '<div class="form-check form-switch">' +
                            '<input class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="' + response.ROIname[i] + '">' +
                            '<label class="form-check-label" for="' + response.ROIname[i] + '">' + response.ROIname[i] + '</label>' +
                            '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb(' + response.color[i] + ')"></div>' +
                            '</div>' +
                            '')
                        }
                    }
                }
            });
        }else{
            $('.RT_Setting').empty()
        }
        if(win_num==1){
            $('#frame1').css('background-color','#33333a');
        }else{
            $("[name='group1']:checked").parents('div').css('background-image',
                'repeating-linear-gradient(to bottom, #FFFFFF 0,#FFFFFF 1%,transparent 1%, transparent 99%),' +
                'repeating-linear-gradient(to right, #FFFFFF 0,#FFFFFF 1%,#33333a 1%,#33333a 99%)'
            )

            $("[name='group1']:not(':checked')").parents('div').css('background','none');
            $("[name='group1']:not(':checked')").parents('div').css('background-color','#33333a');
        }

        var number=$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()

        if(number==1){
            scrolling1=true
            scrolling2=false
            scrolling3=false
            scrolling4=false
        }else if(number==2){
            scrolling1=false
            scrolling2=true
            scrolling3=false
            scrolling4=false
        }else if(number==3){
            scrolling1=false
            scrolling2=false
            scrolling3=true
            scrolling4=false
        }else if(number==4){
            scrolling1=false
            scrolling2=false
            scrolling3=false
            scrolling4=true
        }

    }
    function ajax_connect_view(name){
        var height=$('#frame'+name.toString()).children('label').children('.slider').height();
        var b = $('#frame'+name.toString()).children('label').children('.slider').scrollTop();
        var count=Math.round(b/height);
        var x=$('#frame'+name.toString()).children('label').children('div').children('#dicom'+name).children('.x').text()
        var y=$('#frame'+name.toString()).children('label').children('div').children('#dicom'+name).children('.y').text()
        var z=$('#frame'+name.toString()).children('label').children('div').children('#dicom'+name).children('.z').text()
        var plane=$("#frame"+name.toString()).children('label').children('div').children('div').children('.plane').text()
        var xyz=checkPlaneXYZ(plane,x,y,z)
        //alert(xyz['z'])
        ajax(name, xyz['x'], xyz['y'], xyz['z'],true, true)
    }
    //window.location.reload(true);
    
    function ajax(name,x,y,z,ActualCoordinates,drawActualCoordinates){
        if(name==1){
            urlname="{% url 'DICOM:DICOM_show1' %}"
        }else if(name==2){
            urlname="{% url 'DICOM:DICOM_show2' %}"
        }else if(name==3) {
            urlname="{% url 'DICOM:DICOM_show3' %}"
        }else if(name==4){
            urlname="{% url 'DICOM:DICOM_show4' %}"
        }

        
        $.ajax({
            type: 'post',
            url: urlname, // this is the mapping between the url and view
            data: {
                'variable': z, // ! here is the magic, your variable gets transmitted to the server
                'CTWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWC').text(),
                'CTWW':$("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWW').text(),
                'PETWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWC').text(),
                'PETWW':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWW').text(),
                'plane':$("#frame"+name.toString()).children('label').children('div').children('div').children('.plane').text(),
                'mode':$("#frame"+name.toString()).children('label').children('div').children('div').children('.mode').text(),
                'x': x,
                'y': y,
                'height':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').height(),
                'width':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').width(),
                'ActualCoordinates':ActualCoordinates,
                'drawActualCoordinates':drawActualCoordinates,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            async:false,
            cache:true,
            success: function(response) {
                $("#frame"+name.toString()).children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                //$("#frame"+name.toString()).children('label').children('.slider').scrollTop(z*$("#frame"+name.toString()).children('label').children('.slider').height())
            },
        });

    }
    function locationCompute(name,x,y,z){
        //
        //alert($("#frame"+name.toString()).children("label").children('div').children('div').children('img').height())
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:convertLocation" %}', // this is the mapping between the url and view
            data: {
                'z': z, // ! here is the magic, your variable gets transmitted to the server
                'plane':$("#frame"+name.toString()).children('label').children('div').children('div').children('.plane').text(),
                'x': x,
                'y': y,
                'height':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').height(),
                'width':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').width(),
                'PETWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWC').text(),
                'WindowNo':$("#frame"+name.toString()).children('label').children('div').children('div').children('.series').text(),
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success: function(response) {
                x=response.x
                y=response.y
                z=response.z
                //alert(z)
                $("#frame"+name.toString()).children('label').children('div').children('div').children('.x').text(response.x)
                $("#frame"+name.toString()).children('label').children('div').children('div').children('.y').text(response.y)
                $("#frame"+name.toString()).children('label').children('div').children('div').children('.z').text(response.z)
                //alert(x+' '+ y+' '+ z)
                DrawWithMouse(x,y,z,name)
                //alert($("#frame1").children("label").children('div').children('div').children('.x').text()+' '+$("#frame1").children("label").children('div').children('div').children('.y').text()+' '+$("#frame1").children("label").children('div').children('div').children('.z').text())
            }
        });
    }
    function checkPlaneXYZ(frame,x,y,z){
         if(frame=='Axial'){
            frame1_x=x
            frame1_y=y
            frame1_z=z
        }else if(frame=='Coronal'){
            frame1_x=x
            frame1_y=z
            frame1_z=y
        }else if(frame=='Sagittal'){
            frame1_x=y
            frame1_y=z
            frame1_z=x
        }
        return {'x':frame1_x,'y':frame1_y,'z':frame1_z}
    }
    function draw(){
        $("[name='location']:checked").next('label').css('background-color','#e78632')

        var indices=$("[name='location']").not(':checked')

        for(var i =0;i<indices.length;i++){

            if (indices.eq(i).next('label').children('.indices').text()==0) {
                indices.eq(i).next('label').css('background-color', '#BBBBBB')
            }else if(indices.eq(i).next('label').children('.indices').text()==1) {
                indices.eq(i).next('label').css('background-color','#A8D8B9')
            }else if(indices.eq(i).next('label').children('.indices').text()==2){
                indices.eq(i).next('label').css('background-color','#81C7D4')
            }else if(indices.eq(i).next('label').children('.indices').text()==3){
                indices.eq(i).next('label').css('background-color','#808F7C')
            }
        }

        ActualCoordinates=true
        strAry=($("[name='location']:checked").next('label').children('.info').text())
        a=strAry.split(',')
        x=a[0]
        y=a[1]
        z=a[2].split('--')[0]

        //alert(x+' '+y+' '+z)
        var SD=$("[name='location']:checked").next('label').children('.LocalStudyID').text()
        var Date=$("[name='location']:checked").next('label').children('.LocalStudyDate').text()
        var Con=[]
        for(var i =0;i<4;i++) {
            Con.push($('.StudyID').eq(i).text()+$('.StudyDate').eq(i).text())
        }
        for(var i =0;i<4;i++) {
            if(Con[i]==SD+Date){
                var ind=i+1

                frame=$("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.plane').text()
                frameXYZ=checkPlaneXYZ(frame,x,y,z)
                //ajax_connect_view(ind)
                //$('#frame'+ind).children('label').children('.slider').scrollTop(b)
                ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)
                $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                $('#frame'+ind).children('label').children('div').children('div').children('.x').text(x)
                $('#frame'+ind).children('label').children('div').children('div').children('.y').text(y)
                $('#frame'+ind).children('label').children('div').children('div').children('.z').text(z)
                let height=$('#frame'+ind).children('label').children('.slider').height();
                let num = Math.ceil($('#frame'+ind).children('label').children('.slider').children().height()/height)
                
                $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(parseInt(frameXYZ['z'])+1+'/'+num)
            }
        }
    }

    function DrawWithMouse(x,y,z,name){
        ActualCoordinates=true
        //alert(x+' | '+y+' | '+z)
        scrolling=false
        var Con=[]
        for(var i =0;i<4;i++) {
            Con.push($('.StudyID').eq(i).text()+$('.StudyDate').eq(i).text())
        }

        for(var i =0;i<4;i++) {
            if(Con[i]==Con[name-1]){
                var ind=i+1

                frame=$("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.plane').text()
                frameXYZ=checkPlaneXYZ(frame,x,y,z)

                $("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.x').text(x)
                $("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.y').text(y)
                $("#frame"+ind).children('label').children('div').children('#dicom'+ind).children('.z').text(z)

                //ajax_connect_view(ind)
                $('#frame'+ind).children('label').children('.slider').scrollTop(b)
                ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)
                //alert(frameXYZ['z'])
                //alert(x+' '+y+' '+z)
                $("#frame"+ind).children('label').children('.slider').scrollTop(frameXYZ['z']*$("#frame"+ind).children('label').children('.slider').height())
                
                let height=$('#frame'+ind).children('label').children('.slider').height();
                let num = Math.ceil($('#frame'+ind).children('label').children('.slider').children().height()/height)
                $('#frame'+ind).children('label').children('div').children('div').children('.variable').text(frameXYZ['z']+1+'/'+num)
                
            }
        }

    }
    function showReport(){
        if($("[name='Report']:checked").length>4){
            $('#'+event.target.id).prop('checked',false)
        }
        $("[name='Report']:checked").parents('td').css('background-color','#e78632')
        $("[name='Report']:not(':checked')").parents('td').css('background-color','#eeefef')
        for (var i = 0; i < $("[name='Report']:checked").length; i++) {
            var text =$("[name='Report']:checked").eq(i).prev('label').children('.examDate').text()+'\n'+'\n'
            text=text+$("[name='Report']:checked").eq(i).prev('label').children('.examReport').text()
            $('#T'+(i+1)).text(text)
        }

        if($("[name='Report']:checked").length==1){
            $('#T1').css('width','100%')
            $('#T1').css('height','100%')
            $('#T2').css('display','none')
            $('#T3').css('display','none')
            $('#T4').css('display','none')
        }
        if($("[name='Report']:checked").length==2){

            $('#T1').css('width','100%')
            $('#T1').css('height','50%')
            $('#T2').css('width','100%')
            $('#T2').css('height','50%')
            $('#T2').css('display','inline')
            $('#T3').css('display','none')
            $('#T4').css('display','none')
        }
        if($("[name='Report']:checked").length==3){

            $('#T1').css('width','100%')
            $('#T1').css('height','33%')
            $('#T2').css('width','100%')
            $('#T2').css('height','33%')
            $('#T2').css('display','inline')
            $('#T3').css('width','100%')
            $('#T3').css('height','34%')
            $('#T3').css('display','inline')
            $('#T4').css('display','none')
        }
        if($("[name='Report']:checked").length==4){

            $('#T1').css('width','100%')
            $('#T1').css('height','25%')
            $('#T2').css('width','100%')
            $('#T2').css('height','25%')
            $('#T2').css('display','inline')
            $('#T3').css('width','100%')
            $('#T3').css('height','25%')
            $('#T3').css('display','inline')
            $('#T4').css('width','100%')
            $('#T4').css('height','25%')
            $('#T4').css('display','inline')
        }
    }
    function localmaxclick(name){
        var lx=$(event.target).next('label').children('.Localmax_x').text()
        var ly=$(event.target).next('label').children('.Localmax_y').text()
        var lz=$(event.target).next('label').children('.Localmax_z').text()
        var lsuv=$(event.target).next('label').children('.Localmax_SUV').text()
        var Con=[]
        for(var i =0;i<4;i++) {
            Con.push($('.StudyID').eq(i).text()+$('.StudyDate').eq(i).text())
        }
        for(var i =0;i<4;i++) {
            if(Con[i]==Con[name-1]){
                var ind=i+1
                $('#frame'+ind).children('label').children('div').children('div').children('.x').text(lx)
                $('#frame'+ind).children('label').children('div').children('div').children('.y').text(ly)
                $('#frame'+ind).children('label').children('div').children('div').children('.z').text(lz)
                $('#frame'+ind).children('label').children('div').children('div').children('.SUV').val(lsuv)
            }
        }


        DrawWithMouse(lx,ly,lz,name)
    }
    function window_load(){
        var ExecDate = $(event.target).parents('.col').parents('.row').prevAll('.row2').children('.ImageExecDate').html()
        StudyDes = $(event.target).parents('.col').parents('.row').prevAll('.row2').children('.ImageStudyDes').html().replaceAll(' ','')
        var StudyID = $(event.target).parents('.col').parents('.row').prevAll('.row2').children('.ImageStudyID').html()
        var PID = $('#PIDText').text()
        var WindowNo = $(event.target).attr('name')
        
        var STD = $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyDate').text()
        var STID = $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyID').text()
        
        if((STID+STD)!=(StudyID+ExecDate)){
            $.ajax({
                type: 'post',
                url: '{% url "DICOM:window_load" %}', // this is the mapping between the url and view
                data:{
                    'WindowNo':WindowNo,
                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                },
            })
        }
        
        
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyDate').text(ExecDate)
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyID').text(StudyID)
        $('#frame'+WindowNo).children('label').children('.main').children('div').children('.StudyDes').text(StudyDes)
        $('#frame'+WindowNo).children('label').children('.slider').css('display','none');
        $('#frame'+WindowNo).children('label').children('.main').children('.loader').css('display','inline')
        $('#frame'+WindowNo).children("label").children('div').children('div').children('img').css('display','none')
        $('.loader').css('top',$("#frame1").height()/2)
        

        var str=$('.StudyID').eq(0).text()
        for(var i =1;i<$('.StudyID').length;i++){
            str+=','+$('.StudyID').eq(i).text()
        }
        var Study_Date=$('.StudyDate').eq(0).text()
        for(var i =1;i<$('.StudyDate').length;i++){
            Study_Date+=','+$('.StudyDate').eq(i).text()
        }
        if(StudyDes=='PET'){
            loadDICOMurlname="{% url 'DICOM:load_DICOM' %}"
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.StudyDes').text('PET')
            $("#frame"+WindowNo).children('label').children('div').children('div').children('.mode').text('Fusion')
        }else if(StudyDes=='RTPLAN'){
            loadDICOMurlname="{% url 'DICOM:load_RT_DICOM' %}"
        }else if(StudyDes=='CT'){
            loadDICOMurlname="{% url 'DICOM:load_CT_DICOM' %}"
            $('#frame'+WindowNo).children('label').children('div').children('div').children('.StudyDes').text('CT')
            $("#frame"+WindowNo).children('label').children('div').children('div').children('.mode').text('CT')
        }
        
        $.ajax({
            type: 'post',
            url: loadDICOMurlname, // this is the mapping between the url and view
            data:{
                'StudyDes':StudyDes,
                'WindowNo':WindowNo,
                'root':root,
                'PID':PID,
                'MedExecTime':ExecDate,
                'StudyIDText':StudyID,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response) {
                $('.RT_Setting').empty()
                if(StudyDes=='RTPLAN'){
                    $.ajax({
                        type: 'post',
                        url: '{% url "DICOM:ROIname" %}', // this is the mapping between the url and view
                        data: {
                            'WindowNo': WindowNo, // ! here is the magic, your variable gets transmitted to the server
                            'csrfmiddlewaretoken': window.CSRF_TOKEN
                        },
                        success: function(response) {
                            $('.RT_Setting').empty()
                            for(var i =0;i<response.ROIname.length;i++) {
                                //alert('<p style="display:inline ;width:20px;height: 20px;background-color: rgb('+response.color[i]+')"></p>')
                                $('.RT_Setting').append('' +
                                    '<div class="form-check form-switch">' +
                                        '<input class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="'+response.ROIname[i]+'">' +
                                        '<label class="form-check-label" for="'+response.ROIname[i]+'">' + response.ROIname[i] + '</label>' +
                                        '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb('+response.color[i]+')"></div>' +
                                    '</div>' +
                                '')
                            }
                        },
                    });
                }
                $('.loader').css('display','none')
                if(WindowNo==1){
                    urlname="{% url 'DICOM:DICOM_show1' %}"
                }else if(WindowNo==2){
                    urlname="{% url 'DICOM:DICOM_show2' %}"
                }else if(WindowNo==3) {
                    urlname="{% url 'DICOM:DICOM_show3' %}"
                }else if(WindowNo==4){
                    urlname="{% url 'DICOM:DICOM_show4' %}"
                }
                name=WindowNo
                $("#frame"+name.toString()).children("label").children('div').children('div').children('img').css('display','inline-block');
                $("#frame"+name.toString()).children("label").children('.slider').css('display','inline-block');
                //$("#frame"+name.toString()).children('label').children('div').children('div').children('.plane').text('Axial')
                //$('#viewPlane').val('Axial').prop('selected',true);
                $.ajax({
                    type: 'post',
                    url: urlname, // this is the mapping between the url and view
                    data: {
                        'variable': 0, // ! here is the magic, your variable gets transmitted to the server
                        'CTWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWC').text(),
                        'CTWW':$("#frame"+name.toString()).children('label').children('div').children('div').children('.CTWW').text(),
                        'PETWC':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWC').text(),
                        'PETWW':$("#frame"+name.toString()).children('label').children('div').children('div').children('.PETWW').text(),
                        'plane':$("#frame"+name.toString()).children('label').children('div').children('div').children('.plane').text(),
                        'mode':$("#frame"+name.toString()).children('label').children('div').children('div').children('.mode').text(),
                        'x': 0,
                        'y': 0,
                        'height':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').height(),
                        'width':$("#frame"+name.toString()).children("label").children('div').children('div').children('img').width(),
                        'ActualCoordinates':true,
                        'drawActualCoordinates':true,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function(response) {

                        $("#frame"+name.toString()).children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                        z=response.z
                        $("#frame"+name.toString()).children('label').children('.slider').children('div').css('height',z*100+'%')
                        $('#frame'+name.toString()).children('label').children('.slider').scrollTop(0)
                        $('#frame'+name.toString()).children('label').children('div').children('div').children('.variable').text(1+'/'+z)
                        mouseover()
                        
                    },
                    complete:function(){
                        dicomwindow()

                    }
                });
                $('#frame'+WindowNo).children('input').prop('checked',true)
                
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:selectLocation" %}', // this is the mapping between the url and view
                    data: {
                        'PID': PID,
                        'Disease':$('#Disease').val(),
                        'username':JSON.parse(document.getElementById('user_username').textContent),
                        'date':Study_Date,
                        'str':str,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function (response) {

                        $('#textarea').children('tr').remove();
                        for (var i = 0; i < response.PID.length; i++) {
                            $('#textarea').append('<tr><td><input onclick="draw()" type="radio" name="location" id=' + i + '>' +
                                '<label for=' + i + '>' +
                                '<p class="deleteInfo">' + response.id[i] + '</p>' +
                                '<p class="info">' + response.x[i] + ',' + response.y[i] + ',' + response.z[i]+'</p><p class="data">'+response.SUV[i] + '</p>' +
                                '<p class="data1">' + response.LabelGroup[i] +'</p>'+
                                '<p class="data1">' + response.LabelName[i] +'</p>'+
                                '<p class="data1">' + response.LabelRecord[i] +'</p>'+
                                '<p class="LocalStudyID">' + response.StudyID[i] +'</p>'+
                                '<p class="LocalStudyDate">' + response.date[i] +'</p>'+
                                '<p class="indices">' + response.indices[i] +'</p>'+
                                '</label></td></tr>')

                            if (response.indices[i]==0) {
                                $('#' + i).next('label').css('background-color', '#BBBBBB')
                            }else if(response.indices[i]==1) {
                                $('#'+i).next('label').css('background-color','#A8D8B9')
                            }else if(response.indices[i]==2){
                                $('#'+i).next('label').css('background-color','#81C7D4')
                            }else if(response.indices[i]==3){
                                $('#'+i).next('label').css('background-color','#808F7C')
                            }
                        }
                        $('.localizationform').scrollTop($('#textarea').height())
                    },
                });
            }
        });
    }
    function drawContour(){

        var ROIname=[]
        var Color=[]
        for(var i=0;i<$('input[name="RT"]:checked').length;i++){
            ROIname.push($('input[name="RT"]:checked').eq(i).next('label').html())
            Color.push($('input[name="RT"]:checked').eq(i).nextAll('div').css('background-color'))
        }

        $.ajax({
            type: 'post',
            url: '{% url "DICOM:DrawContour" %}', // this is the mapping between the url and view
            data:{
                'WindowNo':$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text(),
                'ROIname':ROIname,
                'Color':Color,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            }
        })
    }
    function CTWindow_menu(){
        var CT_window = $('#CTWindow_menu option:selected').val()
        $('#CTWindow').val(CT_window).prop('selected',true);
        dicomwindow()
    }
    function Mode_menu(){
        var Mode = $('#Mode_menu option:selected').val()
        $('#Mode').val(Mode).prop('selected',true);
        dicomwindow()
    }
    function Plane_menu(){
        var viewPlane = $('#Plane_menu option:selected').val()
        $('#viewPlane').val(viewPlane).prop('selected',true);
        dicomwindow()
    }


    function right_function(e){
        var x = e.originalEvent.x || e.originalEvent.layerX || 0;
        var y = e.originalEvent.y || e.originalEvent.layerY || 0;
        $("#image_menu").css('display', 'inline');
        $("#image_menu").css('left', x);
        $("#image_menu").css('top', y);
    }
    const handleWheel = function(e) {
        if(e.ctrlKey || e.metaKey)
            e.preventDefault();
    };
    window.addEventListener("wheel", handleWheel, {passive: false});

    

    function UNet(){
        let id = $('input[name="location"]:checked').next('label').children('.deleteInfo').text();
        let position = $('input[name="location"]:checked').next('label').children('.info').text();
        let plane = $("[name='group1']:checked").next("label").children('div').children('div').children('.plane').text();
        let WindowNo = $("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()
        let x = position.split(',')[0];
        let y = position.split(',')[1];
        let z = position.split(',')[2];
        $.ajax({
            type: 'post',
            url: '{% url "DICOM:UNet" %}', // this is the mapping between the url and view
            data:{
                'id':id,
                'WindowNo':WindowNo,
                'plane':plane,
                'x':x,
                'y':y,
                'z':z,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },success:function(){
                $("#location_menu").css('display', 'none')
                var Con=[]
                for(var i =0;i<4;i++) {
                    Con.push($('.StudyID').eq(i).text()+$('.StudyDate').eq(i).text())
                }
                
                for(var i =0;i<4;i++) {
                    if(Con[i]==Con[0]){
                        var ind=i+1
                        if(plane=='Axial'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.z').text(count1)
                        }else if(plane=='Coronal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.y').text(count1)
                        }else if(plane=='Sagittal'){
                            $('#frame'+ind).children('label').children('div').children('div').children('.x').text(count1)
                        }
                        ajax_connect_view(ind)
                        //ajax(ind,frameXYZ['x'],frameXYZ['y'],frameXYZ['z'],true,true)
                    }
                }
            }
        })
    }





    $(document).ready(function (e) {
        PID=$('#PIDText').text()
        MedExecTime=$('#MedExecTimeText').text()
        Item=$('#ItemText').text().replaceAll(' ','')
        StudyIDText=$('#StudyIDText').text()
        $(document).keydown(function(event) {
            if (event.ctrlKey==true && (event.which == '61' || event.which == '107' || event.which == '173' || event.which == '109'  || event.which == '187'  || event.which == '189'  ) ) {
                    event.preventDefault();
                }
        });
        
        $(window).bind('mousewheel DOMMouseScroll', function(event) {
            if (event.ctrlKey == true) {
                event.preventDefault();
            }
        });
        $(document).get(0).oncontextmenu = function() {
              return false
        };
        
        $.ajax({
            type: 'post',
            url: '{% url "confirm:Disease" %}', // this is the mapping between the url and view
            data:{
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                for(var i=0;i<response.DiseaseNo.length;i++){
                    $('#Disease').append('' +
                        '<option value="'+response.DiseaseNo[i]+'">'+response.Disease[i]+'</option>'+
                        '')
                }
            },
            complete:function(){

                $('#Disease').val($('#DiseaseText').text()).prop('selected',true)
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:PatientImageInfo" %}', // this is the mapping between the url and view
                    data:{
                        'PID':PID,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success:function (response){

                        for(var i=0;i<response.ExecDate.length;i++){
                            
                            if(PID+response.ExecDate[i]+response.StudyID[i]==PID+MedExecTime+StudyIDText){
                                check='checked'
                                $("#frame1").children("label").children('div').children('div').children('.StudyID').text(response.StudyID[i])
                            }else{
                                check=''
                            }
                            $('#ImageReport').append('' +
                                '<tr>' +
                                    '<td>' +
                                        '<div class="container">' +
                                            '<div class="row row1" style="text-align: center;margin-bottom: -1px;margin-left: -5px;margin-right: -5px;font-weight: bold;color: whitesmoke;background-color: lightslategray">' +
                                                '<div class="col-4">檢查日期</div>'+
                                                '<div class="col">項目</div>'+
                                                '<div class="col">StudyID</div>'+
                                                '<div class="col">張數</div>'+
                                            '</div>'+
                                            '<div class="row row2" style="margin-left: -5px;margin-right: -5px;font-weight: bold;color: whitesmoke;background-color: lightslategray">' +
                                                '<div class="col-md-auto ImageExecDate">'+response.ExecDate[i]+'</div>'+
                                                '<div class="col ImageStudyDes">'+response.StudyDes[i]+'</div>'+
                                                '<div class="col ImageStudyID">'+response.StudyID[i]+'</div>'+
                                                '<div class="col ImageSliceNo">'+response.SliceNo[i]+'</div>'+
                                            '</div>'+
                                            '<div class="row row3" >' +
                                                '<div class="col">Win1</div>'+
                                                '<div class="col">Win2</div>'+
                                                '<div class="col">Win3</div>'+
                                                '<div class="col">Win4</div>'+
                                            '</div>'+
                                            '<div class="row row4" >' +
                                                '<div class="col"><input  onchange="window_load()" style="display: inline;" type="radio" name="1" '+check+'></div>'+
                                                '<div class="col"><input  onchange="window_load()" style="display: inline;" type="radio" name="2" ></div>'+
                                                '<div class="col"><input  onchange="window_load()" style="display: inline;" type="radio" name="3" ></div>'+
                                                '<div class="col"><input  onchange="window_load()" style="display: inline;" type="radio" name="4" ></div>'+
                                            '</div>'+
                                        '</div>'+
                                    '</td>'+
                                '</tr>')
                        }
                        if($('#select').val()==1){
                            $('input[name="2"]').prop('disabled',true)
                            $('input[name="3"]').prop('disabled',true)
                            $('input[name="4"]').prop('disabled',true)
                        }else if($('#select').val()==2){
                            $('input[name="2"]').prop('disabled',false)
                            $('input[name="3"]').prop('disabled',true)
                            $('input[name="4"]').prop('disabled',true)
                        }else if($('#select').val()==4){
                            $('input[name="2"]').prop('disabled',false)
                            $('input[name="3"]').prop('disabled',false)
                            $('input[name="4"]').prop('disabled',false)
                        }
                    }
                })
        
                if(Item=='PET'){
                    loadDICOMurlname="{% url 'DICOM:load_DICOM' %}"
                    $('#Mode').val('Fusion')
                    $('#frame1').children('label').children('div').children('div').children('.StudyDes').text(Item)
                    $("#frame1").children('label').children('div').children('div').children('.mode').text('Fusion')
                }else if(Item=='CT'){
                    loadDICOMurlname="{% url 'DICOM:load_CT_DICOM' %}"
                    $('#Mode').val('CT')
                    $('#frame1').children('label').children('div').children('div').children('.StudyDes').text(Item)
                    $("#frame1").children('label').children('div').children('div').children('.mode').text('CT')
                }else if(Item=='RTPLAN') {
                    loadDICOMurlname="{% url 'DICOM:load_RT_DICOM' %}"
                    $('#Mode').val('CT')
                    $('#frame1').children('label').children('div').children('div').children('.StudyDes').text(Item)
                    $("#frame1").children('label').children('div').children('div').children('.mode').text('CT')
                }else if(Item=='LDCT'){
                    loadDICOMurlname="{% url 'DICOM:load_CT_DICOM' %}"
                    $('#Mode').val('CT')
                    $('#frame1').children('label').children('div').children('div').children('.StudyDes').text(Item)
                    $("#frame1").children('label').children('div').children('div').children('.mode').text('CT')
                }
        
                root='D:\\image\\'
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:TextReport" %}', // this is the mapping between the url and view
                    data: {
                        'PID': PID
                    },
                    success: function (response) {
                        $('#textReport').children('tr').remove();
                        for (var i = 0; i < response.examItem.length; i++) {
                            if(i==response.idx) {
                                $('#T1').text(response.examDate[i]+'\n'+'\n'+response.examReport[i])
        
                                $('#textReport').append(
                                    '<tr><td>' +
                                    '<label for=r' + i + '>' +
                                    '<p class="examItem">' + response.examItem[i] + '</p>' +
                                    '<p class="examDate">' + response.examDate[i] + '</p>' +
                                    '<p class="examReport">' + response.examReport[i] + '</p>' +
                                    '</label>' +
                                    '<input checked type="checkbox" onclick="showReport()" name="Report" id=r' + i + '>' +
                                    '</td></tr>'
                                )
                            }else{
                                $('#textReport').append(
                                    '<tr><td>' +
                                    '<label for=r' + i + '>' +
                                    '<p class="examItem">' + response.examItem[i] + '</p>' +
                                    '<p class="examDate">' + response.examDate[i] + '</p>' +
                                    '<p class="examReport">' + response.examReport[i] + '</p>' +
                                    '</label>' +
                                    '<input  type="checkbox" onclick="showReport()" name="Report" id=r' + i + '>' +
                                    '</td></tr>'
                                )
                            }
                        }
                    },
                    complete:function (){
                        $.ajax({
                            type: 'post',
                            url: loadDICOMurlname, // this is the mapping between the url and view
                            data:{
                                'StudyDes':Item,
                                'WindowNo':1,
                                'root':root,
                                'PID':PID,
                                'MedExecTime':MedExecTime,
                                'StudyIDText':StudyIDText,
                                'csrfmiddlewaretoken': window.CSRF_TOKEN
                            },
                            success:function (response){
                                $.ajax({
                                    type: 'post',
                                    url: '{% url "DICOM:DICOM_show1" %}', // this is the mapping between the url and view
                                    data: {
                                        'variable': 0, // ! here is the magic, your variable gets transmitted to the server
                                        'CTWC':$("#frame1").children('label').children('div').children('div').children('.CTWC').text(),
                                        'CTWW':$("#frame1").children('label').children('div').children('div').children('.CTWW').text(),
                                        'PETWC':$("#frame1").children('label').children('div').children('div').children('.PETWC').text(),
                                        'PETWW':$("#frame1").children('label').children('div').children('div').children('.PETWW').text(),
                                        'plane':$("#frame1").children('label').children('div').children('div').children('.plane').text(),
                                        'mode':$("#frame1").children('label').children('div').children('div').children('.mode').text(),
                                        'x': 0,
                                        'y': 0,
                                        'height':$("#frame1").children("label").children('div').children('div').children('img').height(),
                                        'width':$("#frame1").children("label").children('div').children('div').children('img').width(),
                                        'ActualCoordinates':true,
                                        'drawActualCoordinates':true,
                                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                                    },
                                    success:function (response){
                                        $('.loader').css('display','none')
                                        $('#Topcheckbox').prop('disabled',false)
                                        $("#frame1").children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                                        $("#frame2").children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                                        $("#frame3").children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                                        $("#frame4").children("label").children('div').children('div').children('img').attr('src',response.dicom_url);
                                        $("#frame1").children("label").children('div').children('div').children('img').css('display','inline-block');
                                        $("#frame1").children("label").children('div').children('div').children('img').css('display','inline-block');
                                        $("#frame1").children("label").children('.slider').css('display','inline-block');
                                        
                                        z=response.z
                                        $('.slider div').css('height',z*100+'%')
                                        $('#CT-PET').css('margin-top','60px')
                                        $("#frame1").children('label').children('div').children('div').children('.variable').text(1+'/'+z)

                                        //$('#frame1').children('label').children('div').children('div').children('.img').css('height',Math.round($('#frame1').height())+'px');
                                        ActualCoordinates=false
                                        scrolling1=true
                                        $('#CT-PET').css('height', $(window).height()-60)
                                        $('.slider').css('height',$('#frame1').height())
                                        //('.img').css('height',$(window).height()-60)
                                        $('#frame1').children('label').children('div').children('div').children('.StudyID').text(
                                            $('input[name="1"]:checked').parents('.col').parents('.row4').prevAll('.row2').children('.ImageStudyID').html()
                                        )
                                        $('#frame1').children('label').children('.main').children('div').children('.StudyDate').text(MedExecTime)
                                        var str=$('.StudyID').eq(0).text()
                                        for(var i =1;i<$('.StudyID').length;i++){
                                            str+=','+$('.StudyID').eq(i).text()
                                        }
                                        var Study_Date=$('.StudyDate').eq(0).text()
                                        for(var i =1;i<$('.StudyDate').length;i++){
                                            Study_Date+=','+$('.StudyDate').eq(i).text()
                                        }
                                        $.ajax({
                                            type: 'post',
                                            url: '{% url "DICOM:selectLocation" %}', // this is the mapping between the url and view
                                            data: {
                                                'PID': PID,
                                                'Disease':$('#Disease').val(),
                                                'username':JSON.parse(document.getElementById('user_username').textContent),
                                                'date':Study_Date,
                                                'str':str,
                                                'csrfmiddlewaretoken': window.CSRF_TOKEN
                                            },
                                            success: function (response) {
                                                $('#textarea').children('tr').remove();
                                                for (var i = 0; i < response.PID.length; i++) {
                                                    $('#textarea').append('<tr><td><input onclick="draw()" type="radio" name="location" id=' + i + '>' +
                                                        '<label  for=' + i + '>' +
                                                        '<p class="deleteInfo">' + response.id[i] + '</p>' +
                                                        '<p class="info">' + response.x[i] + ',' + response.y[i] + ',' + response.z[i]+'</p><p class="data">'+response.SUV[i] + '</p>' +
                                                        '<p class="data1">' + response.LabelGroup[i] +'</p>'+
                                                        '<p class="data1">' + response.LabelName[i] +'</p>'+
                                                        '<p class="data1">' + response.LabelRecord[i] +'</p>'+
                                                        '<p class="LocalStudyID">' + response.StudyID[i] +'</p>'+
                                                        '<p class="LocalStudyDate">' + response.date[i] +'</p>'+
                                                        '<p class="indices">' + response.indices[i] +'</p>'+
                                                        '</label></td></tr>')
        
                                                    if (response.indices[i]==0) {
                                                        $('#' + i).next('label').css('background-color', '#BBBBBB')
                                                    }else if(response.indices[i]==1) {
                                                        $('#'+i).next('label').css('background-color','#A8D8B9')
                                                    }else if(response.indices[i]==2){
                                                        $('#'+i).next('label').css('background-color','#81C7D4')
                                                    }else if(response.indices[i]==3){
                                                        $('#'+i).next('label').css('background-color','#808F7C')
                                                    }
                                                }
                                                $('.localizationform').scrollTop($('#textarea').height())
                                            },
                                        });
                                        $('.RT_Setting').empty()
                                        if(Item=='RTPLAN'){
                                            $.ajax({
                                                type: 'post',
                                                url: '{% url "DICOM:ROIname" %}', // this is the mapping between the url and view
                                                data: {
                                                    'WindowNo': 1, // ! here is the magic, your variable gets transmitted to the server
                                                    'csrfmiddlewaretoken': window.CSRF_TOKEN
                                                },
                                                success: function(response) {
                                                    $('.RT_Setting').empty()
        
                                                    for(var i =0;i<response.ROIname.length;i++) {
                                                        //alert('<p style="display:inline ;width:20px;height: 20px;background-color: rgb('+response.color[i]+')"></p>')
                                                        $('.RT_Setting').append('' +
                                                            '<div class="form-check form-switch">' +
                                                                '<input class="form-check-input" onchange="drawContour()" type="checkbox" name="RT" id="'+response.ROIname[i]+'">' +
                                                                '<label class="form-check-label" for="'+response.ROIname[i]+'">' + response.ROIname[i] + '</label>' +
                                                                '<div style="display:inline-block;position:absolute;right: 0px ;width:20px;height: 20px;background-color: rgb('+response.color[i]+')"></div>' +
                                                            '</div>' +
                                                        '')
                                                    }
                                                }
                                            });
                                        }
                                    },complete:function(){
                                        $.ajax({
                                            type: 'post',
                                            url: '{% url "DICOM:LabelGroup" %}', // this is the mapping between the url and view
                                            data: {
                                                'SubjectID': 1 ,
                                                'csrfmiddlewaretoken': window.CSRF_TOKEN
                                            },
                                            success: function(response) {
                                                for (var i = 0; i < response.LabelGroup.length; i++) {
                                                    $('#tumor').children('#LabelGroup').append('<option data-id='+response.GroupID[i]+'>'+response.LabelGroup[i]+'</option>>')
                                                }
                                            },
                                            complete:function(){
                                                dicomwindow()
                                                mouseover()
                                                
                                            }
                                        });
                                    }
                                });
                            }
                        });
                    }
                });
            }
        })
        
        

        $('#LabelGroup').on('change',function (){
            if($(this).find(':selected').attr('data-id')!=0){
            $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:LabelName" %}', // this is the mapping between the url and view
                    data: {
                        'SubjectID': 1 ,
                        'LabelGroup': $(this).find(':selected').attr('data-id') ,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function(response) {
                        $('#LabelName').children('option').remove()
                        for (var i = 0; i < response.LabelName.length; i++) {
                            $('#tumor').children('#LabelName').append('<option>'+response.LabelName[i]+'</option>>')
                        }
                    },
                });
            }else{
                $('#LabelName').children('option').remove()
                $('#tumor').children('#LabelName').append('<option>輸入病灶</option>>')
            }
        })

//-------------------------------定位功能------------------------------------


        $(function(){
            var _move=false
            $("#frame1").children("label").children('div').children('div').children('img').mousedown(function (e){
                if(e.which == 1) {
                    _move = true
                    $('input[name="location"]:checked').prop('checked', false)
                    ActualCoordinates = false
                    $('#tumor').css('display', 'none')
                    $("#image_menu").css('display', 'none');
                    var scale_rate = parseFloat($("#frame1").children("label").children('div').children('div').children('.Scale_rate').text())
                    var posX = $(this).position().left
                    if($(this).css('margin-top').slice(0,-2)==0){
                        var posY = $(this).position().top
                    }else{
                        var posY = parseFloat($(this).css('margin-top').slice(0,-2))+$(this).position().top;
                    }
                    x = Math.floor((e.pageX - posX - $(this).parents().parents().parents().parents().position().left -
                        $(this).parents().parents().parents().parents().css('border-left').slice(0, 1)
                    )/scale_rate)
                    y = Math.floor((e.pageY - posY - $(this).parents().parents().parents().parents().position().top -
                        $(this).parents().parents().parents().parents().css('border-top').slice(0, 1)
                    )/scale_rate)
                    var height = $("#frame1").children("label").children('.slider').height();
                    var b = $("#frame1").children("label").children('.slider').scrollTop();
                    var count = Math.floor(b / height);
                    StudyID = $("#frame1").children("label").children('div').children('div').children('.StudyID').text()
                    WindowNo = $("#frame1").children("label").children('div').children('div').children('.series').text()
                    locationCompute(1, x, y, count)

                }
            })
        })
        $(function(){
            var _move=false
            $("#frame2").children("label").children('div').children('div').children('img').mousedown(function (e){
                if(e.which == 1) {
                    _move = true
                    $('input[name="location"]:checked').prop('checked', false)
                    ActualCoordinates = false
                    $('#tumor').css('display', 'none')
                    $("#image_menu").css('display', 'none');
                    var scale_rate = parseFloat($("#frame2").children("label").children('div').children('div').children('.Scale_rate').text())

                    var posX = $(this).position().left
                    if($(this).css('margin-top').slice(0,-2)==0){
                        var posY = $(this).position().top
                    }else{
                        var posY = parseFloat($(this).css('margin-top').slice(0,-2))+$(this).position().top;
                    }

                    x = Math.floor((e.pageX - posX - $(this).parents().parents().parents().parents().position().left -
                        $(this).parents().parents().parents().parents().css('border-left').slice(0, 1)
                    )/scale_rate)
                    y = Math.floor((e.pageY - posY - $(this).parents().parents().parents().parents().position().top -
                        $(this).parents().parents().parents().parents().css('border-top').slice(0, 1)
                    )/scale_rate)

                    var height = $("#frame2").children("label").children('.slider').height();
                    var b = $("#frame2").children("label").children('.slider').scrollTop();
                    var count = Math.floor(b / height);
                    //var count = $("#frame2").children("label").children('div').children('div').children('.z').text()
                    StudyID = $("#frame2").children("label").children('div').children('div').children('.StudyID').text()
                    WindowNo = $("#frame2").children("label").children('div').children('div').children('.series').text()
                    locationCompute(2, x, y, count)
                    //alert(count)
                }
            })
        })

        $(function(){
            $("#frame3").children("label").children('div').children('div').children('img').mousedown(function (e){
                if(e.which == 1) {
                    ActualCoordinates = false
                    $('input[name="location"]:checked').prop('checked', false)
                    $("#image_menu").css('display', 'none');
                    $('#tumor').css('display', 'none')
                    var scale_rate = parseFloat($("#frame3").children("label").children('div').children('div').children('.Scale_rate').text())
                    var posX = $(this).position().left
                    if($(this).css('margin-top').slice(0,-2)==0){
                        var posY = $(this).position().top
                    }else{
                        var posY = parseFloat($(this).css('margin-top').slice(0,-2))+$(this).position().top;
                    }
                    x = Math.floor((e.pageX - posX - $(this).parents().parents().parents().parents().position().left -
                        $(this).parents().parents().parents().parents().css('border-left').slice(0, 1)
                    )/scale_rate)
                    y = Math.floor((e.pageY - posY - $(this).parents().parents().parents().parents().position().top -
                        $(this).parents().parents().parents().parents().css('border-top').slice(0, 1)
                    )/scale_rate)
                    $("#frame3").children("label").children('div').children('div').children('.x').text(x)
                    $("#frame3").children("label").children('div').children('div').children('.y').text(y)
                    var height = $("#frame3").children("label").children('.slider').height();
                    var b = $("#frame3").children("label").children('.slider').scrollTop();
                    //var count = Math.round(b / height);


                    var count = Math.floor(b / height);

                    StudyID = $("#frame3").children("label").children('div').children('div').children('.StudyID').text()
                    WindowNo = $("#frame3").children("label").children('div').children('div').children('.series').text()

                    //ajax(3,x,y,count,false)
                    locationCompute(3, x, y, count)
                }
            })
        })

        $(function(){

            $("#frame4").children("label").children('div').children('div').children('img').mousedown(function (e){
                if(e.which == 1) {
                    ActualCoordinates = false
                    $('input[name="location"]:checked').prop('checked', false)
                    $("#image_menu").css('display', 'none');
                    $('#tumor').css('display', 'none')
                    var scale_rate = parseFloat($("#frame4").children("label").children('div').children('div').children('.Scale_rate').text())
                    var posX = $(this).position().left
                    if($(this).css('margin-top').slice(0,-2)==0){
                        var posY = $(this).position().top
                    }else{
                        var posY = parseFloat($(this).css('margin-top').slice(0,-2))+$(this).position().top;
                    }
                    x = Math.floor((e.pageX - posX - $(this).parents().parents().parents().parents().position().left -
                        $(this).parents().parents().parents().parents().css('border-left').slice(0, 1)
                    )/scale_rate)
                    y = Math.floor((e.pageY - posY - $(this).parents().parents().parents().parents().position().top -
                        $(this).parents().parents().parents().parents().css('border-top').slice(0, 1)
                    )/scale_rate)
                    $("#frame4").children("label").children('div').children('div').children('.x').text(x)
                    $("#frame4").children("label").children('div').children('div').children('.y').text(y)
                    var height = $("#frame4").children("label").children('.slider').height();
                    var b = $("#frame4").children("label").children('.slider').scrollTop();
                    //var count = Math.round(b / height);

                    var count = Math.floor(b / height);

                    //ajax(4,x,y,count,false)
                    StudyID = $("#frame4").children("label").children('div').children('div').children('.StudyID').text()
                    WindowNo = $("#frame4").children("label").children('div').children('div').children('.series').text()

                    locationCompute(4, x, y, count)
                }
            })
        })


        $("[name='group1']").next("label").children('div').children('div').children('img').dblclick(function (e) {
            //if ($('#local').is(':checked')) {
            window_number=$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()
            //alert($('#trigger').is(':checked'))
            if($('#trigger').is(':checked')==true) {
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:findLocalMax" %}', // this is the mapping between the url and view
                    data: {
                        'x':$("[name='group1']:checked").next("label").children('div').children('div').children('.x').text(),
                        'y': $("[name='group1']:checked").next("label").children('div').children('div').children('.y').text(),
                        'z': $("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                        'PETWC': $("[name='group1']:checked").next("label").children('div').children('div').children('.PETWC').text(),
                        'StudyID':$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyID').text(),
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function (response) {
                        name=$("[name='group1']:checked").next("label").children('div').children('div').children('.series').text()

                        $('#SUV_Localmax').children('tr').remove();
                        for (var i = 0; i < response.x.length; i++) {

                            if(i==0){

                                if(response.maxValue[0]>=$('#PETWC').val()) {
                                    $('#SUV_Localmax').append(
                                        '<tr><td>' +
                                        '<input  type="radio" checked onclick="localmaxclick('+name+')" name="localmax" id=S' + i + '>' +
                                        '<label for=S' + i + '>' +
                                        '<p class="Localmax_x">' + response.x[i] + '</p>' +
                                        '<p class="Localmax_y">' + response.y[i] + '</p>' +
                                        '<p class="Localmax_z">' + response.z[i] + '</p>' +
                                        '<p style="display: inline;color: #11171a;width: 106px" class="Localmax_SUV_show">' + Math.round((response.maxValue[i] + Number.EPSILON) * 1000) / 1000 + '</p>' +
                                        '<p style="display: none" class="Localmax_SUV">' + response.maxValue[i] + '</p>' +
                                        '</label>' +
                                        '</td></tr>'
                                    )
                                }else{
                                    $('#SUV_Localmax').append(
                                        '<tr style="display: none"><td>' +
                                        '<input  type="radio" checked onclick="localmaxclick('+name+')" name="localmax" id=S' + i + '>' +
                                        '<label for=S' + i + '>' +
                                        '<p class="Localmax_x">' + response.x[i] + '</p>' +
                                        '<p class="Localmax_y">' + response.y[i] + '</p>' +
                                        '<p class="Localmax_z">' + response.z[i] + '</p>' +
                                        '<p style="display: inline;color: #11171a;width: 106px" class="Localmax_SUV_show">' + Math.round((response.maxValue[i] + Number.EPSILON) * 1000) / 1000 + '</p>' +
                                        '<p style="display: none" class="Localmax_SUV">' + response.maxValue[i] + '</p>' +
                                        '</label>' +
                                        '</td></tr>'
                                    )
                                }
                            }else{
                                $('#SUV_Localmax').append(
                                '<tr><td>' +
                                '<input  type="radio" onclick="localmaxclick('+name+')" name="localmax" id=S' + i + '>' +
                                '<label for=S' + i + '>' +
                                '<p class="Localmax_x">' + response.x[i] + '</p>' +
                                '<p class="Localmax_y">' + response.y[i] + '</p>' +
                                '<p class="Localmax_z">' + response.z[i] + '</p>' +
                                '<p style="display: inline;color: #11171a;width: 106px" class="Localmax_SUV_show">' + Math.round((response.maxValue[i]+Number.EPSILON)*1000)/1000 + '</p>' +
                                '<p style="display: none" class="Localmax_SUV">' + response.maxValue[i] + '</p>' +
                                '</label>' +
                                '</td></tr>'
                                )
                            }

                        }
                        var lx=$('input[name="localmax"]:checked').next('label').children('.Localmax_x').text()
                        var ly=$('input[name="localmax"]:checked').next('label').children('.Localmax_y').text()
                        var lz=$('input[name="localmax"]:checked').next('label').children('.Localmax_z').text()
                        var lsuv=$('input[name="localmax"]:checked').next('label').children('.Localmax_SUV').text()
                        var Con=[]
                        for(var i =0;i<4;i++) {
                            Con.push($('.StudyID').eq(i).text()+$('.StudyDate').eq(i).text())
                        }
                        for(var i =0;i<4;i++) {
                            if(Con[i]==Con[name-1]){
                                var ind=i+1
                                $('#frame'+ind).children('label').children('div').children('div').children('.x').text(lx)
                                $('#frame'+ind).children('label').children('div').children('div').children('.y').text(ly)
                                $('#frame'+ind).children('label').children('div').children('div').children('.z').text(lz)
                                $('#frame'+ind).children('label').children('div').children('div').children('.SUV').val(lsuv)
                            }
                        }

                        DrawWithMouse(lx,ly,lz,name)

                        elementClicked = 'False'

                        if (elementClicked == 'False') {
                            if(e.pageY>($('#CT-PET').height()/2)){
                                $('#tumor').css('display', 'inline')
                                $('#tumor').css('height', 145+$('#SUV_Localmax').parents().height()+15)
                                $('#tumor').css('top', e.pageY-$('#tumor').height())
                                $('#tumor').css('left', e.pageX+50)
                            }else {
                                $('#tumor').css('display', 'inline')
                                $('#tumor').css('height', 145+$('#SUV_Localmax').parents().height()+15)
                                $('#tumor').css('top', e.pageY)
                                $('#tumor').css('left', e.pageX+50)
                            }
                        }
                    },
                });
            }else{
                $('#SUV_Localmax').children('tr').remove();
                elementClicked = 'False'
                if (elementClicked == 'False') {
                    if(e.pageY>($('#CT-PET').height()/2)){
                        $('#tumor').css('display', 'inline')
                        $('#tumor').css('height', 145+$('#SUV_Localmax').parents().height()+15)
                        $('#tumor').css('top', e.pageY-$('#tumor').height())
                        $('#tumor').css('left', e.pageX+50)
                    }else {
                        $('#tumor').css('display', 'inline')
                        $('#tumor').css('height', 145+$('#SUV_Localmax').parents().height()+15)
                        $('#tumor').css('top', e.pageY)
                        $('#tumor').css('left', e.pageX+50)
                    }
                }
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:findSUV" %}', // this is the mapping between the url and view
                    data: {
                        'x':$("[name='group1']:checked").next("label").children('div').children('div').children('.x').text(),
                        'y': $("[name='group1']:checked").next("label").children('div').children('div').children('.y').text(),
                        'z': $("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                        'StudyID':$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyID').text(),
                        'isNotPET':$('#UseSUVmax').children('input').is(':disabled'),
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function (response) {
                        $('.SUV').val(response.SUV)
                    },
                });
            }
            $("#tumor").mousedown(function () {
                elementClicked = 'True'
            })
            $("[name='group1']").next("label").children('div').children('div').children('img').mousedown(function () {
                //if ($('#local').is(':checked')) {
                    elementClicked = 'False'
                //}
            })


            //}
        });


        $('#tumor').children('a').mousedown(function () {
            //if ($('#local').is(':checked')) {
            var str=$('.StudyID').eq(0).text()
            for(var i =1;i<$('.StudyID').length;i++){
                str+=','+$('.StudyID').eq(i).text()
            }
            var Study_Date=$('.StudyDate').eq(0).text()
            for(var i =1;i<$('.StudyDate').length;i++){
                Study_Date+=','+$('.StudyDate').eq(i).text()
            }
            user_username = JSON.parse(document.getElementById('user_username').textContent);
            height = $("[name='group1']:checked").next("label").children('.slider').height();
            b = $("[name='group1']:checked").next("label").children('.slider').scrollTop();
            count = Math.round(b / height);
            LabelGroup = $('#LabelGroup').val();
            LabelName = $('#LabelName').val();
            LabelRecord = $('#LabelRecord').val();
            $('#tumor').children('select').css('border-color', 'black')

            if (LabelGroup != '輸入病灶') {
                $('#tumor').css('display', 'none')
                elementClicked = 'False'
                $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:insertLocation" %}', // this is the mapping between the url and view
                    data: {
                        'PID':PID,
                        'SD': MedExecTime,
                        'Item': Item,
                        'username': user_username,
                        'x':$("[name='group1']:checked").next("label").children('div').children('div').children('.x').text(),
                        'y': $("[name='group1']:checked").next("label").children('div').children('div').children('.y').text(),
                        'z': $("[name='group1']:checked").next("label").children('div').children('div').children('.z').text(),
                        'LabelGroup': LabelGroup,
                        'LabelName': LabelName,
                        'LabelRecord': LabelRecord,
                        'SUV':$("[name='group1']:checked").next("label").children('div').children('div').children('.SUV').val(),
                        'plane':$("[name='group1']:checked").next("label").children('div').children('div').children('.plane').text(),
                        'height':$("[name='group1']:checked").next("label").children('div').children('div').children('img').height(),
                        'width':$("[name='group1']:checked").next("label").children('div').children('div').children('img').width(),
                        'ActualCoordinates':false,
                        'Disease':$('#Disease').val(),
                        'StudyID':StudyID,
                        'WindowNo':WindowNo,
                        'str':str,
                        'Study_Date':Study_Date,
                        'date':$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDate').text(),
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function (response) {
                        $('#textarea').children('tr').remove();
                        for (var i = 0; i < response.PID.length; i++) {
                            $('#textarea').append('<tr><td ><input onclick="draw()" type="radio" name="location" id=' + i + '>' +
                                '<label  for=' + i + '>' +
                                '<p class="deleteInfo">' + response.id[i] + '</p>' +
                                '<p class="info">' + response.x[i] + ',' + response.y[i] + ',' + response.z[i]+'</p><p class="data">'+response.SUV[i] + '</p>' +
                                '<p class="data1">' + response.LabelGroup[i] +'</p>'+
                                '<p class="data1">' + response.LabelName[i] +'</p>'+
                                '<p class="data1">' + response.LabelRecord[i] +'</p>'+
                                '<p class="LocalStudyID">' + response.StudyID[i] +'</p>'+
                                '<p class="LocalStudyDate">' + response.date[i] +'</p>'+
                                '<p class="indices">' + response.indices[i] +'</p>'+
                                '</label></td></tr>')

                            if (response.indices[i]==0) {
                                $('#' + i).next('label').css('background-color', '#BBBBBB')
                            }else if(response.indices[i]==1) {
                                $('#'+i).next('label').css('background-color','#A8D8B9')
                            }else if(response.indices[i]==2){
                                $('#'+i).next('label').css('background-color','#81C7D4')
                            }else if(response.indices[i]==3){
                                $('#'+i).next('label').css('background-color','#808F7C')
                            }
                        }

                        $('.localizationform').scrollTop($('#textarea').height())
                    },
                });
            } else {
                $('#tumor').children('select').css('border-color', 'red')
            }
            //}
        });

        $('#delete').on('click',function (){
            var str=$('.StudyID').eq(0).text()
            for(var i =1;i<$('.StudyID').length;i++){
                str+=','+$('.StudyID').eq(i).text()
            }
            var Study_Date=$('.StudyDate').eq(0).text()
            for(var i =1;i<$('.StudyDate').length;i++){
                Study_Date+=','+$('.StudyDate').eq(i).text()
            }
            id=$('input[name="location"]:checked').next('label').children('.deleteInfo').text();
            //alert($('input[name="location"]:checked').next('label').children('p').text())
            $.ajax({
                type: 'post',
                url: '{% url "DICOM:deleteLocation" %}', // this is the mapping between the url and view
                data: {
                'id':id,
                'PID':PID,
                'Disease':$('#Disease').val(),
                'username':JSON.parse(document.getElementById('user_username').textContent),
                'str':str,
                'Study_Date':Study_Date,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
                },
                success: function(response) {
                    $('#textarea').children('tr').remove();
                        for (var i = 0; i < response.PID.length; i++) {
                            $('#textarea').append('<tr><td><input onclick="draw()" type="radio" name="location" id=' + i + '>' +
                                '<label for=' + i + '>' +
                                '<p class="deleteInfo">' + response.id[i] + '</p>' +
                                '<p class="info">' + response.x[i] + ',' + response.y[i] + ',' + response.z[i]+'</p><p class="data">'+response.SUV[i] + '</p>' +
                                '<p class="data1">' + response.LabelGroup[i] +'</p>'+
                                '<p class="data1">' + response.LabelName[i] +'</p>'+
                                '<p class="data1">' + response.LabelRecord[i] +'</p>'+
                                '<p class="LocalStudyID">' + response.StudyID[i] +'</p>'+
                                '<p class="LocalStudyDate">' + response.date[i] +'</p>'+
                                '<p class="indices">' + response.indices[i] +'</p>'+
                                '</label></td></tr>')

                            if (response.indices[i]==0) {
                                $('#' + i).next('label').css('background-color', '#BBBBBB')
                            }else if(response.indices[i]==1) {
                                $('#'+i).next('label').css('background-color','#A8D8B9')
                            }else if(response.indices[i]==2){
                                $('#'+i).next('label').css('background-color','#81C7D4')
                            }else if(response.indices[i]==3){
                                $('#'+i).next('label').css('background-color','#808F7C')
                            }
                        }
                    $("#location_menu").css('display', 'none')
                },
            });
        })
        $('#frame1').on('mousedown',function (e){
            $(this).children('input').prop('checked',true)
            mouseover()
            $('#tumor').css('display', 'none');
            if(e.which==3){
                right_function(e)
            }else if(e.which==1){
                $("#image_menu").css('display', 'none');
            }
        })
        $('#frame2').on('mousedown',function (e){
            $(this).children('input').prop('checked',true)
            mouseover()
            $('#tumor').css('display', 'none');
            if(e.which==3){
                right_function(e)
            }else if(e.which==1){
                $("#image_menu").css('display', 'none');
            }
        })
        $('#frame3').on('mousedown',function (e){
            $(this).children('input').prop('checked',true)
            mouseover()
            $('#tumor').css('display', 'none');
            if(e.which==3){
                right_function(e)
            }else if(e.which==1){
                $("#image_menu").css('display', 'none');
            }
        })
        $('#frame4').on('mousedown',function (e){
            $(this).children('input').prop('checked',true)
            mouseover()
            $("#tumor").css('display', 'none');
            if(e.which==3){
                right_function(e)
            }else if(e.which==1){
                $("#image_menu").css('display', 'none');
            }
        })
        $('#Disease').on('change',function(){
            var str=$('.StudyID').eq(0).text()
            for(var i =1;i<$('.StudyID').length;i++){
                str+=','+$('.StudyID').eq(i).text()
            }
            var Study_Date=$('.StudyDate').eq(0).text()
            for(var i =1;i<$('.StudyDate').length;i++){
                Study_Date+=','+$('.StudyDate').eq(i).text()
            }
            $.ajax({
                    type: 'post',
                    url: '{% url "DICOM:selectLocation" %}', // this is the mapping between the url and view
                    data: {
                        'PID': PID,
                        'Disease':$('#Disease').val(),
                        'username':JSON.parse(document.getElementById('user_username').textContent),
                        'date':Study_Date,
                        'str':str,
                        'csrfmiddlewaretoken': window.CSRF_TOKEN
                    },
                    success: function (response) {

                        $('#textarea').children('tr').remove();
                        for (var i = 0; i < response.PID.length; i++) {
                            $('#textarea').append('<tr><td><input onclick="draw()" type="radio" name="location" id=' + i + '>' +
                                '<label for=' + i + '>' +
                                '<p class="deleteInfo">' + response.id[i] + '</p>' +
                                '<p class="info">' + response.x[i] + ',' + response.y[i] + ',' + response.z[i]+'</p><p class="data">'+response.SUV[i] + '</p>' +
                                '<p class="data1">' + response.LabelGroup[i] +'</p>'+
                                '<p class="data1">' + response.LabelName[i] +'</p>'+
                                '<p class="data1">' + response.LabelRecord[i] +'</p>'+
                                '<p class="LocalStudyID">' + response.StudyID[i] +'</p>'+
                                '<p class="LocalStudyDate">' + response.date[i] +'</p>'+
                                '<p class="indices">' + response.indices[i] +'</p>'+
                                '</label></td></tr>')

                            if (response.indices[i]==0) {
                                $('#' + i).next('label').css('background-color', '#BBBBBB')
                            }else if(response.indices[i]==1) {
                                $('#'+i).next('label').css('background-color','#A8D8B9')
                            }else if(response.indices[i]==2){
                                $('#'+i).next('label').css('background-color','#81C7D4')
                            }else if(response.indices[i]==3){
                                $('#'+i).next('label').css('background-color','#808F7C')
                            }
                        }
                        $('.localizationform').scrollTop($('#textarea').height())
                    },
                });
        })

        $('#textarea').on('mousedown','td',function(d){
            $(this).children('input[type="radio"]').prop('checked',true)
            draw()
            if(d.which == 3){  // 1 = 滑鼠左鍵; 2 = 滑鼠中鍵; 3 = 滑鼠右鍵
                if($('input[name="location"]').is(':checked')==true) {
                    var x = d.originalEvent.x || d.originalEvent.layerX || 0;
                    var y = d.originalEvent.y || d.originalEvent.layerY || 0;
                    $("#location_menu").css('display', 'inline');
                    $("#location_menu").css('left', x);
                    $("#location_menu").css('top', y);
                }
            }
            if(e.which == 1){  //如果滑鼠左鍵點下，則隱藏右鍵選單
                $("#location_menu").css('display','none');
            }
        })

        $('#CT-PET').mousedown(function(e){
            if(e.which == 1) {
                $("#location_menu").css('display', 'none');

            }
        })
        $('textarea').mousedown(function(e){
            if(e.which == 1) {
                $("#location_menu").css('display', 'none');
                $("#image_menu").css('display', 'none');
            }
        })
        $('.localizationform').mousedown(function(e){
            if(e.which == 1) {
                $("#location_menu").css('display', 'none');
                $("#image_menu").css('display', 'none');
            }
        })
        $('body').keydown(function(event){
            
            switch (event.keyCode){
                case 35://End鍵
                    $("[name='group1']:checked").next("label").children('.slider').scrollTop($("[name='group1']:checked").next("label").children('.slider').children().height());
                    break;
                case 36://Home鍵
                    $("[name='group1']:checked").next("label").children('.slider').scrollTop(0);
                    break;
                case 45://Insert鍵 (中間圖像)
                    $("[name='group1']:checked").next("label").children('.slider').scrollTop($("[name='group1']:checked").next("label").children('.slider').children().height()/2);
                    break;
                case 33://PgUp鍵 (放大圖像)
                    var scale_rate = parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text())+0.1
                    $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
                    $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(scale_rate)
                    break;
                case 34://PgDn鍵 (縮小圖像)
                    var scale_rate = parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text())-0.1
                    $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
                    $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(scale_rate)
                    break;
                case 37://圖像左移
                    img_x=parseFloat($("[name='group1']:checked").next("label").children('div').children('div').css('margin-left').slice(0,-2))
                    $("[name='group1']:checked").next("label").children('div').children('div').css('margin-left',img_x-5)

                    break;
                case 38://圖像上移
                    img_y=parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin-top').slice(0,-2))
                    $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin-top',img_y-5)
                    break;
                case 39://圖像右移
                    img_x=parseFloat($("[name='group1']:checked").next("label").children('div').children('div').css('margin-left').slice(0,-2))
                    $("[name='group1']:checked").next("label").children('div').children('div').css('margin-left',img_x+5)
                    break;
                case 40://圖像下移
                    img_y=parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin-top').slice(0,-2))
                    $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin-top',img_y+5)
                    break;
            }
        })
        $(window).on('resize', function(){
            location.reload()
        });

        //-----------------右鍵選單功能---------------------
        $('#reset').on('click',function(){
            var Des=$("[name='group1']:checked").next("label").children('div').children('div').children('.StudyDes').text()
            if(Des=='PET'){
                $('#Mode').val('Fusion')
                $('#Mode_menu').val('Fusion').prop('selected',true)
            }else if(Des=='CT'){
                $('#Mode').val('CT')
                $('#Mode_menu').val('CT').prop('selected',true)
            }else if(Des=='RT'){
                $('#Mode').val('CT')
                $('#Mode_menu').val('CT').prop('selected',true)
            }
            $('#viewPlane').val('Axial')
            $('#Plane_menu').val('Axial').prop('selected',true)
            $('#CTWindow').val('45,250').prop('selected',true)
            $('#CTWindow_menu').val('45,250').prop('selected',true)
            $('#PETWC').val(2.5)
            $('#PETWW').val(5)
            dicomwindow()
            $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(1)
            var scale_rate=1
            $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
            $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('margin',0)
            $("[name='group1']:checked").next("label").children('div').children('div').css('margin',0)
            $("#image_menu").css('display', 'none');
        })

        $('#enlarge').on('click',function(){
            var scale_rate = parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text())+0.1
            $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
            $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(scale_rate)
        })
        $('#shrink').on('click',function(){
            var scale_rate = parseFloat($("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text())-0.1
            $("[name='group1']:checked").next("label").children('div').children('div').children('.img').css('transform','scale('+scale_rate+')')
            $("[name='group1']:checked").next("label").children('div').children('div').children('.Scale_rate').text(scale_rate)
        })

    });
//-------------------------------定位功能------------------------------------
</script>

<body onload="test()">
<nav class="navbar navbar-expand-md navbar-dark fixed-top bg-dark">
    <a class="navbar-brand" href={% url 'demo:index' %}>AI Center</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-target="#navbarsExampleDefault"
        aria-controls="navbarsExampleDefault" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarsExampleDefault">
        <ul class="navbar-nav mr-auto">
            <li class="nav-item active">
                <a class="nav-link" href={% url 'demo:index' %}>Home <span class="sr-only">(current)</span></a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false" >相關連結</a>
                <div class="dropdown-menu" aria-labelledby="dropdown01">
                    <a class="dropdown-item" href="http://www.csh.org.tw/">中山醫學大學附設醫院</a>
                </div>
            </li>
            {% if '1' in au or 'F' in au %}{% include 'accounts/loginpartial2.html' %}{% endif %}
            {% if '2' in au or 'F' in au %}{% include 'accounts/Infection_prevention_and_control.html' %}{% endif %}
            {% if '3' in au or 'F' in au %}{% include 'accounts/NLP.html' %}{% endif %}
            {% if '4' in au or 'F' in au %}{% include 'accounts/upload.html' %}{% endif %}
            {% if 'F' in au %}{% include 'accounts/auth.html' %}{% endif %}
        </ul>

        {% include 'accounts/loginpartial.html' %}
    </div>
</nav>
<div id="slideTopout">
    <input type="checkbox" id="Topcheckbox">
    <label for="Topcheckbox" class="Top-label">SETTING</label>
    <form class="Topform">
        <div class ="tool">
            {% include 'DICOM/Setting.html' %}
        </div>
    </form>
</div>
<div id="slideout">
    <input type="checkbox" id="mycheckbox">
    <label for="mycheckbox" class="feedback-label">MENU</label>
    <form class="form sc2">
        <table id="textReport"></table>
    </form>
</div>

<div id="ImageSelect">
    <input type="checkbox" id="Imagecheckbox">
    <label for="Imagecheckbox" class="Image-label">IMAGE</label>
    <form class="Imageform sc2">
        <table id="ImageReport">
        </table>

    </form>
</div>

<div id="localizationslideout">
    <select class="form-select form-select-sm" aria-label=".form-select-sm example" id="Disease" ></select>
    <form class="localizationform sc2">

            <table id="textarea" >
                {{ user.username|json_script:"user_username" }}
            </table>

    </form>

</div>



<div id="CT-PET" >
     <div id="frame1" >

        <input type="radio" onclick="bb()" id="a1"  name="group1" value="1" checked>
        <label for="a1" class="test" >

            <div class="main" onwheel="myFunction(event)" >
                <div class="loader"></div>
                <div id="dicom1">

                    <img class="img"  ondragstart="return false;"  />
                    <p class="CTWC" style="">45</p>
                    <p class="CTWW" style="">250</p>
                    <p class="PETWC" style="">2.5</p>
                    <p class="PETWW" style="">5</p>
                    <p class="plane" style="">Axial</p>
                    <p class="mode" style="">CT</p>
                    <p class="CT_window" >45,250</p>
                    <p class="ratio" style="">0</p>
                    <p class="x" >0</p>
                    <p class="y" >0</p>
                    <p class="z" >0</p>
                    <input type="text" class="SUV" value="0">
                    <p class="series" style="">1</p>
                    <p class="StudyID" style="">-9999</p>
                    <p class="StudyDes" style="">-9999</p>
                    <p class="StudyDate" style="">-9999</p>
                    <p class="Scale_rate" style="">1</p>
                    <p class="variable" style="">0/0</p>
                </div>

            </div>
            <div class='slider demoScroll sc1 s1'  onscroll="ajax1(event)" id="view1" style="border: 1px #000000;margin: 0%;
        width: 14px;overflow-y:scroll" ><div  id="test" style="height:2000%" ></div></div>
         </label>
    </div>
     <div id="frame2">

        <input type="radio" onclick="bb()" id="a2" name="group1" value="1" >
        <label for="a2" class="test" >

            <div class="main" onwheel="myFunction(event)" >
                <div class="loader"></div>
                <div id="dicom2">
    <!-- Main jumbotron for a primary marketing message or call to action -->
                    <img class="img" ondragstart="return false;"  />
                    <p class="CTWC" >45</p>
                    <p class="CTWW" >250</p>
                    <p class="PETWC" >2.5</p>
                    <p class="PETWW" >5</p>
                    <p class="plane" >Axial</p>
                    <p class="mode" >CT</p>
                    <p class="CT_window" >45,250</p>
                    <p class="ratio" style="">0</p>
                    <p class="x" >0</p>
                    <p class="y" >0</p>
                    <p class="z" >0</p>
                    <input type="text" class="SUV" value="0">
                    <p class="series" style="">2</p>
                    <p class="StudyID" style="">-9999</p>
                    <p class="StudyDes" style="">-9999</p>
                    <p class="StudyDate" style="">-9999</p>
                    <p class="Scale_rate" style="">1</p>
                    <p class="variable" style="">0/0</p>
                </div>
            </div>
            <div class='slider demoScroll sc1 s2'  onscroll="ajax2(event)" style="border: 1px #000000;margin: 0%;
        width: 14px;overflow-y:scroll" ><div  style="height:2000%" ></div></div>

         </label>
     </div>
     <div id="frame3" >

        <input type="radio" onclick="bb()" id="a3" name="group1" value="1" >
        <label for="a3" class="test" >

            <div class="main" onwheel="myFunction(event)" >
                <div class="loader"></div>
                <div id="dicom3" >
    <!-- Main jumbotron for a primary marketing message or call to action -->
                    <img class="img" ondragstart="return false;"  />
                    <p class="CTWC" >45</p>
                    <p class="CTWW" >250</p>
                    <p class="PETWC" >2.5</p>
                    <p class="PETWW" >5</p>
                    <p class="plane" >Axial</p>
                    <p class="mode" >CT</p>
                    <p class="CT_window" >45,250</p>
                    <p class="ratio" style="">0</p>
                    <p class="x" >0</p>
                    <p class="y" >0</p>
                    <p class="z" >0</p>
                    <input type="text" class="SUV" value="0">
                    <p class="series" style="">3</p>
                    <p class="StudyID" style="">-9999</p>
                    <p class="StudyDes" style="">-9999</p>
                    <p class="StudyDate" style="">-9999</p>
                    <p class="Scale_rate" style="">1</p>
                    <p class="variable" style="">0/0</p>
                </div>
            </div>
            <div class='slider demoScroll sc1 s3'  onscroll="ajax3(event)" style="border: 1px #000000;margin: 0%;
        width: 14px;overflow-y:scroll" ><div  style="height:2000%" ></div></div>

         </label>
    </div>
    <div id="frame4" >
        <input type="radio" onclick="bb()" id="a4" name="group1" value="1" >
        <label for="a4" class="test" >

            <div class="main" onwheel="myFunction(event)" >
                <div class="loader"></div>
                <div id="dicom4">
                    <img class="img" ondragstart="return false;" />
                    <p class="CTWC" >45</p>
                    <p class="CTWW" >250</p>
                    <p class="PETWC" >2.5</p>
                    <p class="PETWW" >5</p>
                    <p class="plane" >Axial</p>
                    <p class="mode" >CT</p>
                    <p class="CT_window" >45,250</p>
                    <p class="ratio" style="">0</p>
                    <p class="x" >0</p>
                    <p class="y" >0</p>
                    <p class="z" >0</p>
                    <input type="text" class="SUV" value="0">
                    <p class="series" style="">4</p>
                    <p class="StudyID" style="">-9999</p>
                    <p class="StudyDes" style="">-9999</p>
                    <p class="StudyDate" style="">-9999</p>
                    <p class="Scale_rate" style="">1</p>
                    <p class="variable" style="">0/0</p>
                </div>
            </div>
            <div class='slider demoScroll sc1 s4'  onscroll="ajax4(event)" style="border: 1px #000000;margin: 0%;
        width: 14px;overflow-y:scroll" ><div  style="height:2000%" ></div></div>

         </label>
    </div>


</div>

<div  id="tumor" >
    <select id="LabelGroup" style="width: 100%;" class="form-select form-select-sm" aria-label=".form-select-sm example"><option data-id="0">輸入病灶</option></select>
    <select id="LabelName" style="width: 100%;" class="form-select form-select-sm" aria-label=".form-select-sm example"><option>輸入病灶</option></select>
    <input type="text" id="LabelRecord">
    <div style="border-radius:5px;margin-bottom: 5px;margin-left: 2px;margin-right: 2px;overflow-x: hidden;overflow-y: scroll;max-height: 100px">
    <table id="SUV_Localmax">

    </table>
    </div>
    <a class="btn btn-secondary" style="width: 110px" role="button">確認</a>

</div>

<div id="location_menu">
    <p class="btn btn-secondary deletebtn" id="delete" role="button">刪除</p>
    <p class="btn btn-secondary deletebtn" id="segmentation" role="button" onclick="UNet()">Segmentation</p>
</div>

<div id="image_menu">
    <p class="btn btn-secondary resetbtn" id="reset" role="button">Reset</p>
    <p class="btn btn-secondary resetbtn" id="enlarge" role="button">放大</p>
    <p class="btn btn-secondary resetbtn" id="shrink" role="button">縮小</p>
    
    <select onchange="Mode_menu()" id="Mode_menu"  class="form-select form-select-sm resetbtn" aria-label=".form-select-sm example" >
        <option value="Axial">Axial</option>
        <option value="Coronal">Coronal</option>
        <option value="Sagittal">Sagittal</option>
    </select>
    <select onchange="Plane_menu()" id="Plane_menu"  class="form-select form-select-sm resetbtn" aria-label=".form-select-sm example" >
        <option value="CT">CT</option>
        <option value="PET">PET</option>
        <option value="Fusion">Fusion</option>
    </select>
    <select onchange="CTWindow_menu()" id="CTWindow_menu"  class="form-select form-select-sm resetbtn" aria-label=".form-select-sm example" >
        <option value="45,250">Abdomen</option>
        <option value="255,35" >Crane</option>
        <option value="45,300">Pelvis</option>
        <option value="45,440">Mediastinum</option>
        <option value="500,4000">Bone</option>
        <option value="-500,2000">Lung</option>
    </select>
    
    

</div>

<div id="text" >
    <p id="PIDText">{{ PID }}</p>
    <p id="StudyIDText">{{ StudyID }}</p>
    <p id="MedExecTimeText">{{ MedExecTime }}</p>
    <p id="ItemText">{{ Item }}</p>
    <p id="DiseaseText">{{Disease}}</p>
    <textarea id="T1" readonly></textarea>
    <textarea id="T2" readonly></textarea>
    <textarea id="T3" readonly></textarea>
    <textarea id="T4" readonly></textarea>
</div>

</body>

</html>


{% endblock %}

