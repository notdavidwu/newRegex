

{% load static%}
{% block content %}

<!DOCTYPE html>
<html lang="zh-Hant" >
    <head>
        <meta name="viewport" maximum-scale=1.0, user-scalable=0 content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1">
    
        <!-- CSS only -->
        <link rel="stylesheet" href="{% static 'css_js/bootstrap.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/font-awesome.min.css' %}">
    
    
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap.css' %}">
    
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.rtl.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-grid.rtl.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.rtl.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-reboot.rtl.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.rtl.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/bootstrap-5.0.2-dist/css/bootstrap-utilities.rtl.min.css' %}">
        <link rel="stylesheet" href="{% static 'css_js/loaders.css-master/loaders.css' %}">
        <!-- JS, Popper.js, and jQuery -->
        <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
        <script src="{% static 'css_js/jquery-3.5.1.slim.min.js' %}"></script>
        <script src="{% static 'css_js/popper.min.js' %}"></script>
        <script src="{% static 'css_js/bootstrap.min.js' %}"></script>
        <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.bundle.js' %}"></script>
        <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.bundle.min.js' %}"></script>
        <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.js' %}"></script>
        <script src="{% static 'css_js/bootstrap-5.0.2-dist/js/bootstrap.min.js' %}"></script>
        <script src="{% static 'css_js/key_forbidden.js' %}"></script>
        <script src="{% static 'css_js/popper.min.js' %}"></script>
        <script src="{% static 'css_js/loaders.css-master/loaders.css.js' %}"></script>
        <title>PowerBI</title>
        </head>

<style>
    html { overflow: hidden; }
    #report-container{position:absolute;top:50px;left:0px;height:calc(100% - 58px);padding:0px;margin:0px}
    :root { --white: white; --gradient: linear-gradient(-45deg, #FFA600 0%, #FF5E03 50%); --form: #FFFFFF; --border-radius: 10px; --formwidth: 300px; --form-mob-width: 500px; }
    #mycheckbox { position: absolute; left: -9999px; }
    .feedback-label,.form { position: fixed; top: 50%; right: 0; }
    .feedback-label { transform-origin: top right; transform:  translate(0%, -50%); z-index: 10; }
    .form {padding:10px;height:auto;background:url("{% static 'image/texture.png' %}");border:solid 2px #44444a; width: var(--formwidth); max-height: 85vh;margin-top: 2%; transform: translate(100%, -50%); overflow: auto; background-color: var(--form); z-index: 10; border-radius:10px}
    .feedback-label { border-radius: var(--border-radius); }
    .feedback-label { padding: 5px 10px; border-radius: var(--border-radius)  0 0 var(--border-radius) ; }
    .feedback-label { writing-mode: vertical-rl;background: brown; color: white; }
    .feedback-label { -webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
    #mycheckbox:checked + .feedback-label { background: #e78632; transform:  translate(calc((var(--formwidth) ) * -1),-50%)}
    #mycheckbox:checked ~ .form { transform: translate(0, -50%);z-index: 10;}
    .feedback-label, .form { transition: all 0.35s ease-in-out; }
    .form{-webkit-user-select:none; -moz-user-select:none;   -o-user-select:none; user-select:none;}
</style>
<script type="text/javascript" src="{% static 'css_js/jquery-3.6.0.min.js' %}"></script>
<script>

$(document).ready(function (e) {
    get_dashboard()
})
$(function () {
    
});

function powerBI(){
    $("#powerbi_area").empty()
    $("#powerbi_area").append(`
        <section id="report-container"  class="embed-container" style="width:100%;">
        </section>
        <section class="error-container m-5">
        </section>
    `)


    var reportContainer = $("#report-container").get(0);

    // Initialize iframe for embedding report
    powerbi.bootstrap(reportContainer, { type: "report" });

    var models = window["powerbi-client"].models;
    var reportLoadConfig = {
        type: "report",
        tokenType: models.TokenType.Embed,

        // Enable this setting to remove gray shoulders from embedded report
        // settings: {
        //     background: models.BackgroundType.Transparent
        // }
    };
    let workspaceID = $('#dashboard_menu option:checked').attr('data-workspaceID')
    let reportID = $('#dashboard_menu option:checked').attr('data-reportID')
    $.ajax({
        type: "POST",
        url: '{% url "PowerBI:get_embed_info" %}',
        data:{
            'workspaceID':workspaceID,
            'reportID':reportID,
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        dataType: "json",
        success: function (response) {
            embedData = $.parseJSON(response.data);
            reportLoadConfig.accessToken = embedData.accessToken;
            // You can embed different reports as per your need
            reportLoadConfig.embedUrl = embedData.reportConfig[0].embedUrl;

            // Use the token expiry to regenerate Embed token for seamless end user experience
            // Refer https://aka.ms/RefreshEmbedToken
            tokenExpiry = embedData.tokenExpiry;

            // Embed Power BI report when Access token and Embed URL are available
            var report = powerbi.embed(reportContainer, reportLoadConfig);

            // Triggers when a report schema is successfully loaded
            report.on("loaded", function () {
                console.log("Report load successful")
            });

            // Triggers when a report is successfully embedded in UI
            report.on("rendered", function () {
                console.log("Report render successful")
            });

            // Clear any other error handler event
            report.off("error");

            // Below patch of code is for handling errors that occur during embedding
            report.on("error", function (event) {
                var errorMsg = event.detail;

                // Use errorMsg variable to log error in any destination of choice
                console.error(errorMsg);
                return;
            });
        },
        error: function (err) {
            Swal.fire({
                title: '',
                html: '載入失敗，請聯繫工作人員',
                icon: 'error',
                showConfirmButton: true,
            })
        }
    });
}

function get_dashboard(){
    $.ajax({
        type: 'post',
        url: '{% url "PowerBI:get_dashboard" %}', // this is the mapping between the url and view
        data:{
            'csrfmiddlewaretoken': window.CSRF_TOKEN
        },
        success:function (response){
            $('#dashboard_menu').empty()
            for(let i=0; i<response.workspaceID.length; i++){
                $('#dashboard_menu').append(`<option data-workspaceID=${response.workspaceID[i]} data-reportID=${response.reportID[i]} >${response.dashboard_name[i]}</option>`)
            }
            powerBI()
        }
    })
}

function regist_dashboard(){
    let dashboard_name = $('#dashboard_name').val()
    let dashboard_url = $('#dashboard_url').val()
    if(dashboard_url!=''|dashboard_name!=''){
        $.ajax({
            type: 'post',
            url: '{% url "PowerBI:regist_dashboard" %}', // this is the mapping between the url and view
            data:{
                'dashboard_url':dashboard_url,
                'dashboard_name':dashboard_name,
                'csrfmiddlewaretoken': window.CSRF_TOKEN
            },
            success:function (response){
                get_dashboard()
            }
        })
    }
}
</script>

<body >
    {% include 'navBar.html' %}
    {{ user.username|json_script:"user_username" }}
    {{ user.last_name|json_script:"hospital" }}
    <div id="slideout">
        <input type="checkbox" id="mycheckbox">
        <label for="mycheckbox" class="feedback-label">儀錶板選單</label>
        <form class="form sc2">
            <div class="mb-3">
                <label for="dashboard_menu" class="form-label">儀錶板</label>
                <select class="form-control" id="dashboard_menu" onchange='powerBI()'></select>
              </div>
              <div class="mb-3">
                <label for="url" class="form-label">登錄</label>
                <div class="mb-3">
                    <input type="text" class="form-control" id="dashboard_name" placeholder="儀錶板名稱" required>
                </div>
                <div class="mb-3">
                    <input type="url" class="form-control" id="dashboard_url"  placeholder="https://example.com"
                    pattern="https://.*" size="100" required>
                </div>
              </div>
              <div class="mb-3">
                <button type="button" class="form-control btn btn-primary mb-3" onclick="regist_dashboard()">完成</button>
              </div>
        </form>
    </div>
</body>
    <main class="row" id='powerbi_area'>
        <section id="report-container"  class="embed-container" style="width:100%;">
        </section>
        <!-- Used to display report embed error messages -->
        <section class="error-container m-5">
        </section>
    </main>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js" integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/powerbi-client/2.15.1/powerbi.min.js" integrity="sha512-OWIl8Xrlo8yQjWN5LcMz5SIgNnzcJqeelChqPMIeQGnEFJ4m1fWWn668AEXBrKlsuVbvDebTUJGLRCtRCCiFkg==" crossorigin="anonymous"></script>

</html>
{% endblock %}

